<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHE Auction v0.9.1 - ƒê·∫•u Gi√° B·∫£o M·∫≠t Ho√†n To√†n</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* CSS Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'VT323', monospace; background: linear-gradient(135deg, #000000 0%, #0a0a0a 100%); color: #00ff00; min-height: 100vh; padding: 20px; font-size: 18px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 40px; animation: fadeIn 1s ease-out; }
        h1 { font-size: 3em; margin-bottom: 10px; text-shadow: 0 0 10px #00ff00, 0 0 20px rgba(0, 255, 0, 0.8); }
        .subtitle { font-size: 1.2em; opacity: 0.9; color: #ffff00; }

        /* --- Layout & Card Styles --- */
        .main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 30px; }
        .card { 
            background-color: #050505; 
            border: 2px solid #00ff00; 
            padding: 25px; 
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5); 
            animation: fadeInUp 1s ease-out; 
        }
        .card h2 { margin-bottom: 20px; font-size: 1.8em; color: #ffff00; border-bottom: 1px dashed #00ff00; padding-bottom: 5px; display: flex; align-items: center; gap: 10px; }

        /* --- Form Elements --- */
        input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #00ff00; 
            background: #000; 
            color: #00ff00; 
            font-size: 1em; 
            font-family: 'VT323', monospace; 
            margin-bottom: 15px; 
            caret-color: #ffff00; 
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.2); 
        }
        button { 
            background: #000; 
            border: 2px solid #00ff00; 
            padding: 12px 20px; 
            color: #00ff00; 
            font-size: 1.1em; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 10px; 
            transition: all 0.2s ease; 
            font-family: 'VT323', monospace; 
            letter-spacing: 1px; 
            text-transform: uppercase; 
        }
        button:hover { background: #00ff00; color: #000000; box-shadow: 0 0 15px #00ff00; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }

        /* --- Info & Status --- */
        .auction-info { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        .info-item { background: #0a0a0a; padding: 15px; border: 1px solid #00ff00; text-align: center; }
        .info-label { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; color: #ffff00; }
        .info-value { font-size: 1.5em; font-weight: bold; color: #00ff00; }
        .log-line { opacity: 1; padding: 2px 0; }
        .log-time { color: #ffff00; margin-right: 10px; }
        .log-pending { color: orange; }
        .log-confirmed { color: #00ff00; }
        .log-failed { color: #ff0000; }
        .fhe-badge { background: #00ff00; color: #000; padding: 3px 8px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; margin-left: 10px; border: 1px solid #00ff00; box-shadow: 0 0 5px #00ff00; }
        .encrypted-badge { display: flex; align-items: center; gap: 10px; background: #111; padding: 10px; border: 1px solid #00ff00; margin-top: 10px; margin-bottom: 15px; }
        .encrypted-badge::before { content: "üîí"; font-size: 1.2em; filter: drop-shadow(0 0 3px #00ff00); }
        .tx-container { height: 350px; background: #0a0a0a; border: 1px solid #00ff00; overflow-y: auto; padding: 10px; line-height: 1.4; white-space: pre-wrap; }
        
        /* Owner Section Styles */
        .owner-section { grid-column: 1 / -1; }
        .owner-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .owner-controls button { margin-top: 0; }
        .pause-btn { background: #ff0000; border-color: #ff0000; color: #fff; }
        .unpause-btn { background: #008000; border-color: #008000; color: #fff; }
        .finalize-btn { background: #0000ff; border-color: #0000ff; color: #fff; }
        .refund-btn { background: #ffa500; border-color: #ffa500; color: #000; }

        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr; }
            .owner-controls { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><span style="color: #00ff00;">[SYSTEM ONLINE]</span> FHE AUCTION v0.9.1 $</h1>
            <p class="subtitle">Fully Homomorphic Encryption (FHE) Secure Auction - Sepolia FHEVM</p>
        </header>

        <div class="main-grid">
            <div class="card auction-status-card">
                <h2>üìä AUCTION DATA FEED</h2>
                <div class="auction-info">
                    <div class="info-item">
                        <div class="info-label">Current Bid</div>
                        <div class="info-value" id="currentBid">CIPHERTEXT</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Lead Bidder</div>
                        <div class="info-value" id="leadBidder">0x0000...</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Min Bid Deposit</div>
                        <div class="info-value" id="minDepositValue">-- ETH</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Time Remaining</div>
                        <div class="info-value" id="timeLeft">--:--:--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Current Round</div>
                        <div class="info-value" id="currentRound">#0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Status</div>
                        <div class="info-value" id="auctionStatus">Loading...</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <label class="log-line log-confirmed">Your Held Deposit:</label>
                    <div class="info-value" id="userDeposit">0.00 ETH</div>
                </div>
            </div>

            <div class="card wallet-section">
                <h2>üîå INIT WALLET & FHE SDK</h2>
                <div class="wallet-status" id="walletStatus">
                    <p class="log-line log-info">[STATUS] Wallet: DISCONNECTED</p>
                    <p class="log-line log-info">[NETWORK] Target: **Sepolia (11155111)**</p>
                    <p class="log-line log-pending" id="fheStatus">[FHE SDK] Initializing FHE WASM files...</p>
                </div>
                <button id="connectBtn">
                    &gt; CONNECT & INIT FHE SDK
                </button>
            </div>

            <div class="card">
                <h2>üí∞ SUBMIT ENCRYPTED BID <span class="fhe-badge">FHE</span></h2>
                <label for="bidAmount" class="log-line">[INPUT] Bid Amount (ETH):</label>
                <input 
                    type="number" 
                    id="bidAmount" 
                    placeholder="Amount in ETH (max ~18.44)" 
                    step="0.000000001"
                    min="0"
                >
                <label for="depositAmount" class="log-line">[INPUT] Deposit Amount (ETH):</label>
                <input 
                    type="number" 
                    id="depositAmount" 
                    placeholder="ETH to send (‚â• min deposit)" 
                    step="0.001"
                    min="0"
                >
                <div class="encrypted-badge">
                    <span>Bid is encrypted using euint64 (Gwei) via @zama-fhe/relayer-sdk.</span>
                </div>
                <button id="bidBtn" disabled>
                    &gt; ENCRYPT BID & SUBMIT
                </button>
                <button id="claimRefundBtn" class="refund-btn" disabled style="margin-top: 5px;">
                    &gt; CLAIM REFUND
                </button>
            </div>
            
            <div class="card owner-section">
                <h2>‚öôÔ∏è OWNER/ADMIN CONTROLS <span class="fhe-badge" id="ownerBadge" style="display: none;">OWNER</span></h2>
                <div class="owner-controls">
                    <button id="requestFinalizeBtn" class="finalize-btn" disabled>
                        &gt; REQUEST FINALIZE
                    </button>
                    <button id="pauseBtn" class="pause-btn" disabled>
                        &gt; PAUSE AUCTION
                    </button>
                    <button id="unpauseBtn" class="unpause-btn" disabled>
                        &gt; UNPAUSE AUCTION
                    </button>
                    <button id="emergencyEndBtn" class="pause-btn" disabled>
                        &gt; EMERGENCY END
                    </button>
                    <button id="batchRefundBtn" class="refund-btn" disabled>
                        &gt; BATCH REFUND ALL
                    </button>
                </div>
                <div style="margin-top: 20px;">
                    <label for="beneficiaryInput" class="log-line">[INPUT] New Beneficiary Address:</label>
                    <input 
                        type="text" 
                        id="beneficiaryInput" 
                        placeholder="0x..." 
                    >
                    <button id="updateBeneficiaryBtn" disabled>
                        &gt; UPDATE BENEFICIARY
                    </button>
                </div>
            </div>

            <div class="card" style="grid-column: 1 / -1;">
                <h2>üìú LIVE TRANSACTION LOG</h2>
                <div class="tx-container" id="txContainer">
                    <p class="log-line log-confirmed"><span class="log-time">[00:00:00]</span> [INIT] FHE Auction v0.9.1 interface loaded</p>
                    <p class="log-line log-info"><span class="log-time">[00:00:01]</span> [INFO] Contract: <span id="contractAddressDisplay"></span></p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <script type="module">
        import { initSDK, createInstance, SepoliaConfig } from 'https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js'; 

        // ========== CONFIGURATION ==========
        // CONTRACT ADDRESS C·ª¶A B·∫†N TR√äN SEPOLIA FHEVM (S·ª≠ d·ª•ng ƒë·ªãa ch·ªâ t·ª´ prompt)
        const CONTRACT_ADDRESS = '0xf1314dff22d14ae4a00e0ea0e05027c1abf985a5';
        const SEPOLIA_CHAIN_ID = 11155111;
        const SEPOLIA_RPC = 'https://eth-sepolia.public.blastapi.io';
        const RELAYER_URL = 'https://relayer.testnet.zama.cloud';
        
        // Gi√° tr·ªã t·ªëi ƒëa c·ªßa euint64 (2^64 - 1), d√πng ƒë·ªÉ ki·ªÉm tra gi·ªõi h·∫°n Gwei.
        const MAX_EUINT64_GWEI = BigInt('18446744073709551615'); 
        
        // C·∫•u h√¨nh EIP712
        const EIP712_DOMAIN_NAME = "FHEAuction";
        const EIP712_DOMAIN_VERSION = "1";
        
        // State variables
        let provider, signer, account;
        let fheAuctionContract;
        let fhevmInstance = null; 
        let timerInterval; 
        let minDepositWei; 
        let auctionEndTime = 0; 
        let contractOwner = null; 
        
        document.getElementById('contractAddressDisplay').textContent = CONTRACT_ADDRESS;

        // ABI H·ª¢P ƒê·ªíNG FHE AUCTION (ƒê√£ ƒë∆∞·ª£c ƒë∆°n gi·∫£n h√≥a cho ƒë·ªô d√†i)
        const FHE_AUCTION_ABI = [{"inputs":[{"internalType":"uint256","name":"_minDeposit","type":"uint256"},
            {"internalType":"address","name":"_pauserSet","type":"address"},
            {"internalType":"address","name":"_beneficiary","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
            {"inputs":[],"name":"ECDSAInvalidSignature","type":"error"},
            {"inputs":[],"name":"HandlesAlreadySavedForRequestID","type":"error"},
            {"inputs":[],"name":"InvalidKMSSignatures","type":"error"},
            {"inputs":[],"name":"InvalidShortString","type":"error"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"round","type":"uint256"},
            {"indexed":false,"internalType":"address","name":"winner","type":"address"},
            {"indexed":false,"internalType":"uint256","name":"finalBid","type":"uint256"}],"name":"AuctionFinished","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"bidder","type":"address"},
            {"indexed":true,"internalType":"uint256","name":"round","type":"uint256"},
            {"indexed":false,"internalType":"uint256","name":"depositAmount","type":"uint256"}],"name":"BidReceived","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"requestID","type":"uint256"}],"name":"DecryptionFulfilled","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"requestId","type":"uint256"}],"name":"DecryptionRequested","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"recipient","type":"address"},
            {"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RefundIssued","type":"event"},
            {"inputs":[{"internalType":"externalEuint64","name":"encryptedBid","type":"bytes32"},
            {"internalType":"bytes","name":"proof","type":"bytes"},
            {"internalType":"bytes32","name":"publicKey","type":"bytes32"},
            {"internalType":"bytes","name":"signature","type":"bytes"}],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[{"internalType":"address[]","name":"recipients","type":"address[]"}],"name":"claimBatchRefund","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"claimRefund","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"deposits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"emergencyEnd","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"getMinBidDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"pauseAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"requestFinalize","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"newBeneficiary","type":"address"}],"name":"setBeneficiary","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"unpauseAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"isAuctionFinalized","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getAuctionEndTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getCurrentLeadBidder","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getCurrentLeadDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"currentRound","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getWinningBid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"requestId","type":"uint256"},{"internalType":"bytes","name":"cleartexts","type":"bytes"},
            {"internalType":"bytes","name":"decryptionProof","type":"bytes"}],"name":"onDecryptionCallback","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        // --- UTILITY FUNCTIONS ---
        function formatLogTime() {
            const date = new Date();
            return `[${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}]`;
        }
        
        function logMessage(message, type = 'info') {
            const container = document.getElementById('txContainer');
            const logElement = document.createElement('p');
            logElement.className = `log-line log-${type}`;
            logElement.innerHTML = `<span class="log-time">${formatLogTime()}</span> ${message}`;
            container.prepend(logElement);
            if (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        function showNotification(message, type) {
            // ... (Notification logic - gi·ªØ nguy√™n) ...
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = `[${type.toUpperCase()}] ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => { notification.remove(); }, 4000);
        }

        function updateButtonStates(isPaused, isFinalized, isOwner) {
            const isAuctionRunning = auctionEndTime > Date.now() && !isPaused && !isFinalized;
            
            document.getElementById('bidBtn').disabled = !fhevmInstance || !account || !isAuctionRunning;
            document.getElementById('claimRefundBtn').disabled = !account || (document.getElementById('userDeposit').textContent === '0.00 ETH');
            
            // Owner Controls
            document.getElementById('ownerBadge').style.display = isOwner ? 'inline' : 'none';
            document.getElementById('requestFinalizeBtn').disabled = !isOwner || isFinalized || isPaused || (auctionEndTime > Date.now());
            document.getElementById('pauseBtn').disabled = !isOwner || isPaused || isFinalized;
            document.getElementById('unpauseBtn').disabled = !isOwner || !isPaused || isFinalized;
            document.getElementById('emergencyEndBtn').disabled = !isOwner || isFinalized;
            document.getElementById('updateBeneficiaryBtn').disabled = !isOwner;
            document.getElementById('batchRefundBtn').disabled = !isOwner;

            if (isPaused) {
                document.getElementById('auctionStatus').textContent = 'PAUSED';
                document.getElementById('auctionStatus').style.color = 'orange';
            } else if (isFinalized) {
                document.getElementById('auctionStatus').textContent = 'FINALIZED';
                document.getElementById('auctionStatus').style.color = '#ffff00';
            } else if (isAuctionRunning) {
                document.getElementById('auctionStatus').textContent = 'RUNNING';
                document.getElementById('auctionStatus').style.color = '#00ff00';
            } else {
                document.getElementById('auctionStatus').textContent = 'ENDED';
                document.getElementById('auctionStatus').style.color = '#ff0000';
            }
        }
        
        // --- TIMER LOGIC ---
        function startAuctionTimer(endTime, isFinalized) {
            if (timerInterval) clearInterval(timerInterval);
            const timerElement = document.getElementById('timeLeft');

            if (isFinalized) {
                timerElement.textContent = 'AUCTION FINALIZED';
                return;
            }

            timerInterval = setInterval(async () => {
                const now = Date.now();
                const remaining = endTime * 1000 - now;

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    timerElement.textContent = 'AUCTION CLOSED!';
                    logMessage('[TIMER] Auction end time reached. Finalization can proceed.', 'info');
                    await loadAuctionState();
                } else {
                    const totalSeconds = Math.floor(remaining / 1000);
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = totalSeconds % 60;

                    timerElement.textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        // --- FHE SDK INITIALIZATION ---

        async function initFhevmSdk() {
            const fheStatus = document.getElementById('fheStatus');
            try {
                fheStatus.textContent = '[FHE SDK] Initializing WASM (initSDK)...';
                await initSDK(); 
                fheStatus.textContent = '[FHE SDK] Creating FHE instance...';

                // C·∫•u h√¨nh FHE instance (s·ª≠ d·ª•ng c·∫•u h√¨nh th·ªß c√¥ng cho Sepolia FHEVM)
                const manualConfig = {
                    aclContractAddress: '0x687820221192C5B662b25367F70076A37bc79b6c',
                    kmsContractAddress: '0x1364cBBf2DF5032C47d8226a6f6FBD2AFCDacAC',
                    inputVerifierContractAddress: '0xbc91f3daD1A5F19F8390c400196e58073B6a0BC4',
                    verifyingContractAddressDecryption: '0xb6E160B1ff80D67Bfe90A85eE06Ce0A2613607D1',
                    verifyingContractAddressInputVerification: '0x7048C39f048125eDa9d678AEbaDfB22F7900a29F',
                    chainId: SEPOLIA_CHAIN_ID,
                    gatewayChainId: 55815,
                    network: SEPOLIA_RPC,
                    relayerUrl: RELAYER_URL,
                };
                fhevmInstance = await createInstance(manualConfig);
                
                fheStatus.textContent = '[FHE SDK] Public Key loaded. Ready for encryption.';
                fheStatus.className = 'log-line log-confirmed';
                logMessage('[FHE] SDK initialized successfully. Client-side encryption enabled.', 'confirmed');
            } catch (error) {
                console.error("FHE SDK Initialization failed:", error);
                fheStatus.textContent = '[FHE SDK] FAILED. Cannot encrypt bids.';
                fheStatus.className = 'log-line log-failed';
                throw new Error("FHE SDK failed to initialize.");
            }
        }
        
        // --- DATA LOADERS ---
        async function loadUserInfo() {
             if (!fheAuctionContract || !account) return;

             const userDepositWei = await fheAuctionContract.deposits(account);
             const userDepositEth = ethers.utils.formatEther(userDepositWei);
             document.getElementById('userDeposit').textContent = `${userDepositEth} ETH`;
        }

        async function loadAuctionState() {
            try {
                if (!fheAuctionContract) return;

                const [minDeposit, endTime, leadBidder, finalized, paused, owner, currentRound, winningBidValue] = await Promise.all([
                    fheAuctionContract.getMinBidDeposit(),
                    fheAuctionContract.getAuctionEndTime(),
                    fheAuctionContract.getCurrentLeadBidder(),
                    fheAuctionContract.isAuctionFinalized(),
                    fheAuctionContract.paused(),
                    fheAuctionContract.owner(),
                    fheAuctionContract.currentRound(),
                    fheAuctionContract.getWinningBid(),
                ]);
                
                contractOwner = owner; 
                minDepositWei = minDeposit; 
                auctionEndTime = endTime.toNumber();
                
                // Update UI elements
                const minDepositEth = ethers.utils.formatEther(minDeposit);
                document.getElementById('minDepositValue').textContent = `${minDepositEth} ETH`;
                document.getElementById('leadBidder').textContent = leadBidder === ethers.constants.AddressZero ? '0x0000...' : `${leadBidder.substring(0, 6)}...`;
                document.getElementById('currentRound').textContent = `#${currentRound.toString()}`;
                
                if (finalized) {
                    const winningBidEth = ethers.utils.formatEther(winningBidValue);
                    document.getElementById('currentBid').textContent = `${winningBidEth} ETH`;
                } else {
                    document.getElementById('currentBid').textContent = 'CIPHERTEXT';
                }

                if (account) {
                    await loadUserInfo();
                    const isOwner = account.toLowerCase() === contractOwner.toLowerCase();
                    updateButtonStates(paused, finalized, isOwner);
                } else {
                     updateButtonStates(paused, finalized, false);
                }
                
                startAuctionTimer(auctionEndTime, finalized);
            } catch (error) {
                console.error("Failed to fetch auction state:", error);
                logMessage(`[ERROR] Failed to fetch auction state: ${error.message}`, 'failed');
            }
        }
        
        // --- EVENT LISTENERS ---
        function listenToEvents() {
            if (!fheAuctionContract) return;
            fheAuctionContract.removeAllListeners();
            
            fheAuctionContract.on("BidReceived", async (bidder, round, depositAmount) => {
                logMessage(`[BID:RECEIVED] Round ${round}: ${bidder.substring(0, 6)}... Deposit: ${ethers.utils.formatEther(depositAmount)} ETH`, 'info');
                await loadAuctionState();
            });

            fheAuctionContract.on("AuctionFinished", async (round, winner, finalBid) => {
                logMessage(`[SUCCESS] AUCTION FINALIZED! Winner: ${winner.substring(0, 8)}... with ${ethers.utils.formatEther(finalBid)} ETH.`, 'confirmed');
                await loadAuctionState();
            });

            fheAuctionContract.on("RefundIssued", async (recipient, amount) => {
                logMessage(`[EVENT] Refund claimed by ${recipient.substring(0, 8)}...: ${ethers.utils.formatEther(amount)} ETH`, 'confirmed');
                if (recipient.toLowerCase() === account.toLowerCase()) {
                    await loadUserInfo();
                }
            });

            fheAuctionContract.on("DecryptionRequested", (requestId) => {
                logMessage(`[DECRYPT] Decryption requested (ID: ${requestId}). Awaiting callback from KMS/Oracle...`, 'pending');
            });

            fheAuctionContract.on("RoundStarted", async () => {
                logMessage(`[NEW ROUND] New auction round started.`, 'confirmed');
                await loadAuctionState();
            });

            logMessage('[EVENT] Event listeners registered.', 'info');
        }

        // --- WALLET & CONNECTION ---
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showNotification('ERROR: MetaMask not detected.', 'error');
                return;
            }

            try {
                // Y√™u c·∫ßu k·∫øt n·ªëi v√≠ v√† chuy·ªÉn m·∫°ng
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: `0x${SEPOLIA_CHAIN_ID.toString(16)}` }],
                });

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                account = await signer.getAddress();
                
                await initFhevmSdk(); // B∆Ø·ªöC 1: Kh·ªüi t·∫°o FHE SDK

                fheAuctionContract = new ethers.Contract(CONTRACT_ADDRESS, FHE_AUCTION_ABI, signer);
                
                await loadAuctionState();
                listenToEvents();

                document.getElementById('walletStatus').innerHTML = `
                    <p class="log-line log-confirmed">[STATUS] Wallet: CONNECTED & READY</p>
                    <p class="log-line">[ADDRESS] ${account.substring(0, 10)}... ${account.toLowerCase() === contractOwner.toLowerCase() ? '(OWNER)' : ''}</p>
                    <p class="log-line">[NETWORK] **Sepolia FHEVM**</p>
                `;
                document.getElementById('connectBtn').textContent = '> CONNECTION ESTABLISHED';
                document.getElementById('connectBtn').disabled = true;
                showNotification('Connected to Sepolia. FHE interface ready.', 'success');

                window.ethereum.on('accountsChanged', () => { window.location.reload(); });
                window.ethereum.on('chainChanged', () => { window.location.reload(); });

            } catch (error) {
                console.error(error);
                const msg = error.message.includes('User rejected') ? 'User rejected connection/switch.' : error.message;
                showNotification('Connection Failed: ' + msg, 'error');
                document.getElementById('bidBtn').disabled = true;
            }
        }
        
        // --- CORE BIDDING LOGIC (ƒê√É S·ª¨A CH·ªÆA) ---
        async function placeBid() {
            const bidAmountETH = parseFloat(document.getElementById('bidAmount').value); // L·∫•y gi√° tr·ªã ETH
            const depositAmountETH = parseFloat(document.getElementById('depositAmount').value);
            
            if (isNaN(bidAmountETH) || bidAmountETH <= 0) {
                showNotification('Invalid bid amount (ETH)', 'error');
                return;
            }
            
            if (isNaN(depositAmountETH) || depositAmountETH <= 0) {
                showNotification('Invalid deposit amount (ETH)', 'error');
                return;
            }

            const btn = document.getElementById('bidBtn');
            const depositAmountWei = ethers.utils.parseEther(depositAmountETH.toString());
            
            // 1. Ki·ªÉm tra Deposit t·ªëi thi·ªÉu (Wei)
            if (depositAmountWei.lt(minDepositWei)) {
                showNotification(`Deposit must be at least ${ethers.utils.formatEther(minDepositWei)} ETH.`, 'error');
                return;
            }

            try {
                btn.innerHTML = '<span class="loading"></span> ENCRYPTING...';
                btn.disabled = true;
                
                // === LOGIC CHUY·ªÇN ƒê·ªîI ETH -> GWEI V√Ä KI·ªÇM TRA GI·ªöI H·∫†N ===
                
                // Chuy·ªÉn ƒë·ªïi ETH sang Gwei (ETH * 10^9)
                const bidAmountGwei = BigInt(Math.round(bidAmountETH * 1e9)); 
                
                // Ki·ªÉm tra gi·ªõi h·∫°n euint64
                if (bidAmountGwei > MAX_EUINT64_GWEI) {
                    showNotification('Bid amount too high (Max ~18.44 ETH)', 'error');
                    btn.innerHTML = '> ENCRYPT BID & SUBMIT';
                    btn.disabled = false;
                    return;
                }
                
                logMessage(`[BID] Encrypting ${bidAmountGwei.toString()} Gwei (from ${bidAmountETH} ETH) with FHE SDK...`, 'info');
                
                // === LOGIC M√É H√ìA FHE V√Ä G·ª¨I TX ===
                
                // 2. L·∫•y Public Key v√† K√Ω EIP712
                const { publicKey, signature } = await fhevmInstance.signPublicKey(signer, EIP712_DOMAIN_NAME, EIP712_DOMAIN_VERSION);
                const publicKeyBytes32 = ethers.utils.hexlify(publicKey);
                
                // 3. M√£ h√≥a gi√° th·∫ßu v√† t·∫°o Proof
                const input = fhevmInstance.createEncryptedInput(CONTRACT_ADDRESS, account);
                input.add64(bidAmountGwei); 

                logMessage('[FHE] Generating ZK proof...', 'pending');
                const encryptedData = await input.encrypt();
                const encryptedHandle = encryptedData.handles[0];
                const proofBytes = encryptedData.inputProof;
                
                logMessage(`[TX] Sending encrypted bid... Hash: PENDING`, 'pending');
                
                // 4. G·ªçi h√†m bid() tr√™n h·ª£p ƒë·ªìng
                const tx = await fheAuctionContract.bid(
                    encryptedHandle, 
                    proofBytes, 
                    publicKeyBytes32, 
                    signature,
                    { value: depositAmountWei } // G·ª≠i ETH deposit
                ); 
                
                logMessage(`[TX] Sent. Waiting confirmation for Hash: ${tx.hash.substring(0, 10)}...`, 'pending');

                await tx.wait(); 
                
                logMessage(`[SUCCESS] TX confirmed. Bid submitted.`, 'confirmed');
                showNotification('Encrypted Bid Confirmed!', 'success');
                document.getElementById('bidAmount').value = '';
                document.getElementById('depositAmount').value = '';

            } catch (error) {
                console.error("Bid Failed:", error);
                const msg = error.reason || error.message || 'Transaction Failed';
                showNotification(`TX FAILED: ${msg}`, 'error');
                logMessage(`[FATAL] Transaction failed: ${msg}`, 'failed');
            } finally {
                await loadAuctionState();
            }
        }

        // --- OWNER FUNCTIONS ---
        async function handleOwnerTx(funcName, args = [], value = 0) {
            if (account.toLowerCase() !== contractOwner.toLowerCase()) {
                showNotification('Only Owner can perform this action.', 'error');
                return;
            }
            try {
                logMessage(`[OWNER] Calling ${funcName} with arguments: ${JSON.stringify(args)}`, 'pending');
                const tx = await fheAuctionContract[funcName](...args, { value });
                logMessage(`[TX:OWNER] Sent ${funcName}. Waiting for confirmation...`, 'pending');
                await tx.wait();
                logMessage(`[SUCCESS] ${funcName} confirmed.`, 'confirmed');
                showNotification(`${funcName} successful.`, 'success');
            } catch (error) {
                const msg = error.reason || error.message || 'Owner action failed';
                logMessage(`[ERROR] ${funcName} failed: ${msg}`, 'failed');
                showNotification(`Owner action failed: ${msg}`, 'error');
            } finally {
                await loadAuctionState();
            }
        }

        const requestFinalize = () => handleOwnerTx('requestFinalize');
        const pauseAuction = () => handleOwnerTx('pauseAuction');
        const unpauseAuction = () => handleOwnerTx('unpauseAuction');
        const emergencyEnd = () => handleOwnerTx('emergencyEnd');
        const claimRefund = () => handleOwnerTx('claimRefund');
        const updateBeneficiary = () => {
             const newBeneficiary = document.getElementById('beneficiaryInput').value;
             if (!ethers.utils.isAddress(newBeneficiary)) {
                 showNotification('Invalid Ethereum address for beneficiary.', 'error');
                 return;
             }
             handleOwnerTx('setBeneficiary', [newBeneficiary]);
        };
        const batchClaimRefunds = () => {
             // C·∫ßn danh s√°ch ƒë·ªãa ch·ªâ ng∆∞·ªùi d√πng
             const recipients = []; 
             if (recipients.length === 0) {
                showNotification('Need list of recipients for batch refund.', 'info');
                return;
             }
             handleOwnerTx('claimBatchRefund', [recipients]);
        };
        
        // ========== SETUP UI HANDLERS ==========
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('connectBtn').addEventListener('click', connectWallet);
            document.getElementById('bidBtn').addEventListener('click', placeBid);
            document.getElementById('claimRefundBtn').addEventListener('click', claimRefund);
            document.getElementById('requestFinalizeBtn').addEventListener('click', requestFinalize);
            document.getElementById('pauseBtn').addEventListener('click', pauseAuction);
            document.getElementById('unpauseBtn').addEventListener('click', unpauseAuction);
            document.getElementById('emergencyEndBtn').addEventListener('click', emergencyEnd);
            document.getElementById('updateBeneficiaryBtn').addEventListener('click', updateBeneficiary);
            document.getElementById('batchRefundBtn').addEventListener('click', batchClaimRefunds);
        });
        
    </script>
</body>
</html>
