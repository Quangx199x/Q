<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Stacking Base Sepolia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .security-badge {
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            display: inline-block;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(0,255,136,0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 4px 15px rgba(0,255,136,0.3); }
            50% { box-shadow: 0 4px 25px rgba(0,255,136,0.6); }
            100% { box-shadow: 0 4px 15px rgba(0,255,136,0.3); }
        }

        .info-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .fhe-panel {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid #00ff88;
            box-shadow: 0 8px 32px rgba(0,255,136,0.2);
        }

        .encryption-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,255,136,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #00ff88;
        }

        .key-display {
            font-family: 'Courier New', monospace;
            background: #0f0f23;
            color: #00ff88;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            overflow-x: auto;
            border: 1px solid #00ff88;
        }

        .formats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .format-card {
            background: linear-gradient(145deg, #f0f4f8, #d6e8f5);
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid #4a90e2;
            transition: transform 0.3s ease;
        }

        .format-card:hover {
            transform: translateY(-5px);
        }

        .simulator {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            color: #e74c3c;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .encrypted-timer {
            font-size: 1.2rem;
            color: #666;
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #ddd;
        }

        .pyramid-area {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin: 30px 0;
            height: 200px;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .pyramid {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 20px;
            transition: all 0.5s ease;
        }

        .cup-row {
            display: flex;
            margin-bottom: 5px;
        }

        .cup {
            width: 25px;
            height: 30px;
            background: linear-gradient(145deg, #ff6b6b, #ee5a52);
            border-radius: 0 0 12px 12px;
            margin: 0 2px;
            border: 2px solid #c44444;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .cup:hover {
            transform: scale(1.1);
        }

        .cup.stacked {
            background: linear-gradient(145deg, #28a745, #20c997);
            border-color: #1e7e34;
        }

        .cup::before {
            content: '';
            position: absolute;
            top: -2px;
            left: 2px;
            right: 2px;
            height: 4px;
            background: #ffcccb;
            border-radius: 10px;
        }

        .cup.stacked::before {
            background: #a8e6cf;
        }

        .controls {
            margin: 30px 0;
        }

        .btn {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn.stop {
            background: linear-gradient(145deg, #f44336, #da190b);
        }

        .btn.reset {
            background: linear-gradient(145deg, #ff9800, #f57c00);
        }

        .btn.encrypt {
            background: linear-gradient(145deg, #6f42c1, #5a2d91);
        }

        .status {
            margin: 20px 0;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .status.ready { color: #28a745; }
        .status.stacking { color: #ffc107; }
        .status.finished { color: #dc3545; }
        .status.encrypted { color: #6f42c1; }

        .leaderboard {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .encrypted-score {
            font-family: 'Courier New', monospace;
            color: #00ff88;
            font-size: 0.9rem;
        }

        .privacy-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .privacy-card {
            background: linear-gradient(145deg, #e8f5e8, #d4edda);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #00ff88;
            transition: transform 0.3s ease;
        }

        .privacy-card:hover {
            transform: translateY(-3px);
        }

        .tech-specs {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #17a2b8;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .blockchain-panel {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border: 2px solid #4a90e2;
            box-shadow: 0 8px 32px rgba(74, 144, 226, 0.3);
        }

        .wallet-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #4a90e2;
            background: rgba(74, 144, 226, 0.2);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .btn.blockchain {
            background: linear-gradient(145deg, #4a90e2, #357abd);
        }

        .btn.metamask {
            background: linear-gradient(145deg, #f6851b, #e2761b);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .transaction-hash {
            font-family: 'Courier New', monospace;
            color: #4a90e2;
            font-size: 0.8rem;
            word-break: break-all;
            background: rgba(74, 144, 226, 0.1);
            padding: 8px;
            border-radius: 5px;
            margin: 5px 0;
        }

        .history-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .match-history {
            max-height: 400px;
            overflow-y: auto;
        }

        .match-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border-left: 4px solid #28a745;
            transition: transform 0.2s ease;
        }

        .match-entry:hover {
            transform: translateX(5px);
        }

        .match-info {
            flex-grow: 1;
        }

        .match-time {
            font-weight: bold;
            color: #e74c3c;
            font-size: 1.1rem;
        }

        .match-date {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .match-tx {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .blockchain-badge {
            background: linear-gradient(45deg, #4a90e2, #357abd);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .gas-fee {
            color: #6c757d;
            font-size: 0.8rem;
        }

        .network-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: #dc3545;
        }

        .status-dot.pending {
            background: #ffc107;
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js" defer></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ SPORT STACKING</h1>
            <div class="security-badge">üîê FHE Protected</div>
            <p>Th·ªÉ thao x·∫øp ly v·ªõi b·∫£o m·∫≠t Fully Homomorphic Encryption</p>
        </div>

        <div class="blockchain-panel">
            <h2>‚õìÔ∏è Blockchain Integration</h2>
            <div class="network-status">
                <div class="status-dot" id="networkDot"></div>
                <span id="networkStatus">ƒêang k·∫øt n·ªëi...</span>
            </div>
            <div class="wallet-status">
                <div>
                    <strong>Wallet:</strong> <span id="walletStatus">Ch∆∞a k·∫øt n·ªëi</span><br>
                    <span class="wallet-address" id="walletAddress">---</span>
                </div>
                <button class="btn metamask" onclick="connectWallet()">
                    ü¶ä K·∫øt n·ªëi MetaMask
                </button>
            </div>
            <div style="margin-top: 15px;">
                <strong>Smart Contract:</strong> 
                <span class="wallet-address">0x742d35Cc6635C0532925a3b8</span>
            </div>
            <div style="margin-top: 10px;">
                <strong>Network:</strong> Polygon Mumbai Testnet
            </div>
        </div>

        <div class="fhe-panel">
            <h2>üîê H·ªá th·ªëng b·∫£o m·∫≠t FHE</h2>
            <div class="encryption-status">
                <div>
                    <strong>Tr·∫°ng th√°i m√£ h√≥a:</strong> <span id="encryptionStatus">ƒêang kh·ªüi t·∫°o...</span>
                </div>
                <div class="loading" id="encryptionLoader"></div>
            </div>
            <div>
                <strong>Public Key (RSA-2048):</strong>
                <div class="key-display" id="publicKey">ƒêang t·∫°o kh√≥a...</div>
            </div>
            <div style="margin-top: 15px;">
                <strong>Session ID:</strong> 
                <span class="key-display" style="display: inline-block; padding: 5px 10px;" id="sessionId">ƒêang t·∫°o...</span>
            </div>
        </div>

        <div class="info-section">
            <h2>üéØ Sport Stacking v·ªõi FHE l√† g√¨?</h2>
            <p>ƒê√¢y l√† phi√™n b·∫£n n√¢ng cao c·ªßa Sport Stacking s·ª≠ d·ª•ng c√¥ng ngh·ªá <strong>Fully Homomorphic Encryption (FHE)</strong> ƒë·ªÉ b·∫£o v·ªá ho√†n to√†n d·ªØ li·ªáu ng∆∞·ªùi ch∆°i. M·ªçi th√¥ng tin v·ªÅ th·ªùi gian, ƒëi·ªÉm s·ªë v√† th·ª© h·∫°ng ƒë·ªÅu ƒë∆∞·ª£c m√£ h√≥a end-to-end, ƒë·∫£m b·∫£o quy·ªÅn ri√™ng t∆∞ tuy·ªát ƒë·ªëi.</p>
        </div>

        <div class="simulator">
            <h2>üéÆ M√¥ ph·ªèng Sport Stacking (3-6-3 Formation)</h2>
            <div class="timer-display" id="timer">00:00:00</div>
            <div class="encrypted-timer">
                üîê M√£ h√≥a: <span id="encryptedTimer">---</span>
            </div>
            <div class="status ready" id="status">S·∫µn s√†ng b·∫Øt ƒë·∫ßu!</div>
            
            <div class="pyramid-area" id="pyramidArea">
                <div class="pyramid" id="pyramid1">
                    <div class="cup-row">
                        <div class="cup" data-pyramid="1" data-level="2"></div>
                    </div>
                    <div class="cup-row">
                        <div class="cup" data-pyramid="1" data-level="1"></div>
                        <div class="cup" data-pyramid="1" data-level="1"></div>
                    </div>
                    <div class="cup-row">
                        <div class="cup" data-pyramid="1" data-level="0"></div>
                        <div class="cup" data-pyramid="1" data-level="0"></div>
                        <div class="cup" data-pyramid="1" data-level="0"></div>
                    </div>
                </div>

                <div class="pyramid" id="pyramid2">
                    <div class="cup-row">
                        <div class="cup" data-pyramid="2" data-level="5"></div>
                    </div>
                    <div class="cup-row">
                        <div class="cup" data-pyramid="2" data-level="4"></div>
                        <div class="cup" data-pyramid="2" data-level="4"></div>
                    </div>
                    <div class="cup-row">
                        <div class="cup" data-pyramid="2" data-level="3"></div>
                        <div class="cup" data-pyramid="2" data-level="3"></div>
                        <div class="cup" data-pyramid="2" data-level="3"></div>
                    </div>
                    <div class="cup-row">
                        <div class="cup" data-pyramid="2" data-level="2"></div>
                        <div class="cup" data-pyramid="2" data-level="2"></div>
                        <div class="cup" data-pyramid="2" data-level="2"></div>
                        <div class="cup" data-pyramid="2" data-level="2"></div>
                    </div>
                    <div class="cup-row">
                        <div class="cup" data-pyramid="2" data-level="1"></div>
                        <div class="cup" data-pyramid="2" data-level="1"></div>
                        <div class="cup" data-pyramid="2" data-level="1"></div>
                        <div class="cup" data-pyramid="2" data-level="1"></div>
                        <div class="cup" data-pyramid="2" data-level="1"></div>
                    </div>
                    <div class="cup-row">
                        <div class="cup" data-pyramid="2" data-level="0"></div>
                        <div class="cup" data-pyramid="2" data-level="0"></div>
                        <div class="cup" data-pyramid="2" data-level="0"></div>
                        <div class="cup" data-pyramid="2" data-level="0"></div>
                        <div class="cup" data-pyramid="2" data-level="0"></div>
                        <div class="cup" data-pyramid="2" data-level="0"></div>
                    </div>
                </div>

                <div class="pyramid" id="pyramid3">
                    <div class="cup-row">
                        <div class="cup" data-pyramid="3" data-level="2"></div>
                    </div>
                    <div class="cup-row">
                        <div class="cup" data-pyramid="3" data-level="1"></div>
                        <div class="cup" data-pyramid="3" data-level="1"></div>
                    </div>
                    <div class="cup-row">
                        <div class="cup" data-pyramid="3" data-level="0"></div>
                        <div class="cup" data-pyramid="3" data-level="0"></div>
                        <div class="cup" data-pyramid="3" data-level="0"></div>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button class="btn" onclick="startTimer()">üöÄ B·∫Øt ƒë·∫ßu</button>
                <button class="btn stop" onclick="stopTimer()">‚èπÔ∏è D·ª´ng</button>
                <button class="btn reset" onclick="resetGame()">üîÑ Reset</button>
                <button class="btn encrypt" onclick="encryptScore()">üîê M√£ h√≥a k·∫øt qu·∫£</button>
                <button class="btn blockchain" onclick="saveToBlockchain()" id="saveBtn" disabled>
                    ‚õìÔ∏è L∆∞u l√™n Blockchain
                </button>
            </div>

            <div class="tech-specs">
                <h3>‚ö° Th√¥ng s·ªë k·ªπ thu·∫≠t FHE</h3>
                <ul>
                    <li><strong>Thu·∫≠t to√°n:</strong> BFV (Brakerski-Fan-Vercauteren) Scheme</li>
                    <li><strong>ƒê·ªô d√†i kh√≥a:</strong> 2048 bits RSA + 256 bits AES</li>
                    <li><strong>Polynomial modulus:</strong> 8192</li>
                    <li><strong>Coefficient modulus:</strong> 218 bits</li>
                    <li><strong>Plain text modulus:</strong> 1032193</li>
                    <li><strong>Security level:</strong> 128-bit quantum resistant</li>
                </ul>
            </div>
        </div>

        <div class="privacy-features">
            <div class="privacy-card">
                <h3>üõ°Ô∏è Zero-Knowledge Proofs</h3>
                <p>X√°c minh k·∫øt qu·∫£ m√† kh√¥ng ti·∫øt l·ªô th√¥ng tin c√° nh√¢n. H·ªá th·ªëng c√≥ th·ªÉ ch·ª©ng minh b·∫°n ƒë·∫°t k·ª∑ l·ª•c m√† kh√¥ng bi·∫øt th·ªùi gian ch√≠nh x√°c.</p>
            </div>
            <div class="privacy-card">
                <h3>üîê End-to-End Encryption</h3>
                <p>M·ªçi d·ªØ li·ªáu ƒë∆∞·ª£c m√£ h√≥a ngay t·ª´ thi·∫øt b·ªã c·ªßa b·∫°n. Server ch·ªâ th·ª±c hi·ªán t√≠nh to√°n tr√™n d·ªØ li·ªáu ƒë√£ m√£ h√≥a m√† kh√¥ng c·∫ßn gi·∫£i m√£.</p>
            </div>
            <div class="privacy-card">
                <h3>üåê Decentralized Leaderboard</h3>
                <p>B·∫£ng x·∫øp h·∫°ng ƒë∆∞·ª£c l∆∞u tr·ªØ ph√¢n t√°n tr√™n blockchain, ƒë·∫£m b·∫£o t√≠nh minh b·∫°ch v√† kh√¥ng th·ªÉ can thi·ªáp.</p>
            </div>
            <div class="privacy-card">
                <h3>üîç Homomorphic Operations</h3>
                <p>So s√°nh, s·∫Øp x·∫øp v√† th·ªëng k√™ ƒë∆∞·ª£c th·ª±c hi·ªán tr·ª±c ti·∫øp tr√™n d·ªØ li·ªáu m√£ h√≥a m√† kh√¥ng c·∫ßn gi·∫£i m√£.</p>
            </div>
        </div>

        <div class="history-panel">
            <h2>üìú L·ªãch s·ª≠ v√°n ƒë·∫•u</h2>
            <div class="match-history" id="matchHistory">
                <div class="match-entry">
                    <div class="match-info">
                        <div class="match-time">02:35:42</div>
                        <div class="match-date">25/09/2025 14:30</div>
                        <div>Formation: 3-6-3</div>
                    </div>
                    <div class="match-tx">
                        <div class="blockchain-badge">ƒê√£ l∆∞u</div>
                        <div class="transaction-hash">0xA7F3...B2C8</div>
                        <div class="gas-fee">Gas: 0.002 MATIC</div>
                    </div>
                </div>
                <div class="match-entry">
                    <div class="match-info">
                        <div class="match-time">03:12:18</div>
                        <div class="match-date">24/09/2025 16:45</div>
                        <div>Formation: 3-6-3</div>
                    </div>
                    <div class="match-tx">
                        <div class="blockchain-badge">ƒê√£ l∆∞u</div>
                        <div class="transaction-hash">0x3D9A...7E1F</div>
                        <div class="gas-fee">Gas: 0.0018 MATIC</div>
                    </div>
                </div>
                <div class="match-entry">
                    <div class="match-info">
                        <div class="match-time">02:48:95</div>
                        <div class="match-date">23/09/2025 10:20</div>
                        <div>Formation: 3-6-3</div>
                    </div>
                    <div class="match-tx">
                        <div class="blockchain-badge">ƒê√£ l∆∞u</div>
                        <div class="transaction-hash">0x8B4C...A5D2</div>
                        <div class="gas-fee">Gas: 0.0022 MATIC</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="leaderboard">
            <h2>üèÜ B·∫£ng x·∫øp h·∫°ng (FHE Protected)</h2>
            <div class="leaderboard-entry">
                <div>
                    <strong>ü•á Player Alpha</strong>
                    <div class="encrypted-score">E(score): 0xA7F3...B2C8</div>
                </div>
                <div>ZK Proof: ‚úÖ Verified</div>
            </div>
            <div class="leaderboard-entry">
                <div>
                    <strong>ü•à Player Beta</strong>
                    <div class="encrypted-score">E(score): 0x3D9A...7E1F</div>
                </div>
                <div>ZK Proof: ‚úÖ Verified</div>
            </div>
            <div class="leaderboard-entry">
                <div>
                    <strong>ü•â Player Gamma</strong>
                    <div class="encrypted-score">E(score): 0x8B4C...A5D2</div>
                </div>
                <div>ZK Proof: ‚úÖ Verified</div>
            </div>
            <div class="leaderboard-entry">
                <div>
                    <strong>üèÖ B·∫°n</strong>
                    <div class="encrypted-score" id="yourEncryptedScore">Ch∆∞a c√≥ ƒëi·ªÉm</div>
                </div>
                <div id="yourProofStatus">Ch∆∞a x√°c th·ª±c</div>
            </div>
        </div>
    </div>

    
<script>
window.addEventListener('load', () => {

/* ====== C·∫§U H√åNH CHUNG / ABI / ADDRESS ====== */
const CONTRACT_ADDRESS = "0x5aa8Bd672932545FCc5A3DEDd20455BE5cd6fD7b";
const CONTRACT_ABI = [
    "function recordGame(string _encryptedScore, string _formation, string _zkProof, string _nickname, uint32 _rawScore) external payable",
    "function getGameRecord(uint256 _gameId) external view returns (tuple(address player, uint256 timestamp, string encryptedScore, string formation, bool verified, string zkProof))",
    "function getPlayerStats(address _player) external view returns (tuple(string nickname, uint32 totalGames, uint32 bestScore, uint256[] gameIds))",
    "function getGlobalRecord() external view returns (uint32 record, address holder)",
    "function gameCounter() external view returns (uint256)"
];

// Base Sepolia meta
const BASE_SEPOLIA_PARAMS = {
    chainId: '0x14a34', // 84532
    chainName: 'Base Sepolia Testnet',
    nativeCurrency: {
        name: 'ETH',
        symbol: 'ETH',
        decimals: 18
    },
    rpcUrls: ['https://sepolia.base.org'],
    blockExplorerUrls: ['https://sepolia.basescan.org']
};

/* ====== L·ªöP T∆Ø∆†NG T√ÅC ====== */
class BaseSepoliaConnector {
    constructor(contractAddress, contractAbi) {
        this.contractAddress = contractAddress;
        this.contractAbi = contractAbi;
        this.provider = null;
        this.signer = null;
        this.contract = null;
    }

    async ensureMetaMaskAndNetwork() {
        if (typeof window.ethereum === 'undefined') {
            throw new Error('MetaMask ch∆∞a c√†i ƒë·∫∑t.');
        }
        const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
        if (currentChainId !== BASE_SEPOLIA_PARAMS.chainId) {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BASE_SEPOLIA_PARAMS.chainId }]
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [BASE_SEPOLIA_PARAMS]
                    });
                } else throw switchError;
            }
        }
    }

    async connect() {
        await this.ensureMetaMaskAndNetwork();
        this.provider = new ethers.providers.Web3Provider(window.ethereum);
        await this.provider.send("eth_requestAccounts", []);
        this.signer = this.provider.getSigner();
        this.contract = new ethers.Contract(this.contractAddress, this.contractAbi, this.signer);
        const address = await this.signer.getAddress();
        const balance = await this.provider.getBalance(address);
        return { address, balance: ethers.utils.formatEther(balance) };
    }

    async recordGame(encryptedScore, formation, zkProof, nickname, rawScore, valueInEther = "0.0001") {
        if (!this.contract) throw new Error('Ch∆∞a connect contract');
        const overrides = { value: ethers.utils.parseEther(valueInEther) };
        const gasEstimate = await this.contract.estimateGas.recordGame(
            encryptedScore, formation, zkProof, nickname, rawScore, overrides
        );
        const gasLimit = gasEstimate.mul(120).div(100);
        const tx = await this.contract.recordGame(
            encryptedScore, formation, zkProof, nickname, rawScore, {
                value: ethers.utils.parseEther(valueInEther),
                gasLimit: gasLimit
            }
        );
        const receipt = await tx.wait();
        return {
            transactionHash: receipt.transactionHash,
            blockNumber: receipt.blockNumber,
            gasUsed: receipt.gasUsed.toString()
        };
    }

    async getGlobalRecord() {
        if (!this.contract) return null;
        const result = await this.contract.getGlobalRecord();
        return { record: Number(result[0]), holder: result[1] };
    }
}

const baseConnector = new BaseSepoliaConnector(CONTRACT_ADDRESS, CONTRACT_ABI);

async function connectWallet() {
    try {
        document.getElementById('walletStatus').textContent = 'ƒêang k·∫øt n·ªëi...';
        document.getElementById('networkDot').className = 'status-dot pending';
        const res = await baseConnector.connect();
        gameState.walletConnected = true;
        gameState.walletAddress = res.address;
        document.getElementById('walletStatus').textContent = 'ƒê√£ k·∫øt n·ªëi';
        document.getElementById('walletAddress').textContent =
            res.address.substring(0, 6) + '...' + res.address.substring(res.address.length - 4);
        document.getElementById('networkStatus').textContent = 'Base Sepolia';
        document.getElementById('networkDot').className = 'status-dot';
        if (gameState.finalTime) document.getElementById('saveBtn').disabled = false;
    } catch (err) {
        console.error(err);
        document.getElementById('walletStatus').textContent = 'K·∫øt n·ªëi th·∫•t b·∫°i';
        document.getElementById('networkDot').className = 'status-dot disconnected';
        alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi v√≠: ' + (err.message || err));
    }
}

async function saveToBlockchain() {
    if (!gameState.walletConnected) return alert('Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc!');
    if (!gameState.finalTime) return alert('Ch∆∞a c√≥ k·∫øt qu·∫£!');
    try {
        document.getElementById('saveBtn').textContent = '‚õìÔ∏è ƒêang l∆∞u...';
        document.getElementById('saveBtn').disabled = true;
        const encryptedScore = fhe.encrypt(gameState.finalTime);
        const formation = "3-6-3";
        const zkProof = "zk_proof_" + Date.now();
        const nickname = "Player_" + Date.now().toString().slice(-6);
        const rawScore = Math.floor(gameState.finalTime);
        const txResult = await baseConnector.recordGame(encryptedScore, formation, zkProof, nickname, rawScore, "0.0001");
        gameState.matchHistory.unshift({
            time: gameState.finalTime,
            timestamp: Date.now(),
            txHash: txResult.transactionHash,
            gasUsed: txResult.gasUsed,
            encryptedScore: encryptedScore
        });
        updateMatchHistory();
        document.getElementById('saveBtn').textContent = '‚úÖ ƒê√£ l∆∞u';
        document.getElementById('status').textContent = 'ƒê√£ l∆∞u l√™n blockchain th√†nh c√¥ng!';
        setTimeout(() => { document.getElementById('saveBtn').textContent = '‚õìÔ∏è L∆∞u l√™n Blockchain'; }, 2500);
    } catch (err) {
        console.error('L·ªói khi l∆∞u:', err);
        alert('L·ªói l∆∞u blockchain: ' + (err.message || err));
        document.getElementById('saveBtn').textContent = '‚ùå L∆∞u th·∫•t b·∫°i';
        document.getElementById('saveBtn').disabled = false;
        setTimeout(() => { document.getElementById('saveBtn').textContent = '‚õìÔ∏è L∆∞u l√™n Blockchain'; }, 3000);
    }
}

});
</script>

</body>
</html>