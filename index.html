<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHE Auction v0.9.1 - Đấu Giá Bảo Mật Hoàn Toàn</title>
    <script src="https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* CSS CƠ BẢN */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'VT323', monospace; background: linear-gradient(135deg, #000000 0%, #0a0a0a 100%); color: #00ff00; min-height: 100vh; padding: 20px; font-size: 18px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 40px; animation: fadeIn 1s ease-out; }
        h1 { font-size: 3em; margin-bottom: 10px; text-shadow: 0 0 10px #00ff00, 0 0 20px rgba(0, 255, 0, 0.8); }
        .subtitle { font-size: 1.2em; opacity: 0.8; }
        
        /* BOX STYLES */
        .box { background-color: #0d0d0d; border: 2px solid #00ff00; border-radius: 5px; padding: 20px; margin-bottom: 20px; box-shadow: 0 0 10px rgba(0, 255, 0, 0.5); }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        /* FORM & BUTTONS */
        label { display: block; margin-bottom: 5px; color: #00ff00; }
        input[type="number"], button {
            width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #00ff00; background-color: #000000; color: #00ff00;
            font-family: 'VT323', monospace; font-size: 1.1em; border-radius: 3px;
        }
        button { cursor: pointer; background-color: #003300; border-color: #00ff00; transition: background-color 0.2s; }
        button:hover:not(:disabled) { background-color: #006600; }
        button:disabled { background-color: #1a1a1a; color: #555; cursor: not-allowed; border-color: #555; }
        
        /* STATUS */
        .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .status-item { background-color: #1a1a1a; padding: 8px; border-left: 3px solid #00ff00; }
        .status-item span { color: #fff; font-weight: bold; }

        /* LOGGING */
        #log-terminal { max-height: 300px; overflow-y: auto; background-color: #000000; border: 1px solid #00ff00; padding: 10px; }
        .log-entry { margin-bottom: 5px; word-wrap: break-word; }
        .log-info { color: #00ff00; }
        .log-pending { color: #ffff00; }
        .log-confirmed { color: #00ffff; }
        .log-error, .log-failed { color: #ff0000; }
        
        /* UTILITY */
        .text-center { text-align: center; }
        .notification { position: fixed; bottom: 20px; right: 20px; background-color: #006600; color: #fff; padding: 15px; border-radius: 5px; box-shadow: 0 0 20px rgba(0, 255, 0, 0.8); z-index: 1000; display: none; }
        .loading { display: inline-block; width: 1em; height: 1em; border: 2px solid #fff; border-radius: 50%; border-top-color: #00ff00; animation: spin 1s linear infinite; }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FHE AUCTION TERMINAL</h1>
            <p class="subtitle">v0.9.1 - Đấu giá ẩn danh bảo mật FHEVM Sepolia</p>
            <div id="wallet-status" class="box text-center">
                Kết nối ví để bắt đầu. <button id="connectBtn">CONNECT WALLET</button>
            </div>
        </header>

        <div class="grid-3">
            <div class="box">
                <h2>TRẠNG THÁI AUCTION</h2>
                <div class="status-grid">
                    <div class="status-item">Trạng thái: <span id="auction-state">Loading...</span></div>
                    <div class="status-item">Paused: <span id="auction-paused">Loading...</span></div>
                    <div class="status-item">Vòng đấu: <span id="current-round">Loading...</span></div>
                    <div class="status-item">End Time: <span id="auction-endTime">Loading...</span></div>
                    <div class="status-item">Winner (Last): <span id="current-lead-bidder">Loading...</span></div>
                    <div class="status-item">Deposit Min: <span id="min-deposit">Loading...</span></div>
                </div>
            </div>

            <div class="box">
                <h2>ĐẶT BID MÃ HÓA (FHE)</h2>
                <label for="bidAmount">Giá thầu bí mật (Gwei):</label>
                <input type="number" id="bidAmount" placeholder="VD: 500000000 (0.5 ETH)" min="1">
                
                <label for="depositAmount">Ký quỹ (ETH):</label>
                <input type="number" id="depositAmount" placeholder="VD: 0.1 (tối thiểu)" min="0">
                
                <button id="bidBtn">> ENCRYPT BID & SUBMIT</button>

                <div class="status-grid" style="margin-top: 20px;">
                    <div class="status-item">Deposit của bạn: <span id="your-deposit">0 ETH</span></div>
                    <div class="status-item">Refund sẵn có: <span id="pending-refund">0 ETH</span></div>
                </div>
                <button id="claimRefundBtn" style="margin-top: 10px;">> CLAIM REFUND</button>
            </div>

            <div class="box" id="owner-controls" style="display: none;">
                <h2>ADMIN/OWNER CONTROLS</h2>
                <button id="unpauseBtn" style="background-color: #006600;">> UNPAUSE AUCTION</button>
                <button id="pauseBtn" style="background-color: #660000;">> PAUSE AUCTION</button>
                <button id="requestFinalizeBtn" style="background-color: #666600;">> REQUEST FINALIZE</button>
                <button id="emergencyEndBtn" style="background-color: #990000; margin-top: 15px;">> EMERGENCY END</button>
            </div>
        </div>

        <div class="box" style="margin-top: 20px;">
            <h2>LOG TERMINAL</h2>
            <div id="log-terminal"></div>
        </div>
    </div>

    <div id="notification-area" class="notification"></div>

    <script>
        // ========== CONFIGURATION ==========
        // LƯU Ý: THAY THẾ ĐỊA CHỈ HỢP ĐỒNG NÀY BẰNG ĐỊA CHỈ HỢP ĐỒNG CỦA BẠN TRÊN SEPOLIA FHEVM
        const CONTRACT_ADDRESS = '0x123...'; // <-- CẬP NHẬT ĐỊA CHỈ HỢP ĐỒNG TẠI ĐÂY
        const SEPOLIA_CHAIN_ID = 11155111;

        // EIP-712 DOMAIN CONFIGURATION (PHẢI KHỚP TUYỆT ĐỐI VỚI HỢP ĐỒNG)
        // Hợp đồng của bạn: EIP712("FHEAuction", "1")
        const EIP712_DOMAIN_NAME = "FHEAuction";
        const EIP712_DOMAIN_VERSION = "1";
        
        // ABI (Chỉ bao gồm các hàm cần thiết)
        const FHE_AUCTION_ABI = [{"inputs":[{"internalType":"uint256","name":"_minDeposit","type":"uint256"},{"internalType":"address","name":"_pauserSet","type":"address"},{"internalType":"address","name":"_beneficiary","type":"address"},{"internalType":"address","name":"_gatewayContract","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"AuctionAlreadyFinalized","type":"error"},{"inputs":[],"name":"AuctionNotActive","type":"error"},{"inputs":[],"name":"AuctionStillActive","type":"error"},{"inputs":[],"name":"ContractPaused","type":"error"},{"inputs":[],"name":"DecryptionAlreadyPending","type":"error"},{"inputs":[],"name":"ECDSAInvalidSignature","type":"error"},{"inputs":[{"internalType":"uint256","name":"length","type":"uint256"}],"name":"ECDSAInvalidSignatureLength","type":"error"},{"inputs":[{"internalType":"bytes32","name":"s","type":"bytes32"}],"name":"ECDSAInvalidSignatureS","type":"error"},{"inputs":[],"name":"EmergencyDelayNotMet","type":"error"},{"inputs":[],"name":"HandlesAlreadySavedForRequestID","type":"error"},{"inputs":[],"name":"InsufficientDeposit","type":"error"},{"inputs":[],"name":"InvalidAddress","type":"error"},{"inputs":[],"name":"InvalidAmount","type":"error"},{"inputs":[],"name":"InvalidDecryptionData","type":"error"},{"inputs":[],"name":"InvalidKMSSignatures","type":"error"},{"inputs":[],"name":"InvalidShortString","type":"error"},{"inputs":[],"name":"InvalidSignature","type":"error"},{"inputs":[],"name":"InvalidState","type":"error"},{"inputs":[],"name":"MaxBiddersReached","type":"error"},{"inputs":[],"name":"NoBidders","type":"error"},{"inputs":[],"name":"NoHandleFoundForRequestID","type":"error"},{"inputs":[],"name":"NoRefundAvailable","type":"error"},{"inputs":[],"name":"ReentrancyGuardReentrantCall","type":"error"},{"inputs":[{"internalType":"string","name":"str","type":"string"}],"name":"StringTooLong","type":"error"},{"inputs":[],"name":"TransferFailed","type":"error"},{"inputs":[],"name":"Unauthorized","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"round","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"finalBid","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"AuctionFinished","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldBeneficiary","type":"address"},{"indexed":true,"internalType":"address","name":"newBeneficiary","type":"address"}],"name":"BeneficiaryUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"bidder","type":"address"},{"indexed":true,"internalType":"uint256","name":"round","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"depositAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"BidReceived","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"requestID","type":"uint256"}],"name":"DecryptionFulfilled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"requestId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"bytes32[]","name":"handles","type":"bytes32[]"}],"name":"DecryptionRequested","type":"event"},{"anonymous":false,"inputs":[],"name":"EIP712DomainChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"round","type":"uint256"},{"indexed":false,"internalType":"string","name":"reason","type":"string"}],"name":"EmergencyActivated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RefundAvailable","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RefundClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"round","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundStarted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"enum FHEAuction.AuctionState","name":"from","type":"uint8"},{"indexed":false,"internalType":"enum FHEAuction.AuctionState","name":"to","type":"uint8"}],"name":"StateChanged","type":"event"},{"stateMutability":"payable","type":"fallback"},{"inputs":[],"name":"AUCTION_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"BATCH_REFUND_SIZE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"EMERGENCY_DELAY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"KMS_THRESHOLD","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BIDDERS_PER_ROUND","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"auctionEndTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"auctionState","outputs":[{"internalType":"enum FHEAuction.AuctionState","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"claimants","type":"address[]"}],"name":"batchClaimRefunds","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"beneficiary","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"externalEuint64","name":"encryptedBid","type":"bytes32"},{"internalType":"bytes","name":"inputProof","type":"bytes"},{"internalType":"bytes32","name":"publicKey","type":"bytes32"},{"internalType":"bytes","name":"signature","type":"bytes"}],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"claimRefund","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentLeadBidder","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentLeadDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentRound","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"deposits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"eip712Domain","outputs":[{"internalType":"bytes1","name":"fields","type":"bytes1"},{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"version","type":"string"},{"internalType":"uint256","name":"chainId","type":"uint256"},{"internalType":"address","name":"verifyingContract","type":"address"},{"internalType":"bytes32","name":"salt","type":"bytes32"},{"internalType":"uint256[]","name":"extensions","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"reason","type":"string"}],"name":"emergencyEnd","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"forceFinalize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"gatewayContract","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getAuctionInfo","outputs":[{"internalType":"uint256","name":"round","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"enum FHEAuction.AuctionState","name":"state","type":"uint8"},{"internalType":"uint256","name":"maxDeposit","type":"uint256"},{"internalType":"address","name":"leadBidder","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"bidder","type":"address"}],"name":"getBidderInfo","outputs":[{"internalType":"uint256","name":"deposit","type":"uint256"},{"internalType":"bool","name":"hasBidded","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getProtocolId","outputs":[{"internalType":"bytes4","name":"","type":"bytes4"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"getRoundBidders","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isEmergencyAvailable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minBidDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"requestId","type":"uint256"},{"internalType":"bytes","name":"cleartexts","type":"bytes"},{"internalType":"bytes","name":"decryptionProof","type":"bytes"}],"name":"onDecryptionCallback","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pauseAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pauserSet","outputs":[{"internalType":"contract IPauserSet","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pendingRefunds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"protocolId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"requestFinalize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpauseAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newBeneficiary","type":"address"}],"name":"updateBeneficiary","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"winningBid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];

        // Global variables
        let provider;
        let signer;
        let account;
        let fheAuctionContract;
        let fhevmInstance;
        let contractOwner;
        
        const AuctionStateMap = {
            0: "Active",
            1: "Ended",
            2: "Finalizing",
            3: "Finalized",
            4: "Emergency"
        };

        // ========== UTILITY FUNCTIONS ==========
        function logMessage(message, type = 'info') {
            const terminal = document.getElementById('log-terminal');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            terminal.appendChild(entry);
            terminal.scrollTop = terminal.scrollHeight;
        }

        function showNotification(message, type = 'info', duration = 4000) {
            const notification = document.getElementById('notification-area');
            notification.textContent = message;
            notification.style.backgroundColor = type === 'error' ? '#990000' : '#006600';
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString();
        }

        // ========== WALLET & FHE SETUP ==========
        async function connectWallet() {
            if (window.ethereum) {
                try {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    account = await signer.getAddress();

                    const { chainId } = await provider.getNetwork();
                    if (chainId !== SEPOLIA_CHAIN_ID) {
                        showNotification('Please switch to Sepolia FHEVM Testnet', 'error');
                        logMessage('Wrong network detected. Please switch to Sepolia FHEVM Testnet.', 'error');
                        return;
                    }
                    
                    document.getElementById('wallet-status').innerHTML = `Connected: ${account.substring(0, 6)}...${account.substring(account.length - 4)} <span style="color:#00ffff;">(FHEVM)</span>`;
                    
                    fheAuctionContract = new ethers.Contract(CONTRACT_ADDRESS, FHE_AUCTION_ABI, signer);
                    
                    // Initialize FHE SDK
                    logMessage('[FHE] Initializing FHE SDK...', 'pending');
                    const sdk = await window.relayer_sdk_js.initSDK();
                    // Sử dụng SepoliaConfig từ Zama SDK
                    const config = window.relayer_sdk_js.SepoliaConfig;
                    fhevmInstance = await window.relayer_sdk_js.createInstance(config);
                    logMessage('[FHE] SDK Initialized successfully.', 'confirmed');

                    await loadAuctionState();
                    await loadUserInfo();
                    await loadOwnerInfo();
                    
                } catch (error) {
                    console.error("Connection Failed:", error);
                    showNotification('Wallet connection failed.', 'error');
                    logMessage('Wallet connection failed. ' + error.message, 'error');
                }
            } else {
                showNotification('MetaMask not detected.', 'error');
                logMessage('Please install MetaMask.', 'error');
            }
        }

        async function loadOwnerInfo() {
            try {
                contractOwner = await fheAuctionContract.owner();
                if (contractOwner.toLowerCase() === account.toLowerCase()) {
                    document.getElementById('owner-controls').style.display = 'block';
                    logMessage('[ADMIN] Owner panel unlocked.', 'confirmed');
                } else {
                    document.getElementById('owner-controls').style.display = 'none';
                }
            } catch (error) {
                console.error("Failed to load owner info:", error);
            }
        }

        async function loadAuctionState() {
            try {
                const [round, endTime, stateCode, maxDeposit, leadBidder] = await fheAuctionContract.getAuctionInfo();
                const pausedState = await fheAuctionContract.paused();
                const minDeposit = await fheAuctionContract.minBidDeposit();

                document.getElementById('auction-state').textContent = AuctionStateMap[stateCode];
                document.getElementById('auction-paused').textContent = pausedState ? 'YES' : 'NO';
                document.getElementById('current-round').textContent = round.toString();
                document.getElementById('auction-endTime').textContent = formatTime(endTime.toNumber());
                document.getElementById('current-lead-bidder').textContent = leadBidder === ethers.constants.AddressZero ? 'N/A' : leadBidder.substring(0, 10) + '...';
                document.getElementById('min-deposit').textContent = ethers.utils.formatEther(minDeposit) + ' ETH';
                
            } catch (error) {
                console.error("Failed to load auction state:", error);
                logMessage('Failed to load auction state. Contract not deployed or ABI error.', 'error');
            }
        }

        async function loadUserInfo() {
            try {
                const [deposit, hasBidded] = await fheAuctionContract.getBidderInfo(account);
                const pendingRefund = await fheAuctionContract.pendingRefunds(account);

                document.getElementById('your-deposit').textContent = ethers.utils.formatEther(deposit) + ' ETH';
                document.getElementById('pending-refund').textContent = ethers.utils.formatEther(pendingRefund) + ' ETH';
            } catch (error) {
                console.error("Failed to load user info:", error);
            }
        }

        // ========== MAIN FUNCTIONS ==========
        
        async function placeBid() {
            const bidAmountInput = document.getElementById('bidAmount').value;
            const depositAmountInput = document.getElementById('depositAmount').value;
            
            // Chuyển đổi ETH sang Gwei cho giá thầu bí mật
            const bidAmountGwei = parseInt(bidAmountInput); 
            const depositAmountETH = parseFloat(depositAmountInput);
            
            if (isNaN(bidAmountGwei) || bidAmountGwei <= 0) {
                showNotification('Invalid bid amount (must be Gwei)', 'error');
                return;
            }
            
            if (isNaN(depositAmountETH) || depositAmountETH <= 0) {
                showNotification('Invalid deposit amount (must be ETH)', 'error');
                return;
            }
            
            const btn = document.getElementById('bidBtn');
            
            try {
                btn.innerHTML = '<span class="loading"></span> ENCRYPTING...';
                btn.disabled = true;
                
                logMessage(`[BID] Encrypting ${bidAmountGwei} Gwei with FHE SDK...`, 'info');
                
                // 1. Tạo bản mã (Ciphertext) - Sử dụng euint64
                const input = fhevmInstance.createEncryptedInput(CONTRACT_ADDRESS, account);
                input.add64(BigInt(bidAmountGwei));
                
                logMessage('[FHE] Generating ZK proof...', 'pending');
                const encryptedData = await input.encrypt();
                
                const encryptedBidBytes32 = ethers.utils.hexlify(encryptedData.handles[0]);
                const proof = encryptedData.inputProof;
                
                logMessage('[FHE] Encryption complete. Handle: ' + encryptedBidBytes32.substring(0, 20) + '...', 'confirmed');

                // 2. Lấy FHE Public Key và Ký EIP712 (FIX LỖI SIGNATURE KHÔNG KHỚP)
                btn.innerHTML = '<span class="loading"></span> SIGNING EIP-712...';
                logMessage('[EIP-712] Requesting FHE Public Key and signature...', 'pending');
                
                // --- CORRECT LOGIC DỰA TRÊN HỢP ĐỒNG SOL- ---
                // a) Lấy Public Key của FHE Instance
                const fhek = fhevmInstance.getPublicKey(CONTRACT_ADDRESS); 
                const publicKeyBytes32 = ethers.utils.hexlify(fhek.publicKey);
                
                // b) Định nghĩa EIP-712 Domain và Types
                // CHỈ CÓ NAME VÀ VERSION VÌ HỢP ĐỒNG KHÔNG CÓ chainId và verifyingContract trong EIP712 constructor.
                const domain = {
                    name: EIP712_DOMAIN_NAME,   // "FHEAuction"
                    version: EIP712_DOMAIN_VERSION // "1"
                };
                
                const types = {
                    // PHẢI KHỚP TUYỆT ĐỐI VỚI structHash trong Solidity
                    PublicKey: [
                        { name: 'key', type: 'bytes32' }
                    ]
                };
                
                // c) Giá trị cần ký (FHE Public Key)
                const value = {
                    key: publicKeyBytes32
                };
                
                // d) Ký EIP-712 (SỬ DỤNG _signTypedData CỦA SIGNER)
                const signature = await signer._signTypedData(domain, types, value);
                
                // --- END CORRECT LOGIC ---
                
                logMessage('[EIP-712] Signature obtained: ' + signature.substring(0, 20) + '...', 'confirmed');

                // 3. Gửi giao dịch
                btn.innerHTML = '<span class="loading"></span> SUBMITTING TX...';
                logMessage('[TX] Sending encrypted bid to contract...', 'pending');
                
                const depositWei = ethers.utils.parseEther(depositAmountETH.toString());
                
                const tx = await fheAuctionContract.bid(
                    encryptedBidBytes32,           // externalEuint64 encryptedBid (Ciphertext Handle)
                    proof,                          // bytes inputProof (ZK Proof)
                    publicKeyBytes32,               // bytes32 publicKey (FHE Public Key)
                    signature,                      // bytes signature (EIP-712 Signature của Public Key)
                    { 
                        value: depositWei,
                        gasLimit: 600000 // Tăng gas limit cho FHE tx
                    }
                );
                
                logMessage(`[TX] Hash: ${tx.hash.substring(0, 20)}...`, 'pending');
                showNotification('Transaction submitted! Waiting for confirmation...', 'info');
                
                const receipt = await tx.wait();
                
                logMessage(`[SUCCESS] Bid submitted! Block: ${receipt.blockNumber}`, 'confirmed');
                showNotification('Encrypted bid confirmed!', 'success');
                
                document.getElementById('bidAmount').value = '';
                document.getElementById('depositAmount').value = '';
                
                await loadAuctionState();
                await loadUserInfo();
                
            } catch (error) {
                console.error('Bid error:', error);
                const msg = error.reason || error.message || 'Transaction failed';
                logMessage(`[ERROR] ${msg}`, 'failed');
                showNotification(`Bid failed: ${msg}`, 'error');
            } finally {
                btn.innerHTML = '> ENCRYPT BID & SUBMIT';
                btn.disabled = false;
            }
        }

        async function claimRefund() {
             // Logic hàm claimRefund
            const btn = document.getElementById('claimRefundBtn');
            try {
                btn.innerHTML = '<span class="loading"></span> CLAIMING...';
                btn.disabled = true;

                const tx = await fheAuctionContract.claimRefund({ gasLimit: 200000 });
                logMessage(`[TX] Claim Refund Hash: ${tx.hash.substring(0, 20)}...`, 'pending');
                
                await tx.wait();
                
                logMessage(`[SUCCESS] Refund claimed.`, 'confirmed');
                showNotification('Refund claimed successfully!', 'success');
                await loadUserInfo();
                
            } catch (error) {
                console.error('Claim Refund error:', error);
                const msg = error.reason || error.message || 'Claim failed';
                logMessage(`[ERROR] ${msg}`, 'failed');
                showNotification(`Claim failed: ${msg}`, 'error');
            } finally {
                btn.innerHTML = '> CLAIM REFUND';
                btn.disabled = false;
            }
        }

        async function requestFinalize() {
            // Logic hàm requestFinalize
            const btn = document.getElementById('requestFinalizeBtn');
            try {
                btn.innerHTML = '<span class="loading"></span> FINALIZING...';
                btn.disabled = true;

                const tx = await fheAuctionContract.requestFinalize({ gasLimit: 500000 });
                logMessage(`[TX] Finalize Hash: ${tx.hash.substring(0, 20)}...`, 'pending');
                
                await tx.wait();
                
                logMessage(`[SUCCESS] Finalize request confirmed. Waiting for KMS callback.`, 'confirmed');
                showNotification('Finalization Requested. Waiting for KMS/Oracle.', 'info');
                
            } catch (error) {
                console.error('Finalize error:', error);
                const msg = error.reason || error.message || 'Finalize failed';
                logMessage(`[ERROR] ${msg}`, 'failed');
                showNotification(`Finalize failed: ${msg}`, 'error');
            } finally {
                // Giữ nút Finalize bị disabled để chờ trạng thái Finalized
                btn.innerHTML = 'AWAIT ORACLE CALLBACK...';
                // btn.disabled = false; // Tạm thời giữ disabled
            }
        }

        async function pauseAuction() {
            // Logic hàm pauseAuction
            const btn = document.getElementById('pauseBtn');
            try {
                btn.innerHTML = '<span class="loading"></span> PAUSING...';
                btn.disabled = true;

                const tx = await fheAuctionContract.pauseAuction({ gasLimit: 100000 });
                logMessage(`[TX] Pause Hash: ${tx.hash.substring(0, 20)}...`, 'pending');
                
                await tx.wait();
                
                logMessage(`[SUCCESS] Auction Paused.`, 'confirmed');
                showNotification('Auction Paused!', 'error');
                await loadAuctionState();
                
            } catch (error) {
                console.error('Pause error:', error);
                const msg = error.reason || error.message || 'Pause failed';
                logMessage(`[ERROR] ${msg}`, 'failed');
                showNotification(`Pause failed: ${msg}`, 'error');
            } finally {
                btn.innerHTML = '> PAUSE AUCTION';
                btn.disabled = false;
            }
        }

        async function unpauseAuction() {
            // Logic hàm unpauseAuction
            const btn = document.getElementById('unpauseBtn');
            try {
                btn.innerHTML = '<span class="loading"></span> UNPAUSING...';
                btn.disabled = true;

                const tx = await fheAuctionContract.unpauseAuction({ gasLimit: 100000 });
                logMessage(`[TX] Unpause Hash: ${tx.hash.substring(0, 20)}...`, 'pending');
                
                await tx.wait();
                
                logMessage(`[SUCCESS] Auction Unpaused.`, 'confirmed');
                showNotification('Auction Unpaused!', 'success');
                await loadAuctionState();
                
            } catch (error) {
                console.error('Unpause error:', error);
                const msg = error.reason || error.message || 'Unpause failed';
                logMessage(`[ERROR] ${msg}`, 'failed');
                showNotification(`Unpause failed: ${msg}`, 'error');
            } finally {
                btn.innerHTML = '> UNPAUSE AUCTION';
                btn.disabled = false;
            }
        }

        async function emergencyEnd() {
            // Logic hàm emergencyEnd
            const btn = document.getElementById('emergencyEndBtn');
            try {
                btn.innerHTML = '<span class="loading"></span> EMERGENCY ENDING...';
                btn.disabled = true;

                const tx = await fheAuctionContract.emergencyEnd("Owner activation", { gasLimit: 200000 });
                logMessage(`[TX] Emergency End Hash: ${tx.hash.substring(0, 20)}...`, 'pending');
                
                await tx.wait();
                
                logMessage(`[SUCCESS] Emergency End activated.`, 'confirmed');
                showNotification('Emergency End activated!', 'error');
                await loadAuctionState();
                
            } catch (error) {
                console.error('Emergency End error:', error);
                const msg = error.reason || error.message || 'Emergency End failed';
                logMessage(`[ERROR] ${msg}`, 'failed');
                showNotification(`Emergency End failed: ${msg}`, 'error');
            } finally {
                btn.innerHTML = '> EMERGENCY END';
                btn.disabled = false;
            }
        }
        
        // ========== EVENT LISTENERS (Contract) ==========
        function setupEventListeners() {
            if (!fheAuctionContract) return;

            fheAuctionContract.on('AuctionFinished', (round, winner, finalBid, timestamp) => {
                logMessage(`[EVENT] Round ${round} Finished! Winner: ${winner.substring(0, 10)}..., Bid: ${ethers.utils.formatUnits(finalBid, 'gwei')} Gwei`, 'confirmed');
                showNotification(`Auction Finished! Winner: ${winner.substring(0, 10)}...`, 'success');
                loadAuctionState();
            });

            fheAuctionContract.on('BidReceived', (bidder, round, depositAmount, timestamp) => {
                logMessage(`[EVENT] New Bid on Round ${round} from ${bidder.substring(0, 8)}... Deposit: ${ethers.utils.formatEther(depositAmount)} ETH`, 'info');
                loadAuctionState();
            });
            
            fheAuctionContract.on('RefundClaimed', (recipient, amount) => {
                logMessage(`[EVENT] Refund claimed by ${recipient.substring(0, 8)}...: ${ethers.utils.formatEther(amount)} ETH`, 'confirmed');
                if (recipient.toLowerCase() === account.toLowerCase()) {
                    loadUserInfo();
                }
            });
        }
        
        // ========== SETUP UI HANDLERS ==========
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('connectBtn').addEventListener('click', connectWallet);
            document.getElementById('bidBtn').addEventListener('click', placeBid);
            document.getElementById('claimRefundBtn').addEventListener('click', claimRefund);
            document.getElementById('requestFinalizeBtn').addEventListener('click', requestFinalize);
            document.getElementById('pauseBtn').addEventListener('click', pauseAuction);
            document.getElementById('unpauseBtn').addEventListener('click', unpauseAuction);
            document.getElementById('emergencyEndBtn').addEventListener('click', emergencyEnd);
            // document.getElementById('updateBeneficiaryBtn').addEventListener('click', updateBeneficiary); // Bỏ các hàm chưa cần thiết
            // document.getElementById('batchRefundBtn').addEventListener('click', batchClaimRefunds); 
            
            logMessage('[INIT] FHE Auction v0.9.1 interface loaded', 'confirmed');
            logMessage('[INFO] Contract: ' + CONTRACT_ADDRESS, 'info');
        });
        
    </script>
</body>
</html>
