<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zama Blind Auction dApp</title>
    <!-- 1. Tải Tailwind CSS để làm đẹp -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Tải Ethers.js (thư viện tương tác Ethereum) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <!-- 3. Tải Zama FHEVM Utils (thư viện client-side để mã hoá) -->
    <!-- Chúng ta dùng bản UMD để nó tự động gắn vào window.fhevmUtils -->
    <script src="https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.umd.cjs"></script>
    
    <style>
        /* Thêm font chữ Inter cho đẹp */
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <div class="max-w-md w-full bg-gray-800 rounded-lg shadow-xl p-6">
        <h1 class="text-2xl font-bold text-center mb-4">Blind Auction (Zama FHEVM)</h1>
        <p class="text-center text-sm text-gray-400 mb-2">Contract trên Sepolia:</p>
        <a href="https://sepolia.etherscan.io/address/0xf885102a2ac3ef23744defb89ce71ad2b458e0ab" target="_blank" rel="noopener noreferrer" class="block text-center text-xs text-blue-400 hover:text-blue-300 break-all mb-6">
            0xf885102a2...b458e0ab
        </a>

        <!-- Nút Kết Nối Ví -->
        <button id="connectButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
            Kết Nối Ví MetaMask
        </button>

        <!-- Hiển Thị Trạng Thái Ví -->
        <div id="walletStatus" class="mt-4 text-center text-sm text-gray-300 h-5"></div>

        <!-- Form Đặt Giá Thầu -->
        <div id="bidSection" class="hidden mt-6">
            <label for="bidAmount" class="block text-sm font-medium text-gray-300 mb-2">Số Tiền Đặt Thầu (bằng WEI)</label>
            <input type="number" id="bidAmount" name="bidAmount" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập số tiền bằng WEI...">
            <p class="text-xs text-gray-500 mt-2">
                Lưu ý: Contract này yêu cầu `msg.value` (số ETH gửi kèm) phải lớn hơn hoặc bằng giá thầu của bạn.
                <br>
                Do giới hạn của FHEVM-Utils JS, giá thầu (uint32) tối đa là 4,294,967,295 WEI (~0.004 Gwei).
            </p>
            
            <button id="bidButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 mt-4" disabled>
                Đặt Giá Thầu (Place Bid)
            </button>
        </div>

        <!-- Vùng Hiển Thị Thông Báo -->
        <div id="messageArea" class="mt-4 text-center text-sm text-yellow-300 h-10 break-words"></div>
    </div>

    <!-- SỬA LỖI 1: Thay 'typeV' thành 'type' -->
    <script type="module">
        // --- Khai báo biến ---
        const contractAddress = "0xf885102a2ac3ef23744defb89ce71ad2b458e0ab";
        const sepoliaChainId = "0xaa36a7"; // 11155111
        
        // ABI của contract (lấy từ Etherscan)
        const contractABI = [
            {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
            {"inputs":[],"name":"auctionEnd","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"auctionEnded","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"beneficiary","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"bytes","name":"encryptedBid","type":"bytes"}],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[],"name":"highestBid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"highestBidder","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pendingReturns","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"reveal","outputs":[],"stateMutability":"nonpayable","type":"function"},
            // SỬA LỖI 2: Xoá chữ 'F' thừa trước "name":"withdraw"
            {"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        let provider;
        let signer;
        let userAddress;
        let contract;
        let fhevmInstance; // Zama FHEVM instance

        // --- Lấy các phần tử DOM ---
        const connectButton = document.getElementById("connectButton");
        const walletStatus = document.getElementById("walletStatus");
        const bidSection = document.getElementById("bidSection");
        const bidButton = document.getElementById("bidButton");
        const bidAmountInput = document.getElementById("bidAmount");
        const messageArea = document.getElementById("messageArea");

        // --- Hàm xử lý ---

        /**
         * 1. Kết nối với ví MetaMask
         */
        async function connectWallet() {
            messageArea.textContent = "Đang chờ kết nối ví...";
            if (typeof window.ethereum === "undefined") {
                messageArea.textContent = "Lỗi: Vui lòng cài đặt MetaMask!";
                return;
            }

            try {
                // Sử dụng Ethers.js provider
                provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // Yêu cầu người dùng kết nối tài khoản
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // Kiểm tra chainId
                const network = await provider.getNetwork();
                if (network.chainId !== parseInt(sepoliaChainId, 16)) {
                    messageArea.textContent = "Đang chuyển sang mạng Sepolia...";
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: sepoliaChainId }],
                        });
                        // Provider cần được làm mới sau khi đổi mạng
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                        signer = provider.getSigner(); // Sửa lỗi: getSignER() -> getSigner()
                        userAddress = await signer.getAddress();
                    } catch (switchError) {
                        messageArea.textContent = "Lỗi: Vui lòng tự chuyển sang mạng Sepolia.";
                        return;
                    }
                }

                // Cập nhật UI
                walletStatus.textContent = `Đã kết nối: ${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
                connectButton.textContent = "Đã Kết Nối";
                connectButton.disabled = true;
                bidSection.classList.remove("hidden");
                
                // Khởi tạo Zama FHEVM
                initFhevm();

            } catch (error) {
                console.error("Lỗi kết nối ví:", error);
                messageArea.textContent = `Lỗi kết nối: ${error.message}`;
            }
        }

        /**
         * 2. Khởi tạo FHEVM instance
         * Đây là bước cần thiết để có thể mã hoá dữ liệu theo Zama.
         */
        function initFhevm() {
            messageArea.textContent = "Đang khởi tạo FHEVM instance...";
            try {
                // fhevmUtils được tải từ CDN
                fhevmInstance = new fhevmUtils.FhevmInstance(provider, contractAddress);
                messageArea.textContent = "FHEVM đã sẵn sàng. Vui lòng nhập giá thầu.";
                bidButton.disabled = false; // Kích hoạt nút đặt thầu
            } catch (error) {
                console.error("Lỗi khởi tạo FHEVM:", error);
                messageArea.textContent = "Lỗi khởi tạo FHEVM instance.";
            }
        }

        /**
         * 3. Đặt giá thầu (Place Bid)
         */
        async function placeBid() {
            if (!signer || !fhevmInstance) {
                messageArea.textContent = "Lỗi: Ví chưa kết nối hoặc FHEVM chưa sẵn sàng.";
                return;
            }

            const bidAmountStr = bidAmountInput.value;
            if (!bidAmountStr || isNaN(bidAmountStr) || parseInt(bidAmountStr) <= 0) {
                messageArea.textContent = "Lỗi: Vui lòng nhập số tiền (WEI) hợp lệ.";
                return;
            }

            const bidAmountWei = parseInt(bidAmountStr);
            
            // Giới hạn của uint32
            if (bidAmountWei > 4294967295) {
                 messageArea.textContent = "Lỗi: Giá thầu vượt quá giới hạn (uint32 max).";
                 return;
            }

            bidButton.disabled = true;
            messageArea.textContent = "Đang lấy FHEVM Public Key...";

            try {
                // Tạo ZamaEthers helper
                const zamaEthers = new fhevmUtils.ZamaEthers(fhevmInstance);

                // Lấy public key từ network (cần thiết để mã hoá)
                const { publicKey, signature } = await zamaEthers.getPublicKey(signer);

                messageArea.textContent = "Đang mã hoá giá thầu (encrypt32)...";
                
                // Mã hoá giá thầu. Contract này dùng FHE.decrypt()
                // nên chúng ta dùng encrypt32 (cho kiểu uint32)
                const encryptedBid = zamaEthers.encrypt32(bidAmountWei, publicKey);

                messageArea.textContent = "Đang chuẩn bị giao dịch...";
                
                // Tạo contract instance với signer
                contract = new ethers.Contract(contractAddress, contractABI, signer);

                // Gọi hàm bid(bytes) VÀ gửi kèm msg.value
                // Contract yêu cầu msg.value >= bidAmountWei
                const tx = await contract.bid(encryptedBid, {
                    value: bidAmountWei 
                });

                messageArea.textContent = `Đang gửi giao dịch... (Hash: ${tx.hash.substring(0, 10)}...)`;
                
                // Chờ giao dịch được xác nhận
                await tx.wait();

                messageArea.textContent = "Thành công! Giao dịch đặt thầu đã được xác nhận.";
                bidAmountInput.value = ""; // Xoá input

            } catch (error) {
                console.error("Lỗi khi đặt giá thầu:", error);
                messageArea.textContent = `Lỗi: ${error.message}`;
            } finally {
                bidButton.disabled = false; // Kích hoạt lại nút
            }
        }

        // --- Gắn sự kiện ---
        window.addEventListener('DOMContentLoaded', () => {
            connectButton.addEventListener('click', connectWallet);
            bidButton.addEventListener('click', placeBid);
        });

    </script>
</body>
</html>


