<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê FHE Auction System - Sepolia FHEVM</title>
    <!-- Tailwind CSS (Framework ƒë·ªÉ t·∫°o giao di·ªán ƒë·∫πp v√† responsive) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font ch·ªØ theo phong c√°ch retro/terminal -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <!-- Th∆∞ vi·ªán Ethers.js v6 (ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi Blockchain) -->
    <script type="module">
        // Import Ethers.js v6
        import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.min.js";
        window.ethers = ethers;
    </script>
    <style>
        :root {
            --primary: #00ff00; /* Xanh l√° neon */
            --secondary: #ffff00; /* V√†ng neon */
            --background: #000000;
        }
        body { font-family: 'VT323', monospace; background: linear-gradient(135deg, #000000 0%, #0a0a0a 100%); color: var(--primary); min-height: 100vh; padding: 20px; }
        .card {
            background-color: #1a1a1a;
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
            animation: fadeInUp 0.8s ease-out;
        }
        .button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background-color: var(--primary);
            color: var(--background);
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        .button:hover {
            background-color: var(--secondary);
            color: var(--background);
            box-shadow: 0 0 10px var(--secondary);
        }
        .button:disabled {
            background-color: #333;
            color: #666;
            cursor: not-allowed;
            box-shadow: none;
        }
        .input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #0d0d0d;
            border: 1px solid var(--primary);
            border-radius: 6px;
            color: var(--primary);
            font-size: 1em;
            box-shadow: inset 0 0 5px rgba(0, 255, 0, 0.3);
        }
        /* Custom animation (c√≥ th·ªÉ d√πng Tailwind config nh∆∞ng vi·∫øt th·∫≥ng v√†o ƒë√¢y cho ƒë∆°n gi·∫£n) */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-4">
        <!-- HEADER -->
        <header class="text-center mb-10 animate-fadeIn">
            <h1 class="text-5xl md:text-6xl font-bold mb-3 text-primary drop-shadow-[0_0_10px_#00ff00]">
                üîê FHE AUCTION SYSTEM
                <span id="version" class="inline-block bg-primary text-black px-3 py-1 text-sm ml-3 rounded">
                    v1.0
                </span>
            </h1>
            <p class="text-xl text-secondary opacity-90">
                ƒê·∫•u gi√° M√π (Blind Auction) v·ªõi M√£ h√≥a ƒê·ªìng c·∫•u Ho√†n to√†n (FHE)
            </p>
        </header>

        <!-- MAIN GRID -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

            <!-- 1. WALLET CARD -->
            <div id="wallet-card" class="card col-span-1">
                <h2 class="mb-5 text-2xl text-secondary border-b-2 border-dashed border-primary pb-2">üîó K·∫æT N·ªêI V√ç</h2>
                <div id="wallet-status">
                    <p class="mb-2">Tr·∫°ng th√°i: <span id="connect-status" class="text-red-500 font-bold">DISCONNECTED</span></p>
                    <p class="mb-2">M·∫°ng: <span id="network-status" class="text-red-500 font-bold">CH∆ØA X√ÅC ƒê·ªäNH</span></p>
                    <p id="account-info" class="text-sm break-words hidden">ƒê·ªãa ch·ªâ v√≠: <span class="text-white" id="account-display"></span></p>
                    <p id="owner-info" class="text-sm font-bold text-red-500 hidden">[OWNER MODE]</p>
                </div>
                <button id="connectBtn" class="button mt-4">> CONNECT WALLET</button>
            </div>

            <!-- 2. AUCTION STATUS -->
            <div id="auction-status-card" class="card col-span-1">
                <h2 class="mb-5 text-2xl text-secondary border-b-2 border-dashed border-primary pb-2">‚è∞ T√åNH TR·∫†NG ƒê·∫§U GI√Å</h2>
                <div class="space-y-3">
                    <p>Tr·∫°ng th√°i: <span id="auction-state" class="text-yellow-500">ƒêang t·∫£i...</span></p>
                    <p>V√≤ng hi·ªán t·∫°i: <span id="current-round">N/A</span></p>
                    <p>Th·ªùi gian c√≤n l·∫°i: <span id="time-left" class="text-red-500 font-bold">N/A</span></p>
                    <p>Ng∆∞·ªùi th·∫Øng cu·ªôc: <span id="winner-address" class="break-words text-white">Ch∆∞a x√°c ƒë·ªãnh</span></p>
                    <p>Gi√° th·∫Øng cu·ªôc: <span id="winner-bid" class="text-secondary">N/A</span></p>
                </div>
            </div>

            <!-- 3. PLACE BID CARD -->
            <div id="bid-card" class="card col-span-1">
                <h2 class="mb-5 text-2xl text-secondary border-b-2 border-dashed border-primary pb-2">üí∏ ƒê·∫∂T GI√Å M√ô (BLIND BID)</h2>
                <label for="bid-input" class="block mb-2 text-sm text-white">Gi√° Th·∫ßu C·ªßa B·∫°n (ETH):</label>
                <input type="number" id="bid-input" placeholder="V√≠ d·ª•: 0.5" class="input" step="any" min="0.00000001">
                <p class="text-sm text-yellow-500 mb-2">
                    Min Bid Deposit: <span id="min-bid-deposit">N/A</span> ETH.
                </p>
                <button id="bidBtn" class="button" disabled>> PLACE BID (FHE ENCRYPTED)</button>
                <p class="text-xs mt-2 text-gray-400">
                    *Gi√° th·∫ßu c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c **m√£ h√≥a ho√†n to√†n** (FHE) tr∆∞·ªõc khi g·ª≠i l√™n m·∫°ng.
                </p>
            </div>

            <!-- 4. REFUND CARD -->
            <div id="refund-card" class="card lg:col-span-1">
                <h2 class="mb-5 text-2xl text-secondary border-b-2 border-dashed border-primary pb-2">üí∞ HO√ÄN TI·ªÄN (REFUNDS)</h2>
                <p class="mb-3 text-sm">Ch·ªâ c√≥ th·ªÉ ho√†n ti·ªÅn n·∫øu b·∫°n KH√îNG ph·∫£i l√† ng∆∞·ªùi th·∫Øng cu·ªôc v√† ƒë·∫•u gi√° ƒë√£ k·∫øt th√∫c.</p>
                <button id="claimRefundBtn" class="button btn-warning" disabled>> CLAIM YOUR REFUND</button>
                <div class="mt-4 pt-4 border-t border-dashed border-gray-700">
                    <label for="batch-addresses-input" class="block mb-2 text-sm text-white">Ho√†n ti·ªÅn h√†ng lo·∫°t (Addresses, c√°ch nhau b·∫±ng d·∫•u ph·∫©y):</label>
                    <input type="text" id="batch-addresses-input" placeholder="0x..., 0x..." class="input">
                    <button id="batchRefundBtn" class="button" disabled>> BATCH CLAIM REFUNDS</button>
                </div>
            </div>

            <!-- 5. OWNER PANEL (·∫®N M·∫∂C ƒê·ªäNH) -->
            <div id="owner-panel" class="card lg:col-span-2 hidden">
                <h2 class="mb-5 text-2xl text-red-500 border-b-2 border-dashed border-red-500 pb-2">üö® OWNER PANEL (CH·ªà D√ÄNH CHO CH·ª¶ H·ª¢P ƒê·ªíNG)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <button id="requestFinalizeBtn" class="button bg-red-800 hover:bg-red-600" disabled>> Y√äU C·∫¶U K·∫æT TH√öC (REQUEST FINALIZE)</button>
                        <p class="text-xs text-gray-400 mt-1">Y√™u c·∫ßu KMS gi·∫£i m√£ gi√° th·∫Øng cu·ªôc.</p>
                    </div>
                    <div>
                        <button id="emergencyEndBtn" class="button bg-red-900 hover:bg-red-700" disabled>> K·∫æT TH√öC KH·∫®N C·∫§P</button>
                        <p class="text-xs text-gray-400 mt-1">D·ª´ng ƒë·∫•u gi√° ngay l·∫≠p t·ª©c.</p>
                    </div>
                    <div class="col-span-full flex gap-2">
                        <button id="pauseBtn" class="button w-1/2 bg-yellow-800 hover:bg-yellow-600" disabled>> T·∫†M D·ª™NG</button>
                        <button id="unpauseBtn" class="button w-1/2 bg-green-800 hover:bg-green-600" disabled style="display: none;">> KH·ªûI ƒê·ªòNG L·∫†I</button>
                    </div>
                    <div class="col-span-full">
                        <input type="text" id="newBeneficiaryInput" placeholder="ƒê·ªãa ch·ªâ ng∆∞·ªùi th·ª• h∆∞·ªüng m·ªõi" class="input mt-2">
                        <button id="updateBeneficiaryBtn" class="button bg-blue-800 hover:bg-blue-600" disabled>> C·∫¨P NH·∫¨T NG∆Ø·ªúI TH·ª§ H∆Ø·ªûNG</button>
                    </div>
                </div>
            </div>

            <!-- 6. TRANSACTION LOG -->
            <div class="card col-span-full">
                <h2 class="mb-5 text-2xl text-secondary border-b-2 border-dashed border-primary pb-2">üìú NH·∫¨T K√ù GIAO D·ªäCH (TRANSACTION LOG)</h2>
                <div id="log-output" class="h-64 overflow-y-scroll bg-[#0d0d0d] p-3 text-sm rounded-lg border border-gray-700">
                    <p class="text-yellow-500">[INIT] Ch√†o m·ª´ng ƒë·∫øn v·ªõi FHE Auction. Vui l√≤ng k·∫øt n·ªëi v√≠.</p>
                </div>
            </div>

        </div>

        <!-- FOOTER -->
        <footer class="text-center text-sm mt-10 opacity-70">
            <p>Contract Address:
                <a id="contract-link" href="#" target="_blank" class="text-secondary hover:underline">
                    0x3023a7Dc6f4732c4004C3070A12dD6e796cD3C93
                </a>
            </p>
            <p>Powered by <span class="text-primary font-bold">Zama FHEVM</span> | Fully Homomorphic Encryption</p>
        </footer>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.min.js";
        // KH√îNG TH·ªÇ D√ôNG TR·ª∞C TI·∫æP T·ª™ CDN TRONG T·ªÜP ƒê∆†N N√ÄY
        // Thay v√†o ƒë√≥, ch√∫ng ta s·∫Ω t·∫°o c√°c h√†m gi·∫£ ƒë·ªãnh cho FHE/Relayer.
        // Trong m√¥i tr∆∞·ªùng React/Node th·ª±c t·∫ø, b·∫°n s·∫Ω d√πng:
        // import * as fhe from '@fhevm/sdk';
        // import { createInstance } from '@zama-fhe/relayer-sdk';

        // =========================================================================
        // ============== C√ÅC H·∫∞NG S·ªê V√Ä C·∫§U H√åNH (D·ª±a tr√™n contracts.ts) ===========
        // =========================================================================

        const CONTRACT_ADDRESS = '0x3023a7Dc6f4732c4004C3070A12dD6e796cD3C93';
        const SEPOLIA_CHAIN_ID = 11155111; // ID m·∫°ng Sepolia FHEVM

        // ABI (Ch·ªâ bao g·ªìm c√°c h√†m c·∫ßn thi·∫øt cho UI)
        const FHE_AUCTION_ABI = [
            // View Functions
            { "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "minBidDeposit", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "auctionEndTime", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "auctionState", "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "currentRound", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "winner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "bidder", "type": "address" }], "name": "hasClaimedRefund", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "getEncryptedWinningBid", "outputs": [{ "internalType": "bytes", "name": "", "type": "bytes" }], "stateMutability": "view", "type": "function" }, // ƒê·ªÉ check winner bid
            { "inputs": [], "name": "getDecryptedWinningBid", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },

            // Write Functions
            { "inputs": [{ "internalType": "bytes", "name": "encryptedBid", "type": "bytes" }, { "internalType": "bytes", "name": "proof", "type": "bytes" }], "name": "bid", "outputs": [], "stateMutability": "payable", "type": "function" },
            { "inputs": [], "name": "requestFinalize", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [], "name": "forceFinalize", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [], "name": "emergencyEnd", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [], "name": "claimRefund", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "address[]", "name": "bidders", "type": "address[]" }], "name": "batchClaimRefunds", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "newBeneficiary", "type": "address" }], "name": "updateBeneficiary", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [], "name": "pauseAuction", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [], "name": "unpauseAuction", "outputs": [], "stateMutability": "nonpayable", "type": "function" },

            // Events (Quan tr·ªçng ƒë·ªÉ theo d√µi)
            { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "bidder", "type": "address" }, { "indexed": false, "internalType": "bytes", "name": "encryptedBid", "type": "bytes" }], "name": "NewBid", "type": "event" },
            { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "recipient", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "RefundClaimed", "type": "event" },
            { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "winner", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "bid", "type": "uint256" }], "name": "AuctionFinalized", "type": "event" },
            { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint8", "name": "newState", "type": "uint8" }], "name": "AuctionStateChanged", "type": "event" }
        ];

        // MAPPING TR·∫†NG TH√ÅI ƒê·∫§U GI√Å (D·ª±a tr√™n enum trong contract)
        const AUCTION_STATES = {
            0: 'Active',
            1: 'Finalizing', // ƒêang y√™u c·∫ßu gi·∫£i m√£
            2: 'Decrypted',  // ƒê√£ c√≥ gi√° th·∫Øng cu·ªôc gi·∫£i m√£
            3: 'Finished',   // ƒê√£ ho√†n th√†nh (c√≥ th·ªÉ r√∫t ti·ªÅn)
            4: 'Paused'
        };

        // =========================================================================
        // ======================= BI·∫æN TO√ÄN C·ª§C V√Ä H√ÄM TI·ªÜN √çCH =====================
        // =========================================================================

        let provider, signer, contract, auctionOwner, currentAccount;
        let auctionInterval;

        // H√†m gi·∫£ ƒë·ªãnh FHE: Trong d·ª± √°n th·ª±c t·∫ø, b·∫°n s·∫Ω kh·ªüi t·∫°o fhe.js v√† t·∫°o proof ·ªü ƒë√¢y.
        // (Kh√¥ng th·ªÉ d√πng tr·ª±c ti·∫øp trong t·ªáp HTML ƒë∆°n n√†y)
        const mockFHE = {
            // H√†m n√†y s·∫Ω d√πng @fhevm/sdk ƒë·ªÉ m√£ h√≥a gi√° th·∫ßu c·ªßa b·∫°n
            encryptBid: (bidWei) => {
                logMessage(`[FHE] ƒêang m√£ h√≥a gi√° ${ethers.formatEther(bidWei)} ETH...`, 'info');
                // Tr·∫£ v·ªÅ m·ªôt m√£ h√≥a placeholder v√† m·ªôt proof placeholder
                return {
                    encryptedBid: ethers.toUtf8Bytes("encrypted_bid_data_" + bidWei.toString()),
                    proof: ethers.toUtf8Bytes("proof_data_" + bidWei.toString()),
                };
            }
        };

        // H√†m log th√¥ng b√°o ra UI
        function logMessage(message, type = 'info') {
            const logOutput = document.getElementById('log-output');
            const p = document.createElement('p');
            const timestamp = new Date().toLocaleTimeString();

            let color = 'text-gray-400';
            if (type === 'success') color = 'text-green-500';
            else if (type === 'error') color = 'text-red-500';
            else if (type === 'info') color = 'text-yellow-500';
            else if (type === 'confirmed') color = 'text-white';

            p.className = color;
            p.innerHTML = `[${timestamp} | ${type.toUpperCase()}] ${message}`;

            // Th√™m v√†o ƒë·∫ßu (m·ªõi nh·∫•t n·∫±m tr√™n)
            if (logOutput.firstChild) {
                logOutput.insertBefore(p, logOutput.firstChild);
            } else {
                logOutput.appendChild(p);
            }
        }

        // =========================================================================
        // ======================= QU·∫¢N L√ù V√ç V√Ä K·∫æT N·ªêI =============================
        // =========================================================================

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                logMessage('MetaMask kh√¥ng ƒë∆∞·ª£c t√¨m th·∫•y. Vui l√≤ng c√†i ƒë·∫∑t MetaMask.', 'error');
                return;
            }

            try {
                // Ethers v6: S·ª≠ d·ª•ng BrowserProvider
                provider = new ethers.BrowserProvider(window.ethereum);

                // Ki·ªÉm tra v√† chuy·ªÉn m·∫°ng (MANDATORY cho FHEVM)
                const network = await provider.getNetwork();
                if (network.chainId !== BigInt(SEPOLIA_CHAIN_ID)) {
                    logMessage('Sai m·∫°ng! Vui l√≤ng chuy·ªÉn sang Sepolia FHEVM (Chain ID: 11155111).', 'error');
                    // C·ªë g·∫Øng chuy·ªÉn m·∫°ng t·ª± ƒë·ªông (t√πy ch·ªçn)
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: ethers.toQuantity(SEPOLIA_CHAIN_ID) }],
                        });
                        // Sau khi chuy·ªÉn, t·∫£i l·∫°i trang ƒë·ªÉ k·∫øt n·ªëi l·∫°i
                        window.location.reload();
                        return;
                    } catch (switchError) {
                        logMessage(`Kh√¥ng th·ªÉ chuy·ªÉn m·∫°ng t·ª± ƒë·ªông: ${switchError.message}`, 'error');
                    }
                }
                
                // Y√™u c·∫ßu t√†i kho·∫£n
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                currentAccount = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, FHE_AUCTION_ABI, signer);
                
                // L·∫•y Owner ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i
                auctionOwner = await contract.owner();
                const isOwner = currentAccount.toLowerCase() === auctionOwner.toLowerCase();

                // C·∫≠p nh·∫≠t UI
                document.getElementById('connect-status').textContent = 'CONNECTED';
                document.getElementById('connect-status').className = 'text-green-500 font-bold';
                document.getElementById('network-status').textContent = `Sepolia FHEVM (${ethers.toNumber(network.chainId)})`;
                document.getElementById('network-status').className = 'text-green-500 font-bold';
                document.getElementById('account-display').textContent = currentAccount;
                document.getElementById('account-info').classList.remove('hidden');
                document.getElementById('connectBtn').textContent = '> DISCONNECT WALLET';
                document.getElementById('connectBtn').onclick = disconnectWallet;
                document.getElementById('bidBtn').disabled = false;
                document.getElementById('claimRefundBtn').disabled = false;
                document.getElementById('batchRefundBtn').disabled = false;

                if (isOwner) {
                    document.getElementById('owner-panel').classList.remove('hidden');
                    document.getElementById('owner-info').classList.remove('hidden');
                    document.getElementById('requestFinalizeBtn').disabled = false;
                    document.getElementById('emergencyEndBtn').disabled = false;
                    document.getElementById('pauseBtn').disabled = false;
                    document.getElementById('unpauseBtn').disabled = false;
                    document.getElementById('updateBeneficiaryBtn').disabled = false;
                }

                logMessage(`K·∫øt n·ªëi th√†nh c√¥ng v·ªõi v√≠: ${currentAccount}`, 'success');
                
                // B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu ƒë·∫•u gi√° v√† l·∫Øng nghe s·ª± ki·ªán
                loadAuctionData();
                setupEventListeners();

            } catch (error) {
                logMessage(`L·ªói k·∫øt n·ªëi v√≠: ${error.message}`, 'error');
                // T·∫Øt tr·∫°ng th√°i owner n·∫øu c√≥ l·ªói
                document.getElementById('owner-panel').classList.add('hidden');
            }
        }

        function disconnectWallet() {
            provider = null;
            signer = null;
            contract = null;
            currentAccount = null;
            
            document.getElementById('connect-status').textContent = 'DISCONNECTED';
            document.getElementById('connect-status').className = 'text-red-500 font-bold';
            document.getElementById('account-info').classList.add('hidden');
            document.getElementById('owner-info').classList.add('hidden');
            document.getElementById('connectBtn').textContent = '> CONNECT WALLET';
            document.getElementById('connectBtn').onclick = connectWallet;
            document.getElementById('bidBtn').disabled = true;
            document.getElementById('claimRefundBtn').disabled = true;
            document.getElementById('batchRefundBtn').disabled = true;
            document.getElementById('owner-panel').classList.add('hidden');
            
            clearInterval(auctionInterval);
            logMessage('ƒê√£ ng·∫Øt k·∫øt n·ªëi v√≠.', 'info');
        }

        // =========================================================================
        // ======================== T·∫¢I V√Ä HI·ªÇN TH·ªä D·ªÆ LI·ªÜU ===========================
        // =========================================================================

        async function loadAuctionData() {
            if (!contract) return;

            try {
                const [
                    minBidWei,
                    endTime,
                    state,
                    round,
                    winnerAddress,
                    winningBidWei,
                    encryptedWinningBidBytes
                ] = await Promise.all([
                    contract.minBidDeposit(),
                    contract.auctionEndTime(),
                    contract.auctionState(),
                    contract.currentRound(),
                    contract.winner(),
                    contract.getDecryptedWinningBid().catch(() => 0n), // B·∫Øt l·ªói n·∫øu ch∆∞a gi·∫£i m√£
                    contract.getEncryptedWinningBid().catch(() => ethers.toUtf8Bytes("0x"))
                ]);
                
                // Tr·∫°ng th√°i ƒë·∫•u gi√°
                const stateText = AUCTION_STATES[ethers.toNumber(state)] || 'L·ªói';
                document.getElementById('auction-state').textContent = stateText;
                
                // Gi√° tr·ªã min bid
                const minBidEth = ethers.formatEther(minBidWei);
                document.getElementById('min-bid-deposit').textContent = `${minBidEth} ETH`;

                // V√≤ng
                document.getElementById('current-round').textContent = ethers.toNumber(round).toString();
                
                // Ng∆∞·ªùi th·∫Øng cu·ªôc v√† gi√°
                document.getElementById('winner-address').textContent = winnerAddress === ethers.ZeroAddress ? 'Ch∆∞a x√°c ƒë·ªãnh' : winnerAddress;
                
                if (ethers.toNumber(state) >= 2 && ethers.formatEther(winningBidWei) !== '0.0') {
                    // Tr·∫°ng th√°i Decrypted ho·∫∑c Finished
                    document.getElementById('winner-bid').textContent = `${ethers.formatEther(winningBidWei)} ETH`;
                    document.getElementById('winner-address').textContent = winnerAddress === ethers.ZeroAddress ? 'Kh√¥ng c√≥ ai th·∫Øng' : winnerAddress;
                } else if (ethers.toNumber(state) === 1 || ethers.toNumber(encryptedWinningBidBytes.length) > 2) {
                    // Tr·∫°ng th√°i Finalizing ho·∫∑c c√≥ gi√° ƒë√£ m√£ h√≥a
                    document.getElementById('winner-bid').textContent = 'ƒêang gi·∫£i m√£...';
                } else {
                    document.getElementById('winner-bid').textContent = 'N/A (Ch∆∞a k·∫øt th√∫c)';
                }

                // C·∫≠p nh·∫≠t Countdown
                clearInterval(auctionInterval);
                if (stateText === 'Active') {
                    auctionInterval = setInterval(() => updateCountdown(ethers.toNumber(endTime)), 1000);
                    updateCountdown(ethers.toNumber(endTime));
                } else {
                    document.getElementById('time-left').textContent = 'ƒê√£ k·∫øt th√∫c';
                }

            } catch (error) {
                logMessage(`L·ªói t·∫£i d·ªØ li·ªáu ƒë·∫•u gi√°: ${error.message}`, 'error');
            }
        }

        function updateCountdown(endTimeTimestamp) {
            const now = Math.floor(Date.now() / 1000);
            const timeLeft = endTimeTimestamp - now;

            if (timeLeft <= 0) {
                clearInterval(auctionInterval);
                document.getElementById('time-left').textContent = 'ƒê√É H·∫æT GI·ªú';
                // T·∫£i l·∫°i d·ªØ li·ªáu sau khi h·∫øt gi·ªù ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i
                setTimeout(loadAuctionData, 5000);
                return;
            }

            const days = Math.floor(timeLeft / (3600 * 24));
            const hours = Math.floor((timeLeft % (3600 * 24)) / 3600);
            const minutes = Math.floor((timeLeft % 3600) / 60);
            const seconds = Math.floor(timeLeft % 60);

            document.getElementById('time-left').textContent = 
                `${days.toString().padStart(2, '0')}D ${hours.toString().padStart(2, '0')}H ${minutes.toString().padStart(2, '0')}M ${seconds.toString().padStart(2, '0')}S`;
        }
        
        // =========================================================================
        // ============================ H√ÄM T∆Ø∆†NG T√ÅC CONTRACT ========================
        // =========================================================================

        // --- 1. ƒê·∫∂T GI√Å (BID) ---
        async function placeBid() {
            if (!contract || !signer) {
                logMessage('Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc.', 'error');
                return;
            }

            const bidInput = document.getElementById('bid-input');
            const bidEth = bidInput.value;

            if (isNaN(bidEth) || parseFloat(bidEth) <= 0) {
                logMessage('Vui l√≤ng nh·∫≠p gi√° th·∫ßu h·ª£p l·ªá.', 'error');
                return;
            }

            try {
                const bidWei = ethers.parseEther(bidEth);
                const minBidDeposit = await contract.minBidDeposit();
                
                // Ki·ªÉm tra ƒëi·ªÅu ki·ªán Deposit = BidValue >= MinBidDeposit
                if (bidWei < minBidDeposit) {
                    logMessage(`Gi√° th·∫ßu ph·∫£i l·ªõn h∆°n ho·∫∑c b·∫±ng Min Bid Deposit: ${ethers.formatEther(minBidDeposit)} ETH.`, 'error');
                    return;
                }

                // B∆Ø·ªöC FHE: M√£ h√≥a v√† t·∫°o Proof (S·ª≠ d·ª•ng h√†m mock)
                // Trong code th·ª±c t·∫ø, b·∫°n s·∫Ω d√πng fhe.js v√† relayer-sdk ·ªü ƒë√¢y.
                logMessage(`[FHE] B·∫Øt ƒë·∫ßu qu√° tr√¨nh M√£ h√≥a v√† T·∫°o Proof...`, 'info');
                
                // Gi·∫£ l·∫≠p FHE
                const { encryptedBid, proof } = mockFHE.encryptBid(bidWei);

                logMessage(`[FHE] M√£ h√≥a th√†nh c√¥ng. G·ª≠i giao d·ªãch...`, 'info');

                // T·∫Øt n√∫t ƒë·ªÉ tr√°nh double-click
                document.getElementById('bidBtn').disabled = true;
                
                // Th·ª±c hi·ªán giao d·ªãch bid: value PH·∫¢I B·∫∞NG bidWei
                const tx = await contract.bid(encryptedBid, proof, {
                    value: bidWei,
                    gasLimit: 600000 // TƒÉng gas limit cho c√°c giao d·ªãch FHE
                });

                logMessage(`Giao d·ªãch BID ƒëang ch·ªù x√°c nh·∫≠n: <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank" class="text-secondary hover:underline">${tx.hash.substring(0, 10)}...</a>`, 'info');
                
                const receipt = await tx.wait();
                
                logMessage(`BID th√†nh c√¥ng! S·ªë ti·ªÅn k√Ω qu·ªπ: ${bidEth} ETH.`, 'success');
                loadAuctionData();
                
            } catch (error) {
                logMessage(`L·ªói ƒë·∫∑t gi√°: ${error.reason || error.message}`, 'error');
            } finally {
                document.getElementById('bidBtn').disabled = false;
            }
        }

        // --- 2. Y√äU C·∫¶U K·∫æT TH√öC (REQUEST FINALIZE) - OWNER ONLY ---
        async function requestFinalize() {
            if (!contract || !auctionOwner || currentAccount.toLowerCase() !== auctionOwner.toLowerCase()) {
                logMessage('B·∫°n kh√¥ng ph·∫£i l√† Owner.', 'error');
                return;
            }

            try {
                if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën Y√äU C·∫¶U K·∫æT TH√öC? Thao t√°c n√†y s·∫Ω g·ª≠i y√™u c·∫ßu gi·∫£i m√£ t·ªõi KMS.')) return;
                
                const state = await contract.auctionState();
                if (ethers.toNumber(state) !== 0) { // State 0: Active
                    logMessage('ƒê·∫•u gi√° kh√¥ng ·ªü tr·∫°ng th√°i Active (ƒêang di·ªÖn ra).', 'error');
                    return;
                }

                document.getElementById('requestFinalizeBtn').disabled = true;

                const tx = await contract.requestFinalize();
                logMessage(`G·ª≠i REQUEST FINALIZE: <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank" class="text-secondary hover:underline">${tx.hash.substring(0, 10)}...</a>`, 'info');
                await tx.wait();

                logMessage('Y√™u c·∫ßu k·∫øt th√∫c ƒë√£ ƒë∆∞·ª£c g·ª≠i! ƒêang ch·ªù KMS gi·∫£i m√£...', 'success');
                loadAuctionData();

            } catch (error) {
                logMessage(`L·ªói Y√™u c·∫ßu K·∫øt th√∫c: ${error.reason || error.message}`, 'error');
            } finally {
                document.getElementById('requestFinalizeBtn').disabled = false;
            }
        }
        
        // --- 3. CLAIM REFUND ---
        async function claimRefund() {
            if (!contract || !signer) {
                logMessage('Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc.', 'error');
                return;
            }

            try {
                document.getElementById('claimRefundBtn').disabled = true;

                const hasClaimed = await contract.hasClaimedRefund(currentAccount);
                const state = await contract.auctionState();

                if (ethers.toNumber(state) < 3) {
                    logMessage('ƒê·∫•u gi√° ch∆∞a ·ªü tr·∫°ng th√°i Finished (Ho√†n th√†nh) ƒë·ªÉ r√∫t ti·ªÅn.', 'error');
                    return;
                }

                if (hasClaimed) {
                    logMessage('B·∫°n ƒë√£ r√∫t ti·ªÅn ho√†n l·∫°i r·ªìi.', 'info');
                    return;
                }

                const tx = await contract.claimRefund();
                logMessage(`G·ª≠i CLAIM REFUND: <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank" class="text-secondary hover:underline">${tx.hash.substring(0, 10)}...</a>`, 'info');
                await tx.wait();

                logMessage('Ho√†n ti·ªÅn th√†nh c√¥ng! S·ªë ETH ƒë√£ ƒë∆∞·ª£c g·ª≠i v·ªÅ v√≠ c·ªßa b·∫°n.', 'success');
                loadAuctionData();
                
            } catch (error) {
                logMessage(`L·ªói Ho√†n ti·ªÅn: ${error.reason || error.message}`, 'error');
            } finally {
                document.getElementById('claimRefundBtn').disabled = false;
            }
        }

        // --- 4. BATCH CLAIM REFUNDS ---
        async function batchClaimRefunds() {
            if (!contract || !signer) {
                logMessage('Vui l√≤ng k·∫øt n·ªëi v√≠ tr∆∞·ªõc.', 'error');
                return;
            }

            const addressesInput = document.getElementById('batch-addresses-input').value;
            const addresses = addressesInput.split(',').map(addr => addr.trim()).filter(addr => ethers.isAddress(addr));
            
            if (addresses.length === 0) {
                logMessage('Vui l√≤ng nh·∫≠p c√°c ƒë·ªãa ch·ªâ v√≠ h·ª£p l·ªá.', 'error');
                return;
            }

            try {
                document.getElementById('batchRefundBtn').disabled = true;

                const tx = await contract.batchClaimRefunds(addresses);
                logMessage(`G·ª≠i BATCH REFUND cho ${addresses.length} v√≠: <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank" class="text-secondary hover:underline">${tx.hash.substring(0, 10)}...</a>`, 'info');
                await tx.wait();

                logMessage(`Batch Refund th√†nh c√¥ng cho ${addresses.length} v√≠.`, 'success');
                
            } catch (error) {
                logMessage(`L·ªói Batch Refund: ${error.reason || error.message}`, 'error');
            } finally {
                document.getElementById('batchRefundBtn').disabled = false;
            }
        }

        // C√°c h√†m OWNER kh√°c (pauseAuction, unpauseAuction, emergencyEnd, updateBeneficiary)
        // ... (Logic t∆∞∆°ng t·ª± nh∆∞ claimRefund, ch·ªâ c·∫ßn thay ƒë·ªïi t√™n h√†m contract)
        // T√¥i s·∫Ω th√™m ch√∫ng ƒë·ªÉ ho√†n thi·ªán ch·ª©c nƒÉng UI:

        async function pauseAuction() {
            if (!contract || currentAccount.toLowerCase() !== auctionOwner.toLowerCase()) return;
            try {
                const tx = await contract.pauseAuction();
                logMessage(`G·ª≠i PAUSE AUCTION: ${tx.hash.substring(0, 10)}...`, 'info');
                await tx.wait();
                logMessage('ƒê·∫•u gi√° ƒë√£ t·∫°m d·ª´ng!', 'success');
                document.getElementById('pauseBtn').style.display = 'none';
                document.getElementById('unpauseBtn').style.display = 'block';
                loadAuctionData();
            } catch (error) { logMessage(`L·ªói Pause: ${error.reason || error.message}`, 'error'); }
        }

        async function unpauseAuction() {
            if (!contract || currentAccount.toLowerCase() !== auctionOwner.toLowerCase()) return;
            try {
                const tx = await contract.unpauseAuction();
                logMessage(`G·ª≠i UNPAUSE AUCTION: ${tx.hash.substring(0, 10)}...`, 'info');
                await tx.wait();
                logMessage('ƒê·∫•u gi√° ƒë√£ kh·ªüi ƒë·ªông l·∫°i!', 'success');
                document.getElementById('pauseBtn').style.display = 'block';
                document.getElementById('unpauseBtn').style.display = 'none';
                loadAuctionData();
            } catch (error) { logMessage(`L·ªói Unpause: ${error.reason || error.message}`, 'error'); }
        }
        
        async function emergencyEnd() {
            if (!contract || currentAccount.toLowerCase() !== auctionOwner.toLowerCase()) return;
            try {
                if (!confirm('X√ÅC NH·∫¨N: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën K·∫æT TH√öC KH·∫®N C·∫§P?')) return;
                const tx = await contract.emergencyEnd();
                logMessage(`G·ª≠i EMERGENCY END: ${tx.hash.substring(0, 10)}...`, 'info');
                await tx.wait();
                logMessage('ƒê·∫•u gi√° ƒë√£ k·∫øt th√∫c kh·∫©n c·∫•p!', 'success');
                loadAuctionData();
            } catch (error) { logMessage(`L·ªói Emergency End: ${error.reason || error.message}`, 'error'); }
        }

        async function updateBeneficiary() {
            if (!contract || currentAccount.toLowerCase() !== auctionOwner.toLowerCase()) return;
            const newBeneficiary = document.getElementById('newBeneficiaryInput').value;
            if (!ethers.isAddress(newBeneficiary)) {
                logMessage('ƒê·ªãa ch·ªâ ng∆∞·ªùi th·ª• h∆∞·ªüng kh√¥ng h·ª£p l·ªá.', 'error');
                return;
            }
            try {
                const tx = await contract.updateBeneficiary(newBeneficiary);
                logMessage(`G·ª≠i UPDATE BENEFICIARY: ${tx.hash.substring(0, 10)}...`, 'info');
                await tx.wait();
                logMessage(`ƒê√£ c·∫≠p nh·∫≠t Ng∆∞·ªùi th·ª• h∆∞·ªüng th√†nh: ${newBeneficiary}`, 'success');
            } catch (error) { logMessage(`L·ªói Update Beneficiary: ${error.reason || error.message}`, 'error'); }
        }

        // =========================================================================
        // ============================ B·ªò L·∫ÆNG NGHE S·ª∞ KI·ªÜN ===========================
        // =========================================================================
        
        function setupEventListeners() {
            if (contract.listenerCount("NewBid") > 0) return; // Tr√°nh l·∫Øng nghe nhi·ªÅu l·∫ßn

            // L·∫Øng nghe c√°c s·ª± ki·ªán c·ªßa contract
            contract.on("NewBid", (bidder, encryptedBid, event) => {
                logMessage(`[EVENT] Gi√° th·∫ßu m·ªõi t·ª´ ${bidder.substring(0, 8)}... (${encryptedBid.length} bytes m√£ h√≥a)`, 'confirmed');
                loadAuctionData(); // C·∫≠p nh·∫≠t tr·∫°ng th√°i ngay l·∫≠p t·ª©c
            });
            
            contract.on("RefundClaimed", (recipient, amount, event) => {
                logMessage(`[EVENT] Ho√†n ti·ªÅn th√†nh c√¥ng cho ${recipient.substring(0, 8)}...: ${ethers.formatEther(amount)} ETH`, 'confirmed');
                if (recipient.toLowerCase() === currentAccount.toLowerCase()) {
                    // C·∫≠p nh·∫≠t UI c·ªßa ng∆∞·ªùi d√πng n·∫øu h·ªç r√∫t ti·ªÅn
                    loadAuctionData();
                }
            });

            contract.on("AuctionFinalized", (winner, bid, event) => {
                logMessage(`[EVENT] ƒê·∫§U GI√Å K·∫æT TH√öC! Ng∆∞·ªùi th·∫Øng: ${winner.substring(0, 8)}... v·ªõi gi√°: ${ethers.formatEther(bid)} ETH`, 'success');
                loadAuctionData();
            });

            // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi m·∫°ng/t√†i kho·∫£n c·ªßa MetaMask
            window.ethereum.on('accountsChanged', () => window.location.reload());
            window.ethereum.on('chainChanged', () => window.location.reload());
        }

        // =========================================================================
        // ============================== KH·ªûI T·∫†O CHUNG ===============================
        // =========================================================================
        window.addEventListener('DOMContentLoaded', () => {
            // Thi·∫øt l·∫≠p link Etherscan
            document.getElementById('contract-link').href = `https://sepolia.etherscan.io/address/${CONTRACT_ADDRESS}`;
            document.getElementById('contract-link').textContent = CONTRACT_ADDRESS;

            // G√°n h√†m v√†o n√∫t
            document.getElementById('connectBtn').addEventListener('click', connectWallet);
            document.getElementById('bidBtn').addEventListener('click', placeBid);
            document.getElementById('claimRefundBtn').addEventListener('click', claimRefund);
            document.getElementById('batchRefundBtn').addEventListener('click', batchClaimRefunds);
            
            // G√°n h√†m Owner
            document.getElementById('requestFinalizeBtn').addEventListener('click', requestFinalize);
            document.getElementById('emergencyEndBtn').addEventListener('click', emergencyEnd);
            document.getElementById('pauseBtn').addEventListener('click', pauseAuction);
            document.getElementById('unpauseBtn').addEventListener('click', unpauseAuction);
            document.getElementById('updateBeneficiaryBtn').addEventListener('click', updateBeneficiary);

            logMessage('[INIT] Giao di·ªán FHE Auction v1.0 ƒë√£ t·∫£i', 'confirmed');
            
            // T·∫£i d·ªØ li·ªáu l·∫ßn ƒë·∫ßu (n·∫øu ng∆∞·ªùi d√πng ƒë√£ k·∫øt n·ªëi v√≠ tr∆∞·ªõc ƒë√≥)
            if (window.ethereum && window.ethereum.selectedAddress) {
                connectWallet();
            }
        });
    </script>
</body>
</html>
