<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zama Relayer Bid Tester</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cấu hình Font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
    <!-- Tải ethers.js với CDN đáng tin cậy -->
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <!-- Tải Zama Relayer SDK qua ESM CDN -->
    <script type="module" src="https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js"></script>

    <!-- Tải các thư viện Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {
            initSDK,
            createInstance,
            SepoliaConfig,
        } from 'https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js';

        // Biến toàn cục từ Canvas (BẮT BUỘC SỬ DỤNG) - Thêm dummy config nếu thiếu
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Dummy Firebase config cho testing (thay thế bằng config thực tế của bạn)
        if (!firebaseConfig) {
            firebaseConfig = {
                apiKey: "dummy-api-key",
                authDomain: "dummy-project.firebaseapp.com",
                projectId: "dummy-project",
                storageBucket: "dummy-project.appspot.com",
                messagingSenderId: "123456789",
                appId: "dummy-app-id"
            };
            console.warn("Using dummy Firebase config for testing. Replace with real config.");
        }

        // --- CẤU HÌNH HỢP ĐỒNG CỦA BẠN ---
        const CONTRACT_ADDRESS = '0xf885102A2aC3eF23744DEFb89ce71aD2b458E0Ab';
        // ABI ĐÚNG CHO FHEAUCTION: bid(externalEuint64 encryptedBid, bytes inputProof, bytes32 publicKey, bytes signature) payable
        // externalEuint64 là bytes32
        const CONTRACT_ABI = [
            "function bid(bytes32 encryptedBid, bytes inputProof, bytes32 publicKey, bytes signature) payable",
            "function getAuctionInfo() view returns (uint256 round, uint256 endBlock, uint256 state, uint256 maxDeposit, address leadBidder, uint256 validBidders)",
            "function eip712Domain() view returns (bytes1 fields, string name, string version, uint256 chainId, address verifyingContract, bytes32 salt, uint256[] extensions)"
        ];

        let app, db, auth;
        let provider, signer, contract, instance; 
        let userWalletAddress = null;
        let isRelayerConnected = false;
        let isAuthReady = false;
        
        // Khởi tạo Firebase và xác thực người dùng
        const initFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                // Tiếp tục mà không có Firebase để tránh block
                isAuthReady = true;
                setupBidHistoryListener('anonymous');
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthReady = true;
                        setupBidHistoryListener(user.uid);
                    } else {
                        isAuthReady = true;
                        setupBidHistoryListener(crypto.randomUUID());
                    }
                });
            } catch (error) {
                console.error("Error during Firebase initialization or authentication:", error);
                isAuthReady = true;
                setupBidHistoryListener('anonymous');
            }
        };

        // Bắt đầu lắng nghe lịch sử Bid
        const setupBidHistoryListener = (userId) => {
            if (!db) {
                console.warn("Firestore not available, skipping bid history.");
                return;
            }
            const bidsRef = collection(db, 'artifacts', appId, 'users', userId, 'bids');
            const q = query(bidsRef, limit(10));

            onSnapshot(q, (snapshot) => {
                let bids = [];
                snapshot.forEach(doc => {
                    bids.push({ id: doc.id, ...doc.data() });
                });
                
                bids.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                updateBidHistory(bids);
            }, (error) => {
                console.error("Error listening to bid history:", error);
            });
        };

        // Hàm cập nhật giao diện lịch sử Bid
        const updateBidHistory = (bids) => {
            const historyContainer = document.getElementById('bid-history');
            historyContainer.innerHTML = ''; 

            if (bids.length === 0) {
                historyContainer.innerHTML = '<p class="text-gray-500 italic text-center py-4">Chưa có bid nào được ghi lại.</p>';
                return;
            }

            bids.forEach(bid => {
                const item = document.createElement('div');
                item.className = 'p-3 bg-white/5 rounded-lg border border-white/10 mb-2 shadow-md transition duration-300 ease-in-out hover:bg-white/10';
                
                const date = new Date(bid.createdAt);
                const timeString = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;

                let statusColor = 'text-green-400';
                if (bid.status === 'Thất bại') statusColor = 'text-red-400';
                if (bid.status === 'Đang xử lý') statusColor = 'text-yellow-400';
                
                item.innerHTML = `
                    <p class="text-sm text-gray-400 mb-1">
                        <span class="font-semibold text-white">ID Bid:</span> ${bid.id.substring(0, 8)}...
                    </p>
                    <p class="text-sm">
                        <span class="font-semibold text-white">Số tiền:</span> ${bid.amount} USD
                    </p>
                    <p class="text-sm">
                        <span class="font-semibold text-white">Target:</span> ${bid.targetId || 'N/A'}
                    </p>
                    <p class="text-sm">
                        <span class="font-semibold text-white">Thời gian:</span> ${timeString}
                    </p>
                    <p class="text-sm">
                        <span class="font-semibold text-white">Trạng thái:</span> <span class="${statusColor} font-medium">${bid.status}</span>
                    </p>
                    <p class="text-xs text-gray-500 mt-1 truncate">
                        Hash/ID Giao Dịch: ${bid.transactionHash || bid.mockTransactionHash || 'N/A'}
                    </p>
                `;
                historyContainer.appendChild(item);
            });
        };

        // Hàm cập nhật thông báo trạng thái
        const updateStatus = (message, type = 'info') => {
            const statusBox = document.getElementById('status-box');
            let color = 'bg-blue-100 text-blue-800';
            if (type === 'success') color = 'bg-green-100 text-green-800';
            if (type === 'error') color = 'bg-red-100 text-red-800';

            statusBox.innerHTML = `
                <div class="p-3 rounded-xl ${color} transition duration-500 ease-in-out transform shadow-lg" role="alert">
                    <p class="font-medium">${message}</p>
                </div>
            `;
        };

        // --- HÀM KẾT NỐI VÍ (WALLET) ---
        window.connectWallet = async () => {
            if (userWalletAddress) {
                updateStatus("Ví đã kết nối: " + userWalletAddress, 'success');
                return;
            }
            if (typeof window.ethereum === 'undefined') {
                updateStatus("Vui lòng cài đặt MetaMask hoặc ví tương thích.", 'error');
                return;
            }
            if (typeof ethers === 'undefined') {
                updateStatus("Ethers.js chưa tải. Kiểm tra kết nối mạng.", 'error');
                return;
            }

            try {
                updateStatus("Đang kết nối ví...");
                
                await window.ethereum.request({ method: 'eth_requestAccounts' });

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userWalletAddress = await signer.getAddress();
                
                // Khởi tạo Contract Object
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                document.getElementById('wallet-status').textContent = `Đã Kết Nối: ${userWalletAddress.substring(0, 6)}...${userWalletAddress.slice(-4)}`;
                document.getElementById('connect-wallet-btn').classList.replace('bg-indigo-600', 'bg-green-600');
                document.getElementById('connect-wallet-btn').classList.add('opacity-70');
                document.getElementById('connect-wallet-btn').disabled = true;

                updateStatus(`Kết nối ví thành công! Địa chỉ hợp đồng: ${CONTRACT_ADDRESS.substring(0, 6)}...`, 'success');

                // Bật tính năng Relayer và Bid
                document.getElementById('relayer-connection-card').classList.remove('opacity-50', 'pointer-events-none');
                
            } catch (error) {
                console.error(error);
                updateStatus(`Lỗi kết nối ví: ${error.message || 'Người dùng đã từ chối.'}`, 'error');
                userWalletAddress = null;
            }
        };

        // --- HÀM KẾT NỐI RELAYER ZAMA (THỰC TẾ) ---
        window.connectZamaRelayer = async () => {
            if (!userWalletAddress || !window.ethereum) {
                updateStatus("Vui lòng kết nối ví trước.", 'error');
                return;
            }
            if (isRelayerConnected) return;

            try {
                updateStatus("Đang thiết lập kết nối Relayer Zama và tải WASM...");

                // TÍCH HỢP ZAMA SDK THỰC TẾ
                // 1. KHỞI TẠO SDK: Tải WASM
                await initSDK();
                
                // 2. TẠO INSTANCE VỚI CONFIG SEPOLIA - Sử dụng window.ethereum như docs
                let config = { ...SepoliaConfig, network: window.ethereum };
                config.network = window.ethereum;
                instance = await createInstance(config);
                
                // KẾT THÚC TÍCH HỢP ZAMA SDK

                isRelayerConnected = true;
                document.getElementById('relayer-status').textContent = `Đã Kết Nối (FHE-Ready)`;
                document.getElementById('connect-relayer-btn').classList.replace('bg-indigo-600', 'bg-green-600');
                document.getElementById('connect-relayer-btn').classList.add('opacity-70');
                document.getElementById('connect-relayer-btn').disabled = true;

                updateStatus("Kết nối Relayer Zama thành công! SDK đã sẵn sàng cho mã hóa FHE.", 'success');
                
                // Bật form đặt bid
                document.getElementById('bid-form-card').classList.remove('opacity-50', 'pointer-events-none');


            } catch (error) {
                console.error("Zama Relayer connection error:", error);
                updateStatus(`Lỗi kết nối Relayer Zama: ${error.message || 'Lỗi không xác định.'}`, 'error');
                isRelayerConnected = false;
            }
        };

        // --- HÀM ĐẶT BID (TÍCH HỢP ZAMA) ---
        window.placeBid = async (event) => {
            event.preventDefault();
            
            if (!isRelayerConnected || !contract || !instance) {
                updateStatus("Vui lòng kết nối Ví và Relayer Zama trước.", 'error');
                return;
            }

            const amount = document.getElementById('bid-amount').value;
            const target = document.getElementById('bid-target').value;
            const floatAmount = parseFloat(amount);

            if (!amount || isNaN(floatAmount) || floatAmount <= 0 || !target) {
                updateStatus("Vui lòng nhập số tiền bid hợp lệ và Target ID.", 'error');
                return;
            }

            try {
                const bidBtn = document.getElementById('place-bid-btn');
                bidBtn.textContent = 'Đang Mã Hóa FHE & Gửi Tx...';
                bidBtn.disabled = true;
                bidBtn.classList.replace('bg-indigo-600', 'bg-yellow-600');

                updateStatus(`Đang mã hóa FHE và gửi bid ${amount} ETH cho Target ${target}...`, 'info');

                // TÍCH HỢP ZAMA SDK THỰC TẾ
                
                // 1. TẠO BUFFER VÀ THÊM GIÁ TRỊ (Mã hóa số tiền dưới dạng u64, đơn vị wei)
                const buffer = instance.createEncryptedInput(CONTRACT_ADDRESS, userWalletAddress);
                const amountInWei = ethers.parseEther(amount.toString()); // Giả định amount là ETH
                buffer.add64(amountInWei); // u64 cho externalEuint64
                
                // 2. MÃ HÓA VÀ UPLOAD QUA RELAYER (Trả về handles bytes32[] và inputProof bytes)
                const encryptedInput = await buffer.encrypt();
                const encryptedBid = encryptedInput.handles[0]; // bytes32 handle cho externalEuint64
                const inputProof = encryptedInput.inputProof; // bytes ZK proof
                
                // 3. CHUẨN BỊ EIP712 SIGNATURE CHO PUBLICKEY (là encryptedBid handle)
                const network = await provider.getNetwork();
                const domain = {
                    name: 'FHEAuction',
                    version: '3',
                    chainId: network.chainId,
                    verifyingContract: CONTRACT_ADDRESS,
                };
                const types = {
                    PublicKey: [
                        { name: 'key', type: 'bytes32' }
                    ]
                };
                const value = {
                    key: encryptedBid
                };
                const signature = await signer._signTypedData(domain, types, value);

                // 4. GỬI GIAO DỊCH ĐẾN CONTRACT bid(encryptedBid, inputProof, encryptedBid, signature) với value deposit
                const txResponse = await contract.bid(encryptedBid, inputProof, encryptedBid, signature, {
                    value: amountInWei // Gửi deposit = bid amount (giả định)
                });
                const receipt = await txResponse.wait();
                const txHash = txResponse.hash;

                // KẾT THÚC TÍCH HỢP ZAMA SDK

                // --- LƯU LẠI BID VÀO FIRESTORE ---
                const bidData = {
                    amount: floatAmount,
                    targetId: target,
                    userAddress: userWalletAddress,
                    transactionHash: txHash,
                    status: 'Thành công',
                    createdAt: Date.now(),
                    userId: auth?.currentUser?.uid || 'anonymous'
                };

                if (db) {
                    const userColPath = `artifacts/${appId}/users/${bidData.userId}/bids`;
                    await addDoc(collection(db, userColPath), bidData);
                }

                updateStatus(`Đặt bid thành công! Hash Giao Dịch: ${txHash.substring(0, 10)}...`, 'success');
                
            } catch (error) {
                console.error("Bid placement error:", error);
                updateStatus(`Đặt bid thất bại. Lỗi: ${error.message || 'Lỗi không xác định.'}`, 'error');
            } finally {
                const bidBtn = document.getElementById('place-bid-btn');
                bidBtn.textContent = 'Đặt Bid';
                bidBtn.disabled = false;
                bidBtn.classList.replace('bg-yellow-600', 'bg-indigo-600');
            }
        };
        
        // Khởi tạo Firebase khi cửa sổ tải xong
        window.onload = initFirebase;
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-extrabold text-center mb-6 text-indigo-400">
            Zama FHE Relayer Bid Tester
        </h1>
        <p class="text-center text-gray-400 mb-8">
            Hợp đồng: <span class="text-indigo-400 font-mono">${CONTRACT_ADDRESS}</span>
            <br>
            Tích hợp FHEVM Relayer SDK cho FHEAuction. Số tiền bid (ETH) được mã hóa dưới dạng u64 (wei) và gửi handle bytes32 + proof + signature đến bid().
            <br><strong>Cập nhật:</strong> Sửa ABI và logic bid với EIP712 signature cho publicKey (handle). Deposit = bid amount (test).
        </p>

        <!-- Hộp Thông Báo Trạng Thái -->
        <div id="status-box" class="mb-8 min-h-[4rem]">
            <div class="p-3 rounded-xl bg-gray-700 text-gray-300 shadow-lg" role="alert">
                <p class="font-medium">Chờ kết nối ví và relayer để bắt đầu.</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
            
            <!-- STEP 1: KẾT NỐI VÍ -->
            <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-indigo-500/50 flex flex-col justify-between">
                <div>
                    <h2 class="text-xl font-bold mb-3 text-indigo-300">1. Kết Nối Ví (Ethers)</h2>
                    <p class="text-sm text-gray-400 mb-4">Lấy `signer` để ký dữ liệu FHE.</p>
                    <p id="wallet-status" class="text-xs text-gray-500 mb-4 font-mono truncate">Chưa Kết Nối</p>
                </div>
                <button id="connect-wallet-btn" onclick="connectWallet()" 
                        class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 rounded-xl font-semibold transition duration-300 ease-in-out shadow-lg transform hover:scale-[1.02] active:scale-100">
                    Kết Nối Ví
                </button>
            </div>

            <!-- STEP 2: KẾT NỐI RELAYER (ZAMA SDK) -->
            <div id="relayer-connection-card" class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-indigo-500/50 opacity-50 pointer-events-none flex flex-col justify-between">
                <div>
                    <h2 class="text-xl font-bold mb-3 text-indigo-300">2. Khởi Tạo Zama Relayer</h2>
                    <p class="text-sm text-gray-400 mb-4">Tải WASM và tạo instance cho Sepolia.</p>
                    <p id="relayer-status" class="text-xs text-gray-500 mb-4 font-mono">Chưa Kết Nối</p>
                </div>
                <button id="connect-relayer-btn" onclick="connectZamaRelayer()" 
                        class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 rounded-xl font-semibold transition duration-300 ease-in-out shadow-lg transform hover:scale-[1.02] active:scale-100">
                    Khởi Tạo Zama Relayer
                </button>
            </div>

            <!-- STEP 3: ĐẶT BID (GỬI FHE TRANSACTION) -->
            <div id="bid-form-card" class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-indigo-500/50 opacity-50 pointer-events-none">
                <h2 class="text-xl font-bold mb-4 text-indigo-300">3. Đặt Bid (Gửi FHE)</h2>
                <form onsubmit="placeBid(event)">
                    <div class="mb-4">
                        <label for="bid-amount" class="block text-sm font-medium text-gray-300 mb-1">Số tiền Bid (ETH) - Sẽ được Mã hóa FHE (min 0.01)</label>
                        <input type="number" id="bid-amount" name="bid-amount" min="0.01" step="0.01" placeholder="0.01" required
                               class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white">
                    </div>
                    <div class="mb-6">
                        <label for="bid-target" class="block text-sm font-medium text-gray-300 mb-1">Target ID / Data (ghi chú)</label>
                        <input type="text" id="bid-target" name="bid-target" placeholder="Target Asset ID (ví dụ: TGT-001)" required
                               class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white">
                    </div>
                    <button id="place-bid-btn" type="submit"
                            class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 rounded-xl font-semibold transition duration-300 ease-in-out shadow-lg transform hover:scale-[1.02] active:scale-100">
                        Đặt Bid
                    </button>
                </form>
            </div>
        </div>

        <!-- LỊCH SỬ BID -->
        <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl border border-gray-700">
            <h2 class="text-2xl font-bold mb-4 text-white">Lịch Sử Bid</h2>
            <div id="bid-history" class="space-y-3">
                <p class="text-gray-500 italic text-center py-4">Đang tải lịch sử...</p>
            </div>
        </div>
    </div>

</body>
</html>
