<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHE Auction v0.9.1 - ƒê·∫•u Gi√° B·∫£o M·∫≠t Ho√†n To√†n</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'VT323', monospace; background: linear-gradient(135deg, #000000 0%, #0a0a0a 100%); color: #00ff00; min-height: 100vh; padding: 20px; font-size: 18px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 40px; animation: fadeIn 1s ease-out; }
        h1 { font-size: 3em; margin-bottom: 10px; text-shadow: 0 0 10px #00ff00, 0 0 20px rgba(0, 255, 0, 0.8); }
        .subtitle { font-size: 1.2em; opacity: 0.9; color: #ffff00; }
        .version-badge { display: inline-block; background: #00ff00; color: #000; padding: 5px 10px; font-size: 0.7em; margin-left: 10px; border-radius: 3px; }
        
        .main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .card { background: rgba(0, 0, 0, 0.8); border: 2px solid #00ff00; padding: 25px; box-shadow: 0 0 20px rgba(0, 255, 0, 0.3); animation: fadeInUp 0.8s ease-out; backdrop-filter: blur(10px); }
        .card h2 { margin-bottom: 20px; font-size: 1.6em; color: #ffff00; border-bottom: 2px dashed #00ff00; padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        
        input, select { width: 100%; padding: 12px; border: 1px solid #00ff00; background: #000; color: #00ff00; font-size: 1em; font-family: 'VT323', monospace; margin-bottom: 15px; caret-color: #ffff00; box-shadow: 0 0 5px rgba(0, 255, 0, 0.2); transition: all 0.2s; }
        input:focus, select:focus { outline: none; border-color: #ffff00; box-shadow: 0 0 8px #ffff00; }
        
        button { background: #000; border: 2px solid #00ff00; padding: 12px 20px; color: #00ff00; font-size: 1.1em; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; transition: all 0.3s ease; font-family: 'VT323', monospace; letter-spacing: 1px; text-transform: uppercase; position: relative; overflow: hidden; }
        button:hover:not(:disabled) { background: #00ff00; color: #000000; box-shadow: 0 0 20px #00ff00; transform: translateY(-2px); }
        button:active:not(:disabled) { transform: translateY(0); }
        button:disabled { opacity: 0.4; cursor: not-allowed; background: #000; color: #00ff00; box-shadow: none; }
        
        .btn-danger { border-color: #ff0000; color: #ff0000; }
        .btn-danger:hover:not(:disabled) { background: #ff0000; color: #fff; box-shadow: 0 0 20px #ff0000; }
        
        .btn-warning { border-color: #ffaa00; color: #ffaa00; }
        .btn-warning:hover:not(:disabled) { background: #ffaa00; color: #000; box-shadow: 0 0 20px #ffaa00; }
        
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .info-item { background: rgba(10, 10, 10, 0.9); padding: 15px; border: 1px solid #00ff00; text-align: center; transition: all 0.3s; }
        .info-item:hover { border-color: #ffff00; box-shadow: 0 0 10px rgba(255, 255, 0, 0.3); }
        .info-label { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
        .info-value { font-size: 1.5em; font-weight: bold; color: #ffff00; word-break: break-all; }
        
        .wallet-status { padding: 15px; background: rgba(10, 10, 10, 0.9); border: 1px dashed #00ff00; margin-bottom: 20px; }
        
        .state-badge { display: inline-block; padding: 5px 12px; border-radius: 3px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        .state-active { background: #00ff00; color: #000; }
        .state-ended { background: #ff0000; color: #fff; }
        .state-finalizing { background: #ffaa00; color: #000; }
        .state-finalized { background: #0088ff; color: #fff; }
        .state-emergency { background: #ff0000; color: #fff; animation: pulse 1s infinite; }
        
        .fhe-badge { display: inline-block; background: #00ff00; color: #000; padding: 3px 8px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; margin-left: 10px; border-radius: 3px; }
        
        .encrypted-indicator { display: flex; align-items: center; gap: 10px; background: rgba(17, 17, 17, 0.8); padding: 10px; border: 1px solid #00ff00; margin-top: 10px; border-radius: 3px; font-size: 0.9em; }
        .encrypted-indicator::before { content: "üîí"; font-size: 1.2em; filter: drop-shadow(0 0 3px #00ff00); }
        
        .tx-monitor { grid-column: 1 / -1; }
        .tx-container { height: 350px; background: rgba(10, 10, 10, 0.9); border: 1px solid #00ff00; overflow-y: auto; padding: 15px; line-height: 1.6; white-space: pre-wrap; position: relative; }
        .tx-container::-webkit-scrollbar { width: 8px; }
        .tx-container::-webkit-scrollbar-thumb { background: #00ff00; border-radius: 4px; }
        .tx-container::-webkit-scrollbar-track { background: #0a0a0a; }
        
        .log-line { opacity: 0; animation: fadeIn 0.5s ease-out forwards; padding: 4px 0; border-bottom: 1px solid rgba(0, 255, 0, 0.1); }
        .log-time { color: #ffff00; margin-right: 10px; font-weight: bold; }
        .log-info { color: #00ffff; }
        .log-pending { color: #ffaa00; }
        .log-confirmed { color: #00ff00; }
        .log-failed { color: #ff0000; }
        .log-warning { color: #ff8800; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; background: #000; border: 2px solid; box-shadow: 0 0 20px; animation: slideInRight 0.4s ease; z-index: 1000; font-family: 'VT323', monospace; max-width: 400px; }
        .notification.success { border-color: #00ff00; color: #00ff00; }
        .notification.error { border-color: #ff0000; color: #ff0000; }
        .notification.info { border-color: #ffff00; color: #ffff00; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .loading { display: inline-block; width: 1em; height: 1em; border: 0.15em solid rgba(0, 255, 0, 0.3); border-radius: 50%; border-top-color: #00ff00; animation: spin 1s linear infinite; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .bidders-list { max-height: 200px; overflow-y: auto; background: rgba(10, 10, 10, 0.9); border: 1px solid #00ff00; padding: 10px; margin-top: 10px; }
        .bidder-item { padding: 8px; border-bottom: 1px solid rgba(0, 255, 0, 0.2); display: flex; justify-content: space-between; align-items: center; }
        .bidder-item:last-child { border-bottom: none; }
        
        .refund-indicator { background: rgba(255, 170, 0, 0.1); border: 1px solid #ffaa00; padding: 10px; margin-top: 10px; border-radius: 3px; }
        
        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr; }
            h1 { font-size: 2em; }
            .info-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                üîê FHE AUCTION SYSTEM 
                <span class="version-badge">v0.9.1</span>
            </h1>
            <p class="subtitle">Blind Auction v·ªõi Fully Homomorphic Encryption - Sepolia FHEVM Testnet</p>
        </header>

        <div class="main-grid">
            <!-- Wallet Connection -->
            <div class="card">
                <h2>üîå WALLET & FHE SDK</h2>
                <div class="wallet-status" id="walletStatus">
                    <p class="log-line log-info">[STATUS] Wallet: DISCONNECTED</p>
                    <p class="log-line log-info">[NETWORK] Target: Sepolia (11155111)</p>
                    <p class="log-line log-pending" id="fheStatus">[FHE] SDK: Not initialized</p>
                    <p class="log-line log-pending" id="relayerStatus">[RELAYER] relayer.testnet.zama.cloud</p>
                </div>
                <button id="connectBtn">
                    &gt; CONNECT WALLET & INIT FHE SDK
                </button>
            </div>

            <!-- Auction Info -->
            <div class="card">
                <h2>üìä AUCTION STATUS <span class="state-badge state-active" id="stateBadge">LOADING</span></h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Current Round</div>
                        <div class="info-value" id="currentRound">--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Time Remaining</div>
                        <div class="info-value" id="timeLeft">--:--:--</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Min Deposit</div>
                        <div class="info-value" id="minDeposit">-- ETH</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Lead Deposit</div>
                        <div class="info-value" id="leadDeposit">-- ETH</div>
                    </div>
                    <div class="info-item" style="grid-column: 1 / -1;">
                        <div class="info-label">Current Leader</div>
                        <div class="info-value" id="leadBidder" style="font-size: 1.2em;">0x0000...</div>
                    </div>
                </div>
            </div>

            <!-- Place Bid -->
            <div class="card">
                <h2>üí∞ SUBMIT ENCRYPTED BID <span class="fhe-badge">FHE</span></h2>
                <label for="bidAmount" class="log-line">[INPUT] Bid Amount (Gwei):</label>
                <input 
                    type="number" 
                    id="bidAmount" 
                    placeholder="Amount in Gwei (euint64)" 
                    step="1"
                    min="0"
                >
                <label for="depositAmount" class="log-line">[INPUT] Deposit Amount (ETH):</label>
                <input 
                    type="number" 
                    id="depositAmount" 
                    placeholder="ETH to send (‚â• min deposit)" 
                    step="0.001"
                    min="0"
                >
                <div class="encrypted-indicator">
                    <span><strong>Relayer SDK:</strong> Bid encrypted client-side ‚Üí Input proof generated ‚Üí EIP-712 signature ‚Üí Submit to contract</span>
                </div>
                <button id="bidBtn" disabled>
                    &gt; ENCRYPT BID & SUBMIT
                </button>
                <div id="userBidInfo" style="display: none;">
                    <div class="refund-indicator">
                        <p><strong>Your Deposit:</strong> <span id="yourDeposit">0</span> ETH</p>
                        <p><strong>Pending Refund:</strong> <span id="yourRefund">0</span> ETH</p>
                    </div>
                </div>
            </div>

            <!-- Owner Controls -->
            <div class="card" id="ownerPanel" style="display: none;">
                <h2>‚öôÔ∏è OWNER CONTROLS <span class="fhe-badge">ADMIN</span></h2>
                
                <button id="requestFinalizeBtn" class="btn-warning" disabled>
                    &gt; REQUEST FINALIZE (Decrypt Bids)
                </button>
                
                <button id="pauseBtn" class="btn-warning">
                    &gt; PAUSE AUCTION
                </button>
                
                <button id="unpauseBtn" class="btn-warning" style="display: none;">
                    &gt; UNPAUSE AUCTION
                </button>
                
                <button id="emergencyEndBtn" class="btn-danger">
                    &gt; EMERGENCY END (24h after end)
                </button>
                
                <button id="forceFinalizeBtn" class="btn-danger" style="display: none;">
                    &gt; FORCE FINALIZE (if stuck)
                </button>
                
                <div style="margin-top: 15px;">
                    <label class="log-line">[ADMIN] New Beneficiary:</label>
                    <input type="text" id="newBeneficiary" placeholder="0x...">
                    <button id="updateBeneficiaryBtn" class="btn-warning">
                        &gt; UPDATE BENEFICIARY
                    </button>
                </div>
            </div>

            <!-- Refund System -->
            <div class="card">
                <h2>üí∏ REFUND SYSTEM</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Your Refund</div>
                        <div class="info-value" id="pendingRefund">0 ETH</div>
                    </div>
                </div>
                <button id="claimRefundBtn" disabled>
                    &gt; CLAIM YOUR REFUND
                </button>
                <div id="batchRefundSection" style="display: none; margin-top: 15px;">
                    <label class="log-line">[BATCH] Addresses (max 20):</label>
                    <input type="text" id="batchAddresses" placeholder="0x..., 0x..., 0x...">
                    <button id="batchRefundBtn" class="btn-warning">
                        &gt; BATCH CLAIM REFUNDS
                    </button>
                </div>
            </div>

            <!-- Current Bidders -->
            <div class="card">
                <h2>üë• ACTIVE BIDDERS (Round <span id="roundNum">--</span>)</h2>
                <p class="log-line log-info">Total Bidders: <span id="bidderCount">0</span> / 50</p>
                <div class="bidders-list" id="biddersList">
                    <p style="text-align: center; opacity: 0.5;">No bidders yet...</p>
                </div>
            </div>

            <!-- Transaction Monitor -->
            <div class="card tx-monitor">
                <h2>üì° LIVE TRANSACTION LOG <span class="fhe-badge">FHEVM</span></h2>
                <div class="tx-container" id="txContainer">
                    <p class="log-line log-info" style="animation-delay: 0.1s;"><span class="log-time">[00:00:00]</span> [INIT] FHE Auction v0.9.1 system online...</p>
                    <p class="log-line log-info" style="animation-delay: 0.2s;"><span class="log-time">[00:00:01]</span> [CONTRACT] 0xf1314dff22d14ae4a00e0ea0e05027c1abf985a5</p>
                    <p class="log-line log-info" style="animation-delay: 0.3s;"><span class="log-time">[00:00:02]</span> [GATEWAY] Predeployed at 0xa02Cda4Ca3a71D7C46997716F4283aa851C28812</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ethers.js -->
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <!-- Zama Relayer SDK -->
    <script type="module">
        import { initSDK, createInstance, SepoliaConfig } from 'https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js';
        
        // ========== CONFIGURATION ==========
        const CONTRACT_ADDRESS = '0xf1314dff22d14ae4a00e0ea0e05027c1abf985a5';
        const SEPOLIA_CHAIN_ID = 11155111;
        const SEPOLIA_RPC = 'https://eth-sepolia.public.blastapi.io';
        const RELAYER_URL = 'https://relayer.testnet.zama.cloud';
        
        // State variables
        let provider, signer, account;
        let fheAuctionContract;
        let fhevmInstance = null;
        let timerInterval;
        let isOwner = false;
        
        // Full ABI
        const FHE_AUCTION_ABI = [{"inputs":[{"internalType":"uint256","name":"_minDeposit","type":"uint256"},{"internalType":"address","name":"_pauserSet","type":"address"},{"internalType":"address","name":"_beneficiary","type":"address"},{"internalType":"address","name":"_gatewayContract","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"AuctionAlreadyFinalized","type":"error"},{"inputs":[],"name":"AuctionNotActive","type":"error"},{"inputs":[],"name":"AuctionStillActive","type":"error"},{"inputs":[],"name":"ContractPaused","type":"error"},{"inputs":[],"name":"DecryptionAlreadyPending","type":"error"},{"inputs":[],"name":"EmergencyDelayNotMet","type":"error"},{"inputs":[],"name":"InsufficientDeposit","type":"error"},{"inputs":[],"name":"InvalidAddress","type":"error"},{"inputs":[],"name":"InvalidAmount","type":"error"},{"inputs":[],"name":"InvalidDecryptionData","type":"error"},{"inputs":[],"name":"InvalidShortString","type":"error"},{"inputs":[],"name":"InvalidSignature","type":"error"},{"inputs":[],"name":"InvalidState","type":"error"},{"inputs":[],"name":"MaxBiddersReached","type":"error"},{"inputs":[],"name":"NoBidders","type":"error"},{"inputs":[],"name":"NoRefundAvailable","type":"error"},{"inputs":[],"name":"ReentrancyGuardReentrantCall","type":"error"},{"inputs":[{"internalType":"string","name":"str","type":"string"}],"name":"StringTooLong","type":"error"},{"inputs":[],"name":"TransferFailed","type":"error"},{"inputs":[],"name":"Unauthorized","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"bidder","type":"address"},{"indexed":true,"internalType":"uint256","name":"round","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"depositAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"BidReceived","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"round","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"finalBid","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"AuctionFinished","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"requestId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"bytes32[]","name":"handles","type":"bytes32[]"}],"name":"DecryptionRequested","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"requestID","type":"uint256"}],"name":"DecryptionFulfilled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RefundAvailable","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RefundClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"round","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundStarted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"round","type":"uint256"},{"indexed":false,"internalType":"string","name":"reason","type":"string"}],"name":"EmergencyActivated","type":"event"},{"anonymous":false,"inputs":[{"internalType":"enum FHEAuction.AuctionState","name":"from","type":"uint8"},{"internalType":"enum FHEAuction.AuctionState","name":"to","type":"uint8"}],"name":"StateChanged","type":"event"},{"inputs":[{"internalType":"externalEuint64","name":"encryptedBid","type":"bytes32"},{"internalType":"bytes","name":"inputProof","type":"bytes"},{"internalType":"bytes32","name":"publicKey","type":"bytes32"},{"internalType":"bytes","name":"signature","type":"bytes"}],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"requestFinalize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"claimRefund","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"claimants","type":"address[]"}],"name":"batchClaimRefunds","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"pauseAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpauseAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"reason","type":"string"}],"name":"emergencyEnd","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"forceFinalize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newBeneficiary","type":"address"}],"name":"updateBeneficiary","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getAuctionInfo","outputs":[{"internalType":"uint256","name":"round","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"enum FHEAuction.AuctionState","name":"state","type":"uint8"},{"internalType":"uint256","name":"maxDeposit","type":"uint256"},{"internalType":"address","name":"leadBidder","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"bidder","type":"address"}],"name":"getBidderInfo","outputs":[{"internalType":"uint256","name":"deposit","type":"uint256"},{"internalType":"bool","name":"hasBidded","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getRoundBidders","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pendingRefunds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minBidDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"auctionEndTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"auctionState","outputs":[{"internalType":"enum FHEAuction.AuctionState","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentRound","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentLeadBidder","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentLeadDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"}];
        
        // ========== UTILITY FUNCTIONS ==========
        function formatLogTime() {
            const d = new Date();
            return `[${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}:${d.getSeconds().toString().padStart(2, '0')}]`;
        }
        
        function logMessage(msg, type = 'info') {
            const container = document.getElementById('txContainer');
            const log = document.createElement('p');
            log.className = `log-line log-${type}`;
            log.innerHTML = `<span class="log-time">${formatLogTime()}</span> ${msg}`;
            container.insertBefore(log, container.firstChild);
            while (container.children.length > 100) container.removeChild(container.lastChild);
        }
        
        function showNotification(msg, type) {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = `[${type.toUpperCase()}] ${msg}`;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 5000);
        }
        
        // ========== FHE SDK INITIALIZATION ==========
        async function initFhevmSdk() {
            const fheStatus = document.getElementById('fheStatus');
            const relayerStatus = document.getElementById('relayerStatus');
            
            try {
                fheStatus.textContent = '[FHE] Loading SDK WASM...';
                fheStatus.className = 'log-line log-pending';
                logMessage('[SDK] Initializing Zama Relayer SDK v0.2.0...', 'info');
                
                // Step 1: Initialize SDK WASM
                await initSDK();
                fheStatus.textContent = '[FHE] SDK WASM initialized ‚úì';
                logMessage('[SDK] WASM modules loaded successfully', 'confirmed');
                
                // Step 2: Create FHE instance with Sepolia config
                fheStatus.textContent = '[FHE] Creating instance with Sepolia config...';
                relayerStatus.textContent = '[RELAYER] Connecting to relayer.testnet.zama.cloud...';
                relayerStatus.className = 'log-line log-pending';
                
                const config = {
                    ...SepoliaConfig,
                    network: SEPOLIA_RPC,
                    chainId: SEPOLIA_CHAIN_ID,
                    relayerUrl: RELAYER_URL
                };
                
                logMessage(`[CONFIG] ACL: ${config.aclContractAddress}`, 'info');
                logMessage(`[CONFIG] KMS: ${config.kmsContractAddress}`, 'info');
                logMessage(`[CONFIG] Relayer: ${RELAYER_URL}`, 'info');
                
                const instance = await createInstance(config);
                
                // Step 3: Verify instance is ready
                fheStatus.textContent = '[FHE] Public key loaded ‚úì';
                fheStatus.className = 'log-line log-confirmed';
                relayerStatus.textContent = '[RELAYER] Connected ‚úì';
                relayerStatus.className = 'log-line log-confirmed';
                
                logMessage('[FHE] Client-side encryption ready', 'confirmed');
                logMessage('[RELAYER] Connection established', 'confirmed');
                showNotification('FHE SDK initialized successfully!', 'success');
                
                return instance;
                
            } catch (error) {
                console.error('FHE SDK Error:', error);
                fheStatus.textContent = '[FHE] FAILED ‚úó';
                fheStatus.className = 'log-line log-failed';
                relayerStatus.textContent = '[RELAYER] FAILED ‚úó';
                relayerStatus.className = 'log-line log-failed';
                logMessage(`[ERROR] FHE SDK init failed: ${error.message}`, 'failed');
                showNotification('FHE SDK initialization failed', 'error');
                throw error;
            }
        }
        
        // ========== AUCTION STATE ==========
        async function loadAuctionState() {
            try {
                const info = await fheAuctionContract.getAuctionInfo();
                const minDep = await fheAuctionContract.minBidDeposit();
                const isPaused = await fheAuctionContract.paused();
                const contractOwner = await fheAuctionContract.owner();
                
                // Update round
                document.getElementById('currentRound').textContent = info.round.toString();
                document.getElementById('roundNum').textContent = info.round.toString();
                
                // Update min deposit
                document.getElementById('minDeposit').textContent = ethers.utils.formatEther(minDep) + ' ETH';
                
                // Update lead deposit
                document.getElementById('leadDeposit').textContent = ethers.utils.formatEther(info.maxDeposit) + ' ETH';
                
                // Update leader
                const leader = info.leadBidder;
                document.getElementById('leadBidder').textContent = 
                    leader === ethers.constants.AddressZero ? '0x0000...' : 
                    leader.substring(0, 6) + '...' + leader.substring(38);
                
                // Update state badge
                const stateNames = ['Active', 'Ended', 'Finalizing', 'Finalized', 'Emergency'];
                const stateClasses = ['state-active', 'state-ended', 'state-finalizing', 'state-finalized', 'state-emergency'];
                const badge = document.getElementById('stateBadge');
                badge.textContent = stateNames[info.state];
                badge.className = 'state-badge ' + stateClasses[info.state];
                
                // Check if user is owner
                isOwner = account && contractOwner.toLowerCase() === account.toLowerCase();
                if (isOwner) {
                    document.getElementById('ownerPanel').style.display = 'block';
                    document.getElementById('batchRefundSection').style.display = 'block';
                    logMessage('[AUTH] Owner access granted', 'confirmed');
                }
                
                // Update timer
                startTimer(info.endTime.toNumber());
                
                // Load bidders
                await loadBidders();
                
                // Load user info
                if (account) {
                    await loadUserInfo();
                }
                
                logMessage('[STATE] Auction state loaded successfully', 'confirmed');
                
            } catch (error) {
                console.error('Load state error:', error);
                logMessage(`[ERROR] Failed to load state: ${error.message}`, 'failed');
            }
        }
        
        async function loadBidders() {
            try {
                const bidders = await fheAuctionContract.getRoundBidders();
                document.getElementById('bidderCount').textContent = bidders.length;
                
                const list = document.getElementById('biddersList');
                if (bidders.length === 0) {
                    list.innerHTML = '<p style="text-align: center; opacity: 0.5;">No bidders yet...</p>';
                } else {
                    list.innerHTML = '';
                    for (const bidder of bidders) {
                        const info = await fheAuctionContract.getBidderInfo(bidder);
                        const item = document.createElement('div');
                        item.className = 'bidder-item';
                        item.innerHTML = `
                            <span>${bidder.substring(0, 6)}...${bidder.substring(38)}</span>
                            <span style="color: #ffff00;">${ethers.utils.formatEther(info.deposit)} ETH</span>
                        `;
                        list.appendChild(item);
                    }
                }
            } catch (error) {
                console.error('Load bidders error:', error);
            }
        }
        
        async function loadUserInfo() {
            try {
                const info = await fheAuctionContract.getBidderInfo(account);
                const refund = await fheAuctionContract.pendingRefunds(account);
                
                document.getElementById('yourDeposit').textContent = ethers.utils.formatEther(info.deposit);
                document.getElementById('yourRefund').textContent = ethers.utils.formatEther(refund);
                document.getElementById('pendingRefund').textContent = ethers.utils.formatEther(refund) + ' ETH';
                
                if (info.deposit.gt(0) || refund.gt(0)) {
                    document.getElementById('userBidInfo').style.display = 'block';
                }
                
                if (refund.gt(0)) {
                    document.getElementById('claimRefundBtn').disabled = false;
                }
                
            } catch (error) {
                console.error('Load user info error:', error);
            }
        }
        
        function startTimer(endTime) {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const now = Math.floor(Date.now() / 1000);
                const remaining = endTime - now;
                
                if (remaining <= 0) {
                    document.getElementById('timeLeft').textContent = 'ENDED';
                    clearInterval(timerInterval);
                    document.getElementById('bidBtn').disabled = true;
                } else {
                    const hours = Math.floor(remaining / 3600);
                    const minutes = Math.floor((remaining % 3600) / 60);
                    const seconds = remaining % 60;
                    document.getElementById('timeLeft').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }
        
        // ========== CONNECT WALLET ==========
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showNotification('MetaMask not detected!', 'error');
                return;
            }
            
            try {
                const btn = document.getElementById('connectBtn');
                btn.innerHTML = '<span class="loading"></span> CONNECTING...';
                btn.disabled = true;
                
                logMessage('[WALLET] Requesting connection...', 'info');
                
                // Request accounts
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Switch to Sepolia
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: `0x${SEPOLIA_CHAIN_ID.toString(16)}` }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        showNotification('Please add Sepolia network to MetaMask', 'error');
                        throw new Error('Sepolia network not added');
                    }
                    throw switchError;
                }
                
                // Setup provider
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                account = await signer.getAddress();
                
                logMessage(`[WALLET] Connected: ${account.substring(0, 10)}...`, 'confirmed');
                
                // Initialize FHE SDK
                fhevmInstance = await initFhevmSdk();
                
                // Setup contract
                fheAuctionContract = new ethers.Contract(CONTRACT_ADDRESS, FHE_AUCTION_ABI, signer);
                logMessage('[CONTRACT] Instance created', 'confirmed');
                
                // Load state
                await loadAuctionState();
                
                // Setup event listeners
                setupEventListeners();
                
                // Update UI
                document.getElementById('walletStatus').innerHTML = `
                    <p class="log-line log-confirmed">[STATUS] Wallet: CONNECTED ‚úì</p>
                    <p class="log-line log-confirmed">[ADDRESS] ${account.substring(0, 10)}...${account.substring(38)}</p>
                    <p class="log-line log-confirmed">[NETWORK] Sepolia FHEVM</p>
                `;
                
                btn.textContent = '‚úì CONNECTED';
                document.getElementById('bidBtn').disabled = false;
                
                showNotification('Connected successfully!', 'success');
                
                // Watch for account/network changes
                window.ethereum.on('accountsChanged', () => window.location.reload());
                window.ethereum.on('chainChanged', () => window.location.reload());
                
            } catch (error) {
                console.error('Connection error:', error);
                const btn = document.getElementById('connectBtn');
                btn.textContent = '> CONNECT WALLET & INIT FHE SDK';
                btn.disabled = false;
                showNotification(`Connection failed: ${error.message}`, 'error');
                logMessage(`[ERROR] ${error.message}`, 'failed');
            }
        }
        
        // ========== PLACE BID ==========
        async function placeBid() {
            const bidAmountGwei = parseInt(document.getElementById('bidAmount').value);
            const depositAmountETH = parseFloat(document.getElementById('depositAmount').value);
            
            if (isNaN(bidAmountGwei) || bidAmountGwei <= 0) {
                showNotification('Invalid bid amount', 'error');
                return;
            }
            
            if (isNaN(depositAmountETH) || depositAmountETH <= 0) {
                showNotification('Invalid deposit amount', 'error');
                return;
            }
            
            const btn = document.getElementById('bidBtn');
            
            try {
                btn.innerHTML = '<span class="loading"></span> ENCRYPTING...';
                btn.disabled = true;
                
                logMessage(`[BID] Encrypting ${bidAmountGwei} Gwei with FHE SDK...`, 'info');
                
                // Create encrypted input using Relayer SDK
                const input = fhevmInstance.createEncryptedInput(CONTRACT_ADDRESS, account);
                input.add64(BigInt(bidAmountGwei));
                
                logMessage('[FHE] Generating ZK proof...', 'pending');
                const encryptedData = await input.encrypt();
                
                const encryptedBid = encryptedData.handles[0];
                const proof = encryptedData.inputProof;
                
                logMessage('[FHE] Encryption complete. Handle: ' + encryptedBid.substring(0, 10) + '...', 'confirmed');
                
                // Generate EIP-712 signature
                btn.innerHTML = '<span class="loading"></span> SIGNING EIP-712...';
                logMessage('[EIP-712] Requesting signature...', 'pending');
                
                const domain = {
                    name: 'FHEAuction',
                    version: '1',
                    chainId: SEPOLIA_CHAIN_ID,
                    verifyingContract: CONTRACT_ADDRESS
                };
                
                const types = {
                    PublicKey: [
                        { name: 'key', type: 'bytes32' }
                    ]
                };
                
                const value = {
                    key: encryptedBid
                };
                
                const signature = await signer._signTypedData(domain, types, value);
                logMessage('[EIP-712] Signature obtained', 'confirmed');
                
                // Submit transaction
                btn.innerHTML = '<span class="loading"></span> SUBMITTING TX...';
                logMessage('[TX] Sending encrypted bid to contract...', 'pending');
                
                const depositWei = ethers.utils.parseEther(depositAmountETH.toString());
                
                const tx = await fheAuctionContract.bid(
                    encryptedBid,
                    proof,
                    encryptedBid,
                    signature,
                    { value: depositWei }
                );
                
                logMessage(`[TX] Hash: ${tx.hash.substring(0, 20)}...`, 'pending');
                showNotification('Transaction submitted!', 'info');
                
                const receipt = await tx.wait();
                
                logMessage(`[SUCCESS] Bid submitted! Block: ${receipt.blockNumber}`, 'confirmed');
                showNotification('Encrypted bid confirmed!', 'success');
                
                // Clear inputs
                document.getElementById('bidAmount').value = '';
                document.getElementById('depositAmount').value = '';
                
                // Reload state
                await loadAuctionState();
                
            } catch (error) {
                console.error('Bid error:', error);
                const msg = error.reason || error.message || 'Transaction failed';
                logMessage(`[ERROR] ${msg}`, 'failed');
                showNotification(`Bid failed: ${msg}`, 'error');
            } finally {
                btn.innerHTML = '> ENCRYPT BID & SUBMIT';
                btn.disabled = false;
            }
        }
        
        // ========== OWNER FUNCTIONS ==========
        async function requestFinalize() {
            const btn = document.getElementById('requestFinalizeBtn');
            try {
                btn.innerHTML = '<span class="loading"></span> REQUESTING...';
                btn.disabled = true;
                
                logMessage('[FINALIZE] Requesting decryption from KMS...', 'pending');
                
                const tx = await fheAuctionContract.requestFinalize();
                logMessage(`[TX] Hash: ${tx.hash.substring(0, 20)}...`, 'pending');
                
                await tx.wait();
                
                logMessage('[SUCCESS] Finalization requested. Waiting for KMS callback...', 'confirmed');
                showNotification('Decryption requested! Wait for callback...', 'success');
                
                await loadAuctionState();
                
            } catch (error) {
                console.error('Finalize error:', error);
                showNotification(`Failed: ${error.reason || error.message}`, 'error');
                logMessage(`[ERROR] ${error.message}`, 'failed');
            } finally {
                btn.innerHTML = '> REQUEST FINALIZE (Decrypt Bids)';
            }
        }
        
        async function pauseAuction() {
            try {
                logMessage('[PAUSE] Pausing auction...', 'pending');
                const tx = await fheAuctionContract.pauseAuction();
                await tx.wait();
                logMessage('[SUCCESS] Auction paused', 'confirmed');
                showNotification('Auction paused', 'success');
                document.getElementById('pauseBtn').style.display = 'none';
                document.getElementById('unpauseBtn').style.display = 'block';
                await loadAuctionState();
            } catch (error) {
                showNotification(`Failed: ${error.message}`, 'error');
            }
        }
        
        async function unpauseAuction() {
            try {
                logMessage('[UNPAUSE] Resuming auction...', 'pending');
                const tx = await fheAuctionContract.unpauseAuction();
                await tx.wait();
                logMessage('[SUCCESS] Auction resumed', 'confirmed');
                showNotification('Auction resumed', 'success');
                document.getElementById('pauseBtn').style.display = 'block';
                document.getElementById('unpauseBtn').style.display = 'none';
                await loadAuctionState();
            } catch (error) {
                showNotification(`Failed: ${error.message}`, 'error');
            }
        }
        
        async function emergencyEnd() {
            const reason = prompt('Enter emergency reason:');
            if (!reason) return;
            
            try {
                logMessage('[EMERGENCY] Initiating emergency end...', 'warning');
                const tx = await fheAuctionContract.emergencyEnd(reason);
                await tx.wait();
                logMessage('[SUCCESS] Emergency end executed', 'confirmed');
                showNotification('Emergency end successful', 'success');
                await loadAuctionState();
            } catch (error) {
                showNotification(`Failed: ${error.message}`, 'error');
            }
        }
        
        async function updateBeneficiary() {
            const newAddr = document.getElementById('newBeneficiary').value;
            if (!ethers.utils.isAddress(newAddr)) {
                showNotification('Invalid address', 'error');
                return;
            }
            
            try {
                logMessage('[ADMIN] Updating beneficiary...', 'pending');
                const tx = await fheAuctionContract.updateBeneficiary(newAddr);
                await tx.wait();
                logMessage('[SUCCESS] Beneficiary updated', 'confirmed');
                showNotification('Beneficiary updated', 'success');
                document.getElementById('newBeneficiary').value = '';
            } catch (error) {
                showNotification(`Failed: ${error.message}`, 'error');
            }
        }
        
        // ========== REFUND FUNCTIONS ==========
        async function claimRefund() {
            const btn = document.getElementById('claimRefundBtn');
            try {
                btn.innerHTML = '<span class="loading"></span> CLAIMING...';
                btn.disabled = true;
                
                logMessage('[REFUND] Claiming refund...', 'pending');
                const tx = await fheAuctionContract.claimRefund();
                await tx.wait();
                
                logMessage('[SUCCESS] Refund claimed!', 'confirmed');
                showNotification('Refund claimed successfully!', 'success');
                
                await loadUserInfo();
                
            } catch (error) {
                showNotification(`Failed: ${error.message}`, 'error');
            } finally {
                btn.innerHTML = '> CLAIM YOUR REFUND';
                btn.disabled = true;
            }
        }
        
        async function batchClaimRefunds() {
            const addrs = document.getElementById('batchAddresses').value.split(',').map(a => a.trim());
            
            if (addrs.length > 20) {
                showNotification('Max 20 addresses allowed', 'error');
                return;
            }
            
            try {
                logMessage('[BATCH] Claiming refunds for ' + addrs.length + ' addresses...', 'pending');
                const tx = await fheAuctionContract.batchClaimRefunds(addrs);
                await tx.wait();
                logMessage('[SUCCESS] Batch refunds processed', 'confirmed');
                showNotification('Batch refunds successful!', 'success');
            } catch (error) {
                showNotification(`Failed: ${error.message}`, 'error');
            }
        }
        
        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            fheAuctionContract.on('BidReceived', async (bidder, round, deposit) => {
                logMessage(`[EVENT] New bid from ${bidder.substring(0, 8)}... Deposit: ${ethers.utils.formatEther(deposit)} ETH`, 'confirmed');
                await loadAuctionState();
            });
            
            fheAuctionContract.on('AuctionFinished', async (round, winner, finalBid) => {
                logMessage(`[EVENT] üéâ AUCTION FINISHED! Winner: ${winner.substring(0, 10)}... Bid: ${ethers.utils.formatEther(finalBid)} ETH`, 'confirmed');
                showNotification(`Auction ended! Winner: ${winner.substring(0, 8)}...`, 'success');
                await loadAuctionState();
            });
            
            fheAuctionContract.on('DecryptionRequested', (requestId) => {
                logMessage(`[EVENT] Decryption requested. ID: ${requestId}`, 'pending');
            });
            
            fheAuctionContract.on('DecryptionFulfilled', (requestId) => {
                logMessage(`[EVENT] Decryption fulfilled. ID: ${requestId}`, 'confirmed');
            });
            
            fheAuctionContract.on('RefundClaimed', async (recipient, amount) => {
                logMessage(`[EVENT] Refund claimed by ${recipient.substring(0, 8)}...: ${ethers.utils.formatEther(amount)} ETH`, 'confirmed');
                if (recipient.toLowerCase() === account.toLowerCase()) {
                    await loadUserInfo();
                }
            });
        }
        
        // ========== SETUP UI HANDLERS ==========
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('connectBtn').addEventListener('click', connectWallet);
            document.getElementById('bidBtn').addEventListener('click', placeBid);
            document.getElementById('claimRefundBtn').addEventListener('click', claimRefund);
            document.getElementById('requestFinalizeBtn').addEventListener('click', requestFinalize);
            document.getElementById('pauseBtn').addEventListener('click', pauseAuction);
            document.getElementById('unpauseBtn').addEventListener('click', unpauseAuction);
            document.getElementById('emergencyEndBtn').addEventListener('click', emergencyEnd);
            document.getElementById('updateBeneficiaryBtn').addEventListener('click', updateBeneficiary);
            document.getElementById('batchRefundBtn').addEventListener('click', batchClaimRefunds);
            
            logMessage('[INIT] FHE Auction v0.9.1 interface loaded', 'confirmed');
            logMessage('[INFO] Contract: ' + CONTRACT_ADDRESS, 'info');
        });
        
    </script>
</body>
</html>
