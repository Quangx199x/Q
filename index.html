<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHE Auction - Privacy-Preserving Blockchain Auction</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fhevmjs@0.5.2/bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-left img {
            height: 40px;
        }

        .social-links {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .social-links a {
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .social-links a:hover {
            opacity: 1;
        }

        .social-links img {
            height: 24px;
            width: 24px;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .wallet-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wallet-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .wallet-address {
            font-family: 'Monaco', monospace;
            font-size: 0.9rem;
            color: #666;
        }

        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .role-owner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .role-user {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .grid-3col {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #333;
        }

        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background: #43e97b;
            color: white;
        }

        .status-ended {
            background: #f5576c;
            color: white;
        }

        .status-finalizing {
            background: #ffa502;
            color: white;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .info-label {
            color: #666;
            font-weight: 500;
        }

        .info-value {
            font-weight: 600;
            color: #333;
        }

        .highlight-value {
            color: #667eea;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-hint {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .timer {
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .timer-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .timer-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .bidders-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .bidder-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .bidder-address {
            font-family: 'Monaco', monospace;
            font-size: 0.85rem;
        }

        .bidder-deposit {
            font-weight: 600;
            color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .footer {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            text-align: center;
            margin-top: 3rem;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        .footer-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .footer-link:hover {
            text-decoration: underline;
        }

        .owner-panel {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .owner-panel .card-title {
            color: white;
        }

        .owner-panel .form-label {
            color: white;
        }

        .owner-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .history-item {
            padding: 1rem;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            margin-bottom: 0.75rem;
            border-radius: 4px;
        }

        .history-time {
            font-size: 0.85rem;
            color: #666;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .grid-3col {
                grid-template-columns: 1fr;
            }

            .wallet-section {
                flex-direction: column;
                gap: 1rem;
            }

            .timer-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-left">
            <img src="https://www.zama.ai/images/logo.svg" alt="Zama" />
            <span style="font-weight: 700; font-size: 1.2rem;">FHE Auction</span>
        </div>
        <div class="social-links">
            <a href="https://twitter.com/zama_fhe" target="_blank" rel="noopener">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23000000'%3E%3Cpath d='M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z'/%3E%3C/svg%3E" alt="X" />
            </a>
            <a href="https://github.com/zama-ai" target="_blank" rel="noopener">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23000000'%3E%3Cpath d='M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z'/%3E%3C/svg%3E" alt="GitHub" />
            </a>
        </div>
    </div>

    <div class="container">
        <!-- Wallet Connection -->
        <div class="wallet-section" id="walletSection">
            <div class="wallet-info">
                <div id="connectionStatus">
                    <button class="btn btn-primary" onclick="connectWallet()">Connect Wallet</button>
                </div>
            </div>
        </div>

        <!-- Alert Area -->
        <div id="alertArea"></div>

        <!-- Auction Timer -->
        <div class="timer" id="auctionTimer">
            <div class="timer-label">Auction Ends In</div>
            <div class="timer-value" id="timerValue">--:--:--</div>
            <div class="timer-label" id="timerSubtext">Round #<span id="roundNumber">1</span></div>
        </div>

        <!-- Main Content Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('user')">User Dashboard</button>
            <button class="tab" id="ownerTab" style="display: none;" onclick="switchTab('owner')">Owner Panel</button>
        </div>

        <!-- User Dashboard -->
        <div class="tab-content active" id="userContent">
            <div class="grid-3col">
                <!-- Auction Info Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Auction Info</h3>
                        <span class="status-badge status-active" id="auctionStatus">Active</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Current Round</span>
                        <span class="info-value" id="infoRound">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">End Block</span>
                        <span class="info-value" id="infoEndBlock">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Total Bidders</span>
                        <span class="info-value highlight-value" id="infoBidders">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Min Deposit</span>
                        <span class="info-value" id="infoMinDeposit">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Platform Fee</span>
                        <span class="info-value">2.5%</span>
                    </div>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 1rem;" onclick="refreshAuctionInfo()">
                        Refresh Info
                    </button>
                </div>

                <!-- Place Bid Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Place Bid</h3>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bid Amount (ETH)</label>
                        <input type="number" class="form-input" id="bidAmount" placeholder="0.1" step="0.001" />
                        <div class="form-hint">Your encrypted bid amount (private)</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Deposit Amount (ETH)</label>
                        <input type="number" class="form-input" id="depositAmount" placeholder="0.1" step="0.001" />
                        <div class="form-hint">Must be ≥ bid amount to win</div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="placeBid()">
                        🔒 Submit Encrypted Bid
                    </button>
                    <div class="info-row" style="margin-top: 1rem;">
                        <span class="info-label">Your Deposit</span>
                        <span class="info-value" id="userDeposit">0 ETH</span>
                    </div>
                    <button class="btn btn-danger" style="width: 100%; margin-top: 0.5rem;" onclick="cancelBid()">
                        Cancel My Bid
                    </button>
                </div>

                <!-- Your Status Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Your Status</h3>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Has Bid This Round</span>
                        <span class="info-value" id="userHasBid">No</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Bid Cancelled</span>
                        <span class="info-value" id="userCancelled">No</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Pending Refund</span>
                        <span class="info-value highlight-value" id="userRefund">0 ETH</span>
                    </div>
                    <button class="btn btn-success" style="width: 100%; margin-top: 1rem;" onclick="claimRefund()">
                        💰 Claim Refund
                    </button>
                    <button class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem;" onclick="openHistoryModal()">
                        📜 View Bid History
                    </button>
                </div>
            </div>

            <!-- Active Bidders -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Active Bidders</h3>
                    <span class="info-value" id="bidderCount">0 bidders</span>
                </div>
                <div class="bidders-list" id="biddersList">
                    <div class="loading">No bidders yet</div>
                </div>
            </div>

            <!-- Winner Info (if finalized) -->
            <div class="card" id="winnerCard" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">🏆 Auction Winner</h3>
                </div>
                <div class="info-row">
                    <span class="info-label">Winner Address</span>
                    <span class="info-value" id="winnerAddress">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Winning Bid</span>
                    <span class="info-value highlight-value" id="winningBid">-</span>
                </div>
            </div>
        </div>

        <!-- Owner Panel -->
        <div class="tab-content" id="ownerContent">
            <div class="owner-panel card">
                <h3 class="card-title">⚙️ Owner Controls</h3>
                
                <div class="form-group">
                    <label class="form-label">Update Beneficiary</label>
                    <input type="text" class="form-input" id="newBeneficiary" placeholder="0x..." />
                    <button class="btn btn-primary" style="margin-top: 0.5rem;" onclick="updateBeneficiary()">
                        Update Beneficiary
                    </button>
                </div>

                <div class="form-group">
                    <label class="form-label">Update Fee Collector</label>
                    <input type="text" class="form-input" id="newFeeCollector" placeholder="0x..." />
                    <button class="btn btn-primary" style="margin-top: 0.5rem;" onclick="updateFeeCollector()">
                        Update Fee Collector
                    </button>
                </div>

                <div class="owner-actions">
                    <button class="btn btn-success" onclick="requestFinalize()">
                        ✅ Finalize Auction
                    </button>
                    <button class="btn btn-danger" onclick="pauseAuction()">
                        ⏸️ Pause Auction
                    </button>
                    <button class="btn btn-success" onclick="unpauseAuction()">
                        ▶️ Unpause Auction
                    </button>
                    <button class="btn btn-secondary" onclick="withdrawFees()">
                        💸 Withdraw Fees
                    </button>
                    <button class="btn btn-danger" onclick="emergencyEnd()">
                        🚨 Emergency End
                    </button>
                    <button class="btn btn-danger" onclick="forceFinalize()">
                        🔧 Force Finalize
                    </button>
                </div>

                <div class="info-row" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid rgba(255,255,255,0.3);">
                    <span class="form-label">Total Collected Fees</span>
                    <span class="info-value" id="totalFees" style="color: white;">-</span>
                </div>
            </div>

            <!-- Contract Info -->
            <div class="grid-3col">
                <div class="card">
                    <h3 class="card-title">Contract Addresses</h3>
                    <div class="info-row">
                        <span class="info-label">Owner</span>
                        <span class="info-value" style="font-size: 0.8rem;" id="contractOwner">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Beneficiary</span>
                        <span class="info-value" style="font-size: 0.8rem;" id="contractBeneficiary">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Fee Collector</span>
                        <span class="info-value" style="font-size: 0.8rem;" id="contractFeeCollector">-</span>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Contract State</h3>
                    <div class="info-row">
                        <span class="info-label">Paused</span>
                        <span class="info-value" id="contractPaused">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Auction State</span>
                        <span class="info-value" id="contractState">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Decryption Pending</span>
                        <span class="info-value" id="decryptionPending">-</span>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">Constants</h3>
                    <div class="info-row">
                        <span class="info-label">Min Bid Increment</span>
                        <span class="info-value">1 Gwei</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Base Duration</span>
                        <span class="info-value">7200 blocks</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Extension Duration</span>
                        <span class="info-value">75 blocks</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="card-title">Bid History</h3>
                <button class="modal-close" onclick="closeHistoryModal()">×</button>
            </div>
            <div id="historyContent">
                <div class="loading">Loading history...</div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="footer-content">
            <p>Powered by <a href="https://www.zama.ai" target="_blank" rel="noopener" class="footer-link">Zama</a> - Fully Homomorphic Encryption</p>
            <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                Privacy-preserving blockchain auction using FHE technology
            </p>
        </div>
    </div>

    <script>
        // Contract Configuration
        const CONTRACT_ADDRESS = '0x3023a7dc6f4732c4004c3070a12dd6e796cd3c93'; // Replace with your deployed contract address
        const CONTRACT_ABI = [{"inputs":[{"internalType":"uint256","name":"_minDeposit","type":"uint256"},{"internalType":"address","name":"_pauserSet","type":"address"},{"internalType":"address","name":"_beneficiary","type":"address"},{"internalType":"address","name":"_gatewayContract","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"AuctionAlreadyFinalized","type":"error"},{"inputs":[],"name":"AuctionNotActive","type":"error"},{"inputs":[],"name":"AuctionStillActive","type":"error"},{"inputs":[],"name":"ContractPaused","type":"error"},{"inputs":[],"name":"DecryptionAlreadyPending","type":"error"},{"inputs":[],"name":"ECDSAInvalidSignature","type":"error"},{"inputs":[{"internalType":"uint256","name":"length","type":"uint256"}],"name":"ECDSAInvalidSignatureLength","type":"error"},{"inputs":[{"internalType":"bytes32","name":"s","type":"bytes32"}],"name":"ECDSAInvalidSignatureS","type":"error"},{"inputs":[],"name":"EmergencyDelayNotMet","type":"error"},{"inputs":[],"name":"HandlesAlreadySavedForRequestID","type":"error"},{"inputs":[],"name":"InsufficientDeposit","type":"error"},{"inputs":[],"name":"InvalidAddress","type":"error"},{"inputs":[],"name":"InvalidAmount","type":"error"},{"inputs":[],"name":"InvalidDecryptionData","type":"error"},{"inputs":[],"name":"InvalidKMSSignatures","type":"error"},{"inputs":[],"name":"InvalidShortString","type":"error"},{"inputs":[],"name":"InvalidSignature","type":"error"},{"inputs":[],"name":"InvalidState","type":"error"},{"inputs":[],"name":"MaxBiddersReached","type":"error"},{"inputs":[],"name":"NoBidders","type":"error"},{"inputs":[],"name":"NoHandleFoundForRequestID","type":"error"},{"inputs":[],"name":"NoRefundAvailable","type":"error"},{"inputs":[],"name":"ReentrancyGuardReentrantCall","type":"error"},{"inputs":[{"internalType":"string","name":"str","type":"string"}],"name":"StringTooLong","type":"error"},{"inputs":[],"name":"TransferFailed","type":"error"},{"inputs":[],"name":"Unauthorized","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"round","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"finalBid","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"AuctionFinished","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldBeneficiary","type":"address"},{"indexed":true,"internalType":"address","name":"newBeneficiary","type":"address"}],"name":"BeneficiaryUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"bidder","type":"address"},{"indexed":true,"internalType":"uint256","name":"round","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"depositAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"BidReceived","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"requestID","type":"uint256"}],"name":"DecryptionFulfilled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"requestId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"bytes32[]","name":"handles","type":"bytes32[]"}],"name":"DecryptionRequested","type":"event"},{"anonymous":false,"inputs":[],"name":"EIP712DomainChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"round","type":"uint256"},{"indexed":false,"internalType":"string","name":"reason","type":"string"}],"name":"EmergencyActivated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RefundAvailable","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RefundClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"round","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"endTime","type":"uint256"}],"name":"RoundStarted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"enum FHEAuction.AuctionState","name":"from","type":"uint8"},{"indexed":false,"internalType":"enum FHEAuction.AuctionState","name":"to","type":"uint8"}],"name":"StateChanged","type":"event"},{"stateMutability":"payable","type":"fallback"},{"inputs":[],"name":"AUCTION_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"BATCH_REFUND_SIZE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"EMERGENCY_DELAY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"KMS_THRESHOLD","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BIDDERS_PER_ROUND","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"auctionEndTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"auctionState","outputs":[{"internalType":"enum FHEAuction.AuctionState","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"claimants","type":"address[]"}],"name":"batchClaimRefunds","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"beneficiary","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"externalEuint64","name":"encryptedBid","type":"bytes32"},{"internalType":"bytes","name":"inputProof","type":"bytes"},{"internalType":"bytes32","name":"publicKey","type":"bytes32"},{"internalType":"bytes","name":"signature","type":"bytes"}],"name":"bid","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"claimRefund","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"currentLeadBidder","outputs":[{"internalType":"address payable","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentLeadDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"currentRound","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"deposits","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"eip712Domain","outputs":[{"internalType":"bytes1","name":"fields","type":"bytes1"},{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"version","type":"string"},{"internalType":"uint256","name":"chainId","type":"uint256"},{"internalType":"address","name":"verifyingContract","type":"address"},{"internalType":"bytes32","name":"salt","type":"bytes32"},{"internalType":"uint256[]","name":"extensions","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"reason","type":"string"}],"name":"emergencyEnd","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"forceFinalize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"gatewayContract","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getAuctionInfo","outputs":[{"internalType":"uint256","name":"round","type":"uint256"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"enum FHEAuction.AuctionState","name":"state","type":"uint8"},{"internalType":"uint256","name":"maxDeposit","type":"uint256"},{"internalType":"address","name":"leadBidder","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"bidder","type":"address"}],"name":"getBidderInfo","outputs":[{"internalType":"uint256","name":"deposit","type":"uint256"},{"internalType":"bool","name":"hasBidded","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getProtocolId","outputs":[{"internalType":"bytes4","name":"","type":"bytes4"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"getRoundBidders","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isEmergencyAvailable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minBidDeposit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"requestId","type":"uint256"},{"internalType":"bytes","name":"cleartexts","type":"bytes"},{"internalType":"bytes","name":"decryptionProof","type":"bytes"}],"name":"onDecryptionCallback","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pauseAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pauserSet","outputs":[{"internalType":"contract IPauserSet","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pendingRefunds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"protocolId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"requestFinalize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpauseAuction","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newBeneficiary","type":"address"}],"name":"updateBeneficiary","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"winningBid","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}];

        // Global Variables
        let provider;
        let signer;
        let contract;
        let fhevmInstance;
        let userAddress;
        let isOwner = false;
        let timerInterval;

        // Auction State Enum
        const AuctionState = {
            0: 'Active',
            1: 'Ended',
            2: 'Finalizing',
            3: 'Finalized',
            4: 'Emergency'
        };

        // Initialize on page load
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask detected');
            } else {
                showAlert('Please install MetaMask to use this application', 'error');
            }
        });

        // Connect Wallet
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showAlert('Please install MetaMask', 'error');
                    return;
                }

                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // Initialize contract
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // Initialize FHE
                await initializeFHE();

                // Check if user is owner
                const ownerAddress = await contract.owner();
                isOwner = userAddress.toLowerCase() === ownerAddress.toLowerCase();

                // Update UI
                updateWalletUI();
                
                if (isOwner) {
                    document.getElementById('ownerTab').style.display = 'block';
                }

                // Load auction data
                await refreshAuctionInfo();
                await loadBidders();
                await loadUserInfo();
                
                // Start timer
                startTimer();

                // Listen for events
                setupEventListeners();

                showAlert('Wallet connected successfully!', 'success');

            } catch (error) {
                console.error('Error connecting wallet:', error);
                showAlert('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        // Initialize FHE Instance
        async function initializeFHE() {
            try {
                showAlert('Initializing FHE encryption...', 'info');
                
                // Create FHE instance
                fhevmInstance = await window.fhevmjs.createInstance({
                    chainId: 11155111, // Sepolia
                    networkUrl: 'https://sepolia.infura.io/v3/YOUR_INFURA_KEY', // Replace with your Infura key
                    gatewayUrl: 'https://gateway.sepolia.zama.ai'
                });

                console.log('FHE instance initialized');
            } catch (error) {
                console.error('Error initializing FHE:', error);
                showAlert('Failed to initialize FHE encryption', 'error');
            }
        }

        // Update Wallet UI
        function updateWalletUI() {
            const statusDiv = document.getElementById('connectionStatus');
            const roleClass = isOwner ? 'role-owner' : 'role-user';
            const roleText = isOwner ? 'Owner' : 'User';
            
            statusDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div>
                        <div class="wallet-address">${userAddress.slice(0, 6)}...${userAddress.slice(-4)}</div>
                        <span class="role-badge ${roleClass}">${roleText}</span>
                    </div>
                    <button class="btn btn-secondary" onclick="disconnectWallet()">Disconnect</button>
                </div>
            `;
        }

        // Disconnect Wallet
        function disconnectWallet() {
            provider = null;
            signer = null;
            contract = null;
            userAddress = null;
            isOwner = false;
            
            document.getElementById('connectionStatus').innerHTML = 
                '<button class="btn btn-primary" onclick="connectWallet()">Connect Wallet</button>';
            
            document.getElementById('ownerTab').style.display = 'none';
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            showAlert('Wallet disconnected', 'info');
        }

        // Refresh Auction Info
        async function refreshAuctionInfo() {
            if (!contract) return;

            try {
                const info = await contract.getAuctionInfo();
                const minDeposit = await contract.minBidDeposit();
                const estimatedEnd = await contract.getEstimatedEndTime();
                const currentBlock = await provider.getBlockNumber();

                // Update UI
                document.getElementById('roundNumber').textContent = info[0].toString();
                document.getElementById('infoRound').textContent = info[0].toString();
                document.getElementById('infoEndBlock').textContent = info[1].toString();
                document.getElementById('infoBidders').textContent = info[5].toString();
                document.getElementById('infoMinDeposit').textContent = 
                    ethers.utils.formatEther(minDeposit) + ' ETH';

                // Update status badge
                const stateNum = info[2];
                const statusBadge = document.getElementById('auctionStatus');
                statusBadge.textContent = AuctionState[stateNum];
                statusBadge.className = 'status-badge';
                
                if (stateNum === 0) {
                    statusBadge.classList.add('status-active');
                } else if (stateNum === 1) {
                    statusBadge.classList.add('status-ended');
                } else if (stateNum === 2) {
                    statusBadge.classList.add('status-finalizing');
                }

                // Update winner info if finalized
                if (stateNum === 3) {
                    const winner = await contract.currentLeadBidder();
                    const winBid = await contract.winningBid();
                    
                    if (winner !== ethers.constants.AddressZero) {
                        document.getElementById('winnerCard').style.display = 'block';
                        document.getElementById('winnerAddress').textContent = 
                            winner.slice(0, 6) + '...' + winner.slice(-4);
                        document.getElementById('winningBid').textContent = 
                            ethers.utils.formatEther(winBid) + ' ETH';
                    }
                } else {
                    document.getElementById('winnerCard').style.display = 'none';
                }

                // Update owner panel if owner
                if (isOwner) {
                    await updateOwnerPanel();
                }

            } catch (error) {
                console.error('Error refreshing auction info:', error);
                showAlert('Failed to refresh auction info', 'error');
            }
        }

        // Load Bidders List
        async function loadBidders() {
            if (!contract) return;

            try {
                const bidders = await contract.getRoundBidders();
                const listDiv = document.getElementById('biddersList');
                
                document.getElementById('bidderCount').textContent = bidders.length + ' bidders';

                if (bidders.length === 0) {
                    listDiv.innerHTML = '<div class="loading">No bidders yet</div>';
                    return;
                }

                let html = '';
                for (const bidder of bidders) {
                    const info = await contract.getBidderInfo(bidder);
                    const deposit = ethers.utils.formatEther(info[0]);
                    const cancelled = info[2];

                    if (!cancelled) {
                        html += `
                            <div class="bidder-item">
                                <span class="bidder-address">${bidder.slice(0, 8)}...${bidder.slice(-6)}</span>
                                <span class="bidder-deposit">${deposit} ETH</span>
                            </div>
                        `;
                    }
                }

                listDiv.innerHTML = html || '<div class="loading">No active bidders</div>';

            } catch (error) {
                console.error('Error loading bidders:', error);
            }
        }

        // Load User Info
        async function loadUserInfo() {
            if (!contract || !userAddress) return;

            try {
                const info = await contract.getBidderInfo(userAddress);
                const refund = await contract.pendingRefunds(userAddress);

                document.getElementById('userDeposit').textContent = 
                    ethers.utils.formatEther(info[0]) + ' ETH';
                document.getElementById('userHasBid').textContent = info[1] ? 'Yes' : 'No';
                document.getElementById('userCancelled').textContent = info[2] ? 'Yes' : 'No';
                document.getElementById('userRefund').textContent = 
                    ethers.utils.formatEther(refund) + ' ETH';

            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Place Bid
        async function placeBid() {
            if (!contract || !fhevmInstance) {
                showAlert('Please connect wallet first', 'error');
                return;
            }

            try {
                const bidAmount = document.getElementById('bidAmount').value;
                const depositAmount = document.getElementById('depositAmount').value;

                if (!bidAmount || !depositAmount) {
                    showAlert('Please enter both bid and deposit amounts', 'error');
                    return;
                }

                if (parseFloat(depositAmount) < parseFloat(bidAmount)) {
                    showAlert('Deposit must be greater than or equal to bid amount', 'error');
                    return;
                }

                showAlert('Encrypting your bid...', 'info');

                // Convert to Wei
                const bidWei = ethers.utils.parseEther(bidAmount);
                const depositWei = ethers.utils.parseEther(depositAmount);

                // Create encrypted input
                const input = fhevmInstance.createEncryptedInput(CONTRACT_ADDRESS, userAddress);
                input.add64(bidWei.toBigInt());
                const encryptedData = await input.encrypt();

                // Generate EIP-712 signature
                const domain = {
                    name: 'FHEAuction',
                    version: '3',
                    chainId: 11155111,
                    verifyingContract: CONTRACT_ADDRESS
                };

                const types = {
                    PublicKey: [{ name: 'key', type: 'bytes32' }]
                };

                const value = {
                    key: encryptedData.handles[0]
                };

                showAlert('Please sign the transaction...', 'info');
                const signature = await signer._signTypedData(domain, types, value);

                // Submit bid
                showAlert('Submitting encrypted bid...', 'info');
                const tx = await contract.bid(
                    encryptedData.handles[0],
                    encryptedData.inputProof,
                    encryptedData.handles[0],
                    signature,
                    { 
                        value: depositWei,
                        gasLimit: 500000
                    }
                );

                showAlert('Transaction submitted. Waiting for confirmation...', 'info');
                await tx.wait();

                showAlert('Bid placed successfully! 🎉', 'success');
                
                // Refresh data
                await refreshAuctionInfo();
                await loadBidders();
                await loadUserInfo();

                // Clear inputs
                document.getElementById('bidAmount').value = '';
                document.getElementById('depositAmount').value = '';

            } catch (error) {
                console.error('Error placing bid:', error);
                showAlert('Failed to place bid: ' + error.message, 'error');
            }
        }

        // Cancel Bid
        async function cancelBid() {
            if (!contract) {
                showAlert('Please connect wallet first', 'error');
                return;
            }

            try {
                if (!confirm('Are you sure you want to cancel your bid? You will receive a full refund.')) {
                    return;
                }

                showAlert('Cancelling bid...', 'info');
                const tx = await contract.cancelBid();
                
                showAlert('Transaction submitted. Waiting for confirmation...', 'info');
                await tx.wait();

                showAlert('Bid cancelled successfully!', 'success');
                
                // Refresh data
                await refreshAuctionInfo();
                await loadBidders();
                await loadUserInfo();

            } catch (error) {
                console.error('Error cancelling bid:', error);
                showAlert('Failed to cancel bid: ' + error.message, 'error');
            }
        }

        // Claim Refund
        async function claimRefund() {
            if (!contract) {
                showAlert('Please connect wallet first', 'error');
                return;
            }

            try {
                const refund = await contract.pendingRefunds(userAddress);
                
                if (refund.eq(0)) {
                    showAlert('No refund available', 'info');
                    return;
                }

                showAlert('Claiming refund...', 'info');
                const tx = await contract.claimRefund();
                
                showAlert('Transaction submitted. Waiting for confirmation...', 'info');
                await tx.wait();

                showAlert('Refund claimed successfully! 💰', 'success');
                
                // Refresh data
                await loadUserInfo();

            } catch (error) {
                console.error('Error claiming refund:', error);
                showAlert('Failed to claim refund: ' + error.message, 'error');
            }
        }

        // Start Timer
        function startTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(async () => {
                if (!contract) return;

                try {
                    const endTime = await contract.getEstimatedEndTime();
                    const now = Math.floor(Date.now() / 1000);
                    const remaining = endTime - now;

                    if (remaining <= 0) {
                        document.getElementById('timerValue').textContent = '00:00:00';
                        document.getElementById('timerSubtext').textContent = 'Auction Ended';
                        clearInterval(timerInterval);
                        return;
                    }

                    const hours = Math.floor(remaining / 3600);
                    const minutes = Math.floor((remaining % 3600) / 60);
                    const seconds = remaining % 60;

                    document.getElementById('timerValue').textContent = 
                        `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                } catch (error) {
                    console.error('Error updating timer:', error);
                }
            }, 1000);
        }

        // Setup Event Listeners
        function setupEventListeners() {
            if (!contract) return;

            contract.on('BidPlaced', (bidder, round, deposit, block, timestamp) => {
                console.log('BidPlaced event:', { bidder, round: round.toString(), deposit: deposit.toString() });
                showAlert(`New bid placed: ${ethers.utils.formatEther(deposit)} ETH`, 'success');
                loadBidders();
                refreshAuctionInfo();
            });

            contract.on('AuctionFinished', (round, winner, finalBid, fee, timestamp) => {
                console.log('AuctionFinished event:', { winner, finalBid: finalBid.toString() });
                showAlert(`Auction finished! Winner: ${winner.slice(0, 8)}...`, 'success');
                refreshAuctionInfo();
            });

            contract.on('BidCancelled', (bidder, round, refund, timestamp) => {
                console.log('BidCancelled event:', { bidder, refund: refund.toString() });
                if (bidder.toLowerCase() === userAddress.toLowerCase()) {
                    showAlert('Your bid was cancelled', 'info');
                    loadUserInfo();
                }
                loadBidders();
            });

            contract.on('RefundClaimed', (recipient, amount) => {
                console.log('RefundClaimed event:', { recipient, amount: amount.toString() });
                if (recipient.toLowerCase() === userAddress.toLowerCase()) {
                    showAlert(`Refund claimed: ${ethers.utils.formatEther(amount)} ETH`, 'success');
                    loadUserInfo();
                }
            });
        }

        // Update Owner Panel
        async function updateOwnerPanel() {
            if (!isOwner || !contract) return;

            try {
                const owner = await contract.owner();
                const beneficiary = await contract.beneficiary();
                const feeCollector = await contract.feeCollector();
                const paused = await contract.paused();
                const state = await contract.auctionState();
                const fees = await contract.totalCollectedFees();

                document.getElementById('contractOwner').textContent = owner.slice(0, 10) + '...' + owner.slice(-8);
                document.getElementById('contractBeneficiary').textContent = beneficiary.slice(0, 10) + '...' + beneficiary.slice(-8);
                document.getElementById('contractFeeCollector').textContent = feeCollector.slice(0, 10) + '...' + feeCollector.slice(-8);
                document.getElementById('contractPaused').textContent = paused ? 'Yes' : 'No';
                document.getElementById('contractState').textContent = AuctionState[state];
                document.getElementById('totalFees').textContent = ethers.utils.formatEther(fees) + ' ETH';

            } catch (error) {
                console.error('Error updating owner panel:', error);
            }
        }

        // Request Finalize (Owner)
        async function requestFinalize() {
            if (!contract || !isOwner) {
                showAlert('Only owner can finalize auction', 'error');
                return;
            }

            try {
                if (!confirm('Finalize the auction? This will decrypt all bids and determine the winner.')) {
                    return;
                }

                showAlert('Requesting finalization...', 'info');
                const tx = await contract.requestFinalize({ gasLimit: 1000000 });
                
                showAlert('Transaction submitted. Waiting for confirmation...', 'info');
                await tx.wait();

                showAlert('Auction finalization requested. Waiting for KMS decryption...', 'success');
                
                await refreshAuctionInfo();

            } catch (error) {
                console.error('Error finalizing auction:', error);
                showAlert('Failed to finalize: ' + error.message, 'error');
            }
        }

        // Update Beneficiary (Owner)
        async function updateBeneficiary() {
            if (!contract || !isOwner) {
                showAlert('Only owner can update beneficiary', 'error');
                return;
            }

            try {
                const newBeneficiary = document.getElementById('newBeneficiary').value;
                
                if (!ethers.utils.isAddress(newBeneficiary)) {
                    showAlert('Invalid address', 'error');
                    return;
                }

                showAlert('Updating beneficiary...', 'info');
                const tx = await contract.updateBeneficiary(newBeneficiary);
                
                await tx.wait();
                showAlert('Beneficiary updated successfully!', 'success');
                
                await updateOwnerPanel();
                document.getElementById('newBeneficiary').value = '';

            } catch (error) {
                console.error('Error updating beneficiary:', error);
                showAlert('Failed to update beneficiary: ' + error.message, 'error');
            }
        }

        // Update Fee Collector (Owner)
        async function updateFeeCollector() {
            if (!contract || !isOwner) {
                showAlert('Only owner can update fee collector', 'error');
                return;
            }

            try {
                const newFeeCollector = document.getElementById('newFeeCollector').value;
                
                if (!ethers.utils.isAddress(newFeeCollector)) {
                    showAlert('Invalid address', 'error');
                    return;
                }

                showAlert('Updating fee collector...', 'info');
                const tx = await contract.updateFeeCollector(newFeeCollector);
                
                await tx.wait();
                showAlert('Fee collector updated successfully!', 'success');
                
                await updateOwnerPanel();
                document.getElementById('newFeeCollector').value = '';

            } catch (error) {
                console.error('Error updating fee collector:', error);
                showAlert('Failed to update fee collector: ' + error.message, 'error');
            }
        }

        // Pause Auction (Owner)
        async function pauseAuction() {
            if (!contract || !isOwner) {
                showAlert('Only owner can pause auction', 'error');
                return;
            }

            try {
                if (!confirm('Pause the auction?')) {
                    return;
                }

                showAlert('Pausing auction...', 'info');
                const tx = await contract.pauseAuction();
                
                await tx.wait();
                showAlert('Auction paused', 'success');
                
                await updateOwnerPanel();

            } catch (error) {
                console.error('Error pausing auction:', error);
                showAlert('Failed to pause: ' + error.message, 'error');
            }
        }

        // Unpause Auction (Owner)
        async function unpauseAuction() {
            if (!contract || !isOwner) {
                showAlert('Only owner can unpause auction', 'error');
                return;
            }

            try {
                showAlert('Unpausing auction...', 'info');
                const tx = await contract.unpauseAuction();
                
                await tx.wait();
                showAlert('Auction unpaused', 'success');
                
                await updateOwnerPanel();

            } catch (error) {
                console.error('Error unpausing auction:', error);
                showAlert('Failed to unpause: ' + error.message, 'error');
            }
        }

        // Withdraw Fees (Owner)
        async function withdrawFees() {
            if (!contract || !isOwner) {
                showAlert('Only owner can withdraw fees', 'error');
                return;
            }

            try {
                const fees = await contract.totalCollectedFees();
                
                if (fees.eq(0)) {
                    showAlert('No fees to withdraw', 'info');
                    return;
                }

                showAlert('Withdrawing platform fees...', 'info');
                const tx = await contract.withdrawPlatformFees();
                
                await tx.wait();
                showAlert(`Fees withdrawn: ${ethers.utils.formatEther(fees)} ETH`, 'success');
                
                await updateOwnerPanel();

            } catch (error) {
                console.error('Error withdrawing fees:', error);
                showAlert('Failed to withdraw fees: ' + error.message, 'error');
            }
        }

        // Emergency End (Owner)
        async function emergencyEnd() {
            if (!contract || !isOwner) {
                showAlert('Only owner can trigger emergency end', 'error');
                return;
            }

            try {
                const reason = prompt('Enter reason for emergency end:');
                if (!reason) return;

                if (!confirm('⚠️ EMERGENCY END: This will refund all bidders and cannot be undone. Continue?')) {
                    return;
                }

                showAlert('Triggering emergency end...', 'info');
                const tx = await contract.emergencyEnd(reason, { gasLimit: 1000000 });
                
                await tx.wait();
                showAlert('Emergency end executed', 'success');
                
                await refreshAuctionInfo();

            } catch (error) {
                console.error('Error in emergency end:', error);
                showAlert('Failed to execute emergency end: ' + error.message, 'error');
            }
        }

        // Force Finalize (Owner)
        async function forceFinalize() {
            if (!contract || !isOwner) {
                showAlert('Only owner can force finalize', 'error');
                return;
            }

            try {
                if (!confirm('⚠️ FORCE FINALIZE: This should only be used if decryption is stuck. Continue?')) {
                    return;
                }

                showAlert('Force finalizing...', 'info');
                const tx = await contract.forceFinalize({ gasLimit: 500000 });
                
                await tx.wait();
                showAlert('Auction force finalized', 'success');
                
                await refreshAuctionInfo();

            } catch (error) {
                console.error('Error force finalizing:', error);
                showAlert('Failed to force finalize: ' + error.message, 'error');
            }
        }

        // Open History Modal
        async function openHistoryModal() {
            if (!contract) return;

            document.getElementById('historyModal').classList.add('active');
            document.getElementById('historyContent').innerHTML = '<div class="loading"><div class="spinner"></div>Loading history...</div>';

            try {
                const currentRound = await contract.currentRound();
                const history = await contract.getRoundHistory(currentRound - 1, 20);

                if (history.length === 0) {
                    document.getElementById('historyContent').innerHTML = '<div class="loading">No bid history available</div>';
                    return;
                }

                let html = '';
                for (const item of history) {
                    const date = new Date(item.timestamp.toNumber() * 1000);
                    html += `
                        <div class="history-item">
                            <div><strong>Bidder:</strong> ${item.bidder.slice(0, 10)}...${item.bidder.slice(-8)}</div>
                            <div><strong>Deposit:</strong> ${ethers.utils.formatEther(item.deposit)} ETH</div>
                            <div class="history-time">${date.toLocaleString()}</div>
                            ${item.withdrawn ? '<div style="color: #f5576c;">Withdrawn</div>' : ''}
                        </div>
                    `;
                }

                document.getElementById('historyContent').innerHTML = html;

            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('historyContent').innerHTML = '<div class="alert alert-error">Failed to load history</div>';
            }
        }

        // Close History Modal
        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }

        // Switch Tabs
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + 'Content').classList.add('active');
        }

        // Show Alert
        function showAlert(message, type = 'info') {
            const alertArea = document.getElementById('alertArea');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            alertArea.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 300);
            }, 5000);
        }

        // Close modal on outside click
        document.getElementById('historyModal').addEventListener('click', (e) => {
            if (e.target.id === 'historyModal') {
                closeHistoryModal();
            }
        });

        // Handle network changes
        if (window.ethereum) {
            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });

            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    disconnectWallet();
                } else {
                    window.location.reload();
                }
            });
        }
    </script>
</body>
</html>